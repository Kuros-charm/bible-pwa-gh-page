<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
  <title>bible-pwa</title>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/idb-keyval@6/dist/umd.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- <script src="src/bible.js"></script> -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* === Essential: Alpine.js cloak === */
    [x-cloak] { display: none !important; }

    /* === Theme: CSS Variables === */
    :root {
      --bg-primary: #faf8f5;
      --bg-secondary: #f0ebe3;
      --text-primary: #2c2416;
      --text-secondary: #6b5d4d;
      --accent: #8b4513;
      --accent-light: #d4a574;
      --border: #e0d5c7;
    }
    .dark {
      --bg-primary: #1a1612;
      --bg-secondary: #2a2420;
      --text-primary: #e8e0d5;
      --text-secondary: #a89a88;
      --accent: #d4a574;
      --accent-light: #8b6543;
      --border: #3d352d;
    }

    /* === Theme: Utility classes using CSS vars === */
    body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
    .bg-primary { background-color: var(--bg-primary); }
    .bg-secondary { background-color: var(--bg-secondary); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-accent { color: var(--accent); }
    .border-custom { border-color: var(--border); }

    /* === Scrollbar (no Tailwind equivalent) === */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: var(--bg-secondary); }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--accent-light); border-radius: 3px; }

    /* === Animations === */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .verse-item { opacity: 0; animation: fadeIn 0.4s ease-out forwards; }

    @keyframes verseHighlight {
      0% { box-shadow: inset 0 0 0 3px var(--accent), 0 0 20px rgba(139, 69, 19, 0.3); }
      100% { box-shadow: inset 0 0 0 0 transparent, 0 0 0 transparent; }
    }
    .verse-highlight { animation: verseHighlight 2s ease-out forwards; border-radius: 0.5rem; background-color: var(--bg-secondary) !important; opacity: 1 !important; }

    /* === Components using CSS vars (can't fully convert to Tailwind) === */
    .custom-title { color: var(--accent); font-size: 0.875rem; font-weight: 600; padding: 0.25rem 0.5rem; background: linear-gradient(90deg, var(--accent-light), transparent); border-left: 3px solid var(--accent); margin-bottom: 0.5rem; border-radius: 0 0.25rem 0.25rem 0; }
    .context-menu { position: fixed; background-color: var(--bg-primary); border: 1px solid var(--border); border-radius: 0.5rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); z-index: 100; min-width: 150px; overflow: hidden; }
    .context-menu-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.15s; display: flex; align-items: center; gap: 0.5rem; }
    .context-menu-item:hover { background-color: var(--bg-secondary); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 200; }
    .modal-content { background-color: var(--bg-primary); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; width: 90%; max-width: 400px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); }
    .verse-container { user-select: none; -webkit-user-select: none; cursor: pointer; }
    .verse-container:active { background-color: var(--bg-primary); border-radius: 0.5rem; }

    /* === Dynamic content styles (used in x-html, can't use Tailwind) === */
    .sn-code { color: var(--accent); cursor: pointer; font-size: 0.75em; vertical-align: super; opacity: 0.8; transition: opacity 0.2s, background-color 0.2s; padding: 0 2px; border-radius: 2px; }
    .sn-code:hover { opacity: 1; background-color: var(--accent-light); color: var(--bg-primary); }
    .sn-link { color: var(--accent); cursor: pointer; text-decoration: underline; text-decoration-style: dotted; transition: color 0.2s; }
    .sn-link:hover { color: var(--accent-light); text-decoration-style: solid; }
    .verse-link { color: #4a90d9; cursor: pointer; text-decoration: underline; transition: color 0.2s, background-color 0.2s; padding: 0 2px; border-radius: 2px; }
    .dark .verse-link { color: #6bb3ff; }
    .verse-link:hover { background-color: rgba(74, 144, 217, 0.15); }
  </style>
  <script type="module" crossorigin src="/bible-pwa-gh-page/assets/index-CguE1ih5.js"></script>
<link rel="manifest" href="/bible-pwa-gh-page/manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<link rel="icon" href="/bible-pwa-gh-page/favicon.ico" sizes="48x48">
<link rel="icon" href="/bible-pwa-gh-page/favicon.svg" sizes="any" type="image/svg+xml">
<link rel="apple-touch-icon" href="/bible-pwa-gh-page/apple-touch-icon-180x180.png"></head>

<body class="min-h-screen" x-data="bibleReader()">

  <div id="app">
      <!-- Header -->
  <header class="bg-secondary border-b border-custom sticky top-0 z-50">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-xl md:text-2xl">ğŸ“–</span>
        <div>
          <h1 class="text-lg md:text-xl font-bold text-accent leading-tight">è–ç¶“é–±è®€å™¨</h1>
          <button @click="versionModal.show = true"
            class="text-xs text-secondary hover:text-accent transition-colors flex items-center gap-1">
            <span x-text="currentVersion.name"></span>
            <span>â–¼</span>
          </button>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button @click="versionModal.show = true" class="p-2 rounded-full hover:bg-primary transition-colors"
          title="åˆ‡æ›è­¯æœ¬">
          <span class="text-xl">ğŸ“š</span>
        </button>
        <button @click="settingsModal.show = true" class="p-2 rounded-full hover:bg-primary transition-colors"
          title="è¨­å®š">
          <span class="text-xl">âš™ï¸</span>
        </button>
        <button @click="toggleDarkMode()" class="p-2 rounded-full hover:bg-primary transition-colors"
          :title="isDark ? 'åˆ‡æ›æ·ºè‰²æ¨¡å¼' : 'åˆ‡æ›æ·±è‰²æ¨¡å¼'">
          <span x-show="!isDark" class="text-xl">ğŸŒ™</span>
          <span x-show="isDark" class="text-xl">â˜€ï¸</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <!-- Navigation -->
    <div class="bg-secondary rounded-xl p-4 mb-6 border border-custom">
      <div class="flex flex-wrap gap-3">
        <!-- Book Selector -->
        <div class="flex-1 min-w-[150px]">
          <label class="block text-sm text-secondary mb-1">æ›¸å·</label>
          <select x-model="selectedBook" @change="onBookChange()"
            class="w-full px-3 py-2 rounded-lg bg-primary border border-custom text-primary focus:outline-none focus:ring-2 focus:ring-amber-600 text-base">
            <template x-for="(book, idx) in books" :key="'book-' + idx">
              <option :value="book" x-text="book"></option>
            </template>
          </select>
        </div>

        <!-- Chapter Selector -->
        <div class="flex-1 min-w-[120px]">
          <label class="block text-sm text-secondary mb-1">ç« </label>
          <select x-model="selectedChapter" @change="loadVerses()"
            class="w-full px-3 py-2 rounded-lg bg-primary border border-custom text-primary focus:outline-none focus:ring-2 focus:ring-amber-600 text-base">
            <template x-for="(chapter, idx) in chapters" :key="'ch-' + idx">
              <option :value="chapter" x-text="'ç¬¬ ' + chapter + ' ç« '"></option>
            </template>
          </select>
        </div>
      </div>

      <!-- Chapter Navigation -->
      <div class="flex justify-between items-center mt-4 pt-4 border-t border-custom">
        <button @click="prevChapter()" :disabled="!canGoPrev"
          :class="canGoPrev ? 'hover:bg-primary' : 'opacity-40 cursor-not-allowed'"
          class="flex items-center gap-1 px-4 py-2 rounded-lg transition-colors text-secondary">
          <span>â†</span>
          <span class="hidden sm:inline">ä¸Šä¸€ç« </span>
        </button>

        <span class="text-accent font-semibold" x-text="selectedBook + ' ' + selectedChapter + ' ç« '"></span>

        <button @click="nextChapter()" :disabled="!canGoNext"
          :class="canGoNext ? 'hover:bg-primary' : 'opacity-40 cursor-not-allowed'"
          class="flex items-center gap-1 px-4 py-2 rounded-lg transition-colors text-secondary">
          <span class="hidden sm:inline">ä¸‹ä¸€ç« </span>
          <span>â†’</span>
        </button>
      </div>
    </div>

    <!-- Search -->
    <div class="mb-6">
      <div class="relative">
        <input type="text" x-model="searchQuery" @input="search()" placeholder="æœå°‹ç¶“æ–‡..."
          class="w-full px-4 py-3 pl-10 rounded-xl bg-secondary border border-custom text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-amber-600 text-base">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-secondary">ğŸ”</span>
        <button x-show="searchQuery" @click="clearSearch()"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-secondary hover:text-primary">âœ•</button>
      </div>
    </div>

    <!-- Verses Display -->
    <div class="bg-secondary rounded-xl p-6 border border-custom min-h-[400px]">
      <!-- Search Results -->
      <template x-if="searchQuery && searchResults.length > 0">
        <div>
          <h2 class="text-lg font-semibold text-accent mb-4">
            æœå°‹çµæœ (<span x-text="searchResults.length"></span> ç­†)
          </h2>
          <div class="space-y-4 max-h-[60vh] overflow-y-auto scrollbar-thin pr-2">
            <template x-for="(verse, index) in searchResults.slice(0, 100)" :key="'search-' + index">
              <div
                class="verse-item p-4 bg-primary rounded-lg border border-custom cursor-pointer hover:border-amber-600 transition-colors"
                :style="'animation-delay: ' + (index * 30) + 'ms'" @click="goToVerse(verse)">
                <span class="text-accent font-semibold text-sm" x-text="verse.ref"></span>
                <p class="mt-1 text-primary leading-relaxed" x-text="verse.text"></p>
              </div>
            </template>
          </div>
          <p x-show="searchResults.length > 100" class="mt-4 text-secondary text-sm text-center">
            é¡¯ç¤ºå‰ 100 ç­†çµæœï¼Œå…± <span x-text="searchResults.length"></span> ç­†
          </p>
        </div>
      </template>

      <!-- No Search Results -->
      <template x-if="searchQuery && searchResults.length === 0">
        <div class="flex flex-col items-center justify-center py-16 text-secondary">
          <span class="text-4xl mb-4">ğŸ“­</span>
          <p>æ‰¾ä¸åˆ°ç¬¦åˆçš„ç¶“æ–‡</p>
        </div>
      </template>

      <!-- Chapter Verses -->
      <template x-if="!searchQuery">
        <div>
          <div :style="`display: flex; flex-direction: column; gap: ${verseSpacing}px;`">
            <template x-for="(verse, index) in currentVerses" :key="'verse-' + index">
              <div class="verse-item verse-container px-2 -mx-2 rounded-lg"
                :data-verse-num="verse.verseNum"
                :style="`animation-delay: ${index * 50}ms; font-size: ${fontSize}px; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
                @mousedown="startLongPress($event, verse)"
                @mouseup="cancelLongPress()" @mouseleave="cancelLongPress()"
                @touchstart.passive="startLongPress($event, verse)" @touchend="cancelLongPress()"
                @touchmove="cancelLongPress()" @contextmenu.prevent="showContextMenu($event, verse)">
                <!-- Custom Title -->
                <div x-show="customTitles[verse.ref]" class="custom-title" x-text="customTitles[verse.ref]"></div>
                <!-- Verse Content -->
                <div class="flex items-start gap-2">
                  <div class="flex-1">
                    <span class="text-accent font-semibold mr-2" x-text="verse.verseNum"></span>
                    <span x-html="renderVerseText(verse.text)"></span>
                  </div>
                  <!-- Note Icon -->
                  <button x-show="notes[verse.ref]" @click.stop="openNoteModal(verse)"
                    class="flex-shrink-0 p-1 rounded hover:bg-primary transition-all text-base opacity-70 hover:opacity-100 hover:scale-110" title="æŸ¥çœ‹ç­†è¨˜">
                    âœï¸
                  </button>
                </div>
              </div>
            </template>
          </div>

          <!-- Empty State -->
          <div x-show="currentVerses.length === 0 && !isLoading"
            class="flex flex-col items-center justify-center py-16 text-secondary">
            <span class="text-4xl mb-4">ğŸ“–</span>
            <p>é¸æ“‡æ›¸å·å’Œç« ç¯€é–‹å§‹é–±è®€</p>
          </div>

          <!-- Loading State -->
          <div x-show="isLoading" class="flex flex-col items-center justify-center py-16 text-secondary">
            <div class="relative mb-4">
              <span class="text-4xl animate-pulse">ğŸ“¥</span>
            </div>
            <p class="font-medium text-primary mb-2" x-text="loadingMessage"></p>
            <p x-show="loadingSubMessage" class="text-sm" x-text="loadingSubMessage"></p>
          </div>
        </div>
      </template>
    </div>

    <!-- Footer Info -->
    <div class="mt-6 text-center text-secondary text-sm">
      <p>å…± <span x-text="totalVerses"></span> ç¯€ç¶“æ–‡</p>
    </div>
  </main>

  <!-- Context Menu -->
  <div x-cloak x-show="contextMenu.show" x-transition:enter="transition ease-out duration-100"
    x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
    x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100"
    x-transition:leave-end="opacity-0 scale-95" class="context-menu"
    :style="'top: ' + contextMenu.y + 'px; left: ' + contextMenu.x + 'px;'" @click.outside="closeContextMenu()">
    <div class="context-menu-item text-primary" @click="openTitleModal()">
      <span>ğŸ·ï¸</span>
      <span>è‡ªè¨‚æ¨™é¡Œ</span>
    </div>
    <div class="context-menu-item text-primary" @click="openNoteModal()">
      <span>ğŸ“</span>
      <span>ç­†è¨˜</span>
    </div>
  </div>

  <!-- Title Input Modal -->
  <div x-cloak x-show="titleModal.show" x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0" class="modal-overlay" @click.self="closeTitleModal()">
    <div class="modal-content" x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100">
      <h3 class="text-lg font-semibold text-accent mb-2">è‡ªè¨‚æ¨™é¡Œ</h3>
      <p class="text-secondary text-sm mb-4" x-text="titleModal.verse?.ref"></p>
      <input type="text" x-model="titleModal.title" x-ref="titleInput" @keydown.enter="saveTitle()"
        @keydown.escape="closeTitleModal()" placeholder="è¼¸å…¥æ¨™é¡Œ..."
        class="w-full px-4 py-3 rounded-lg bg-secondary border border-custom text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-amber-600 text-base mb-4">
      <div class="flex justify-end gap-3">
        <button @click="closeTitleModal()"
          class="px-4 py-2 rounded-lg text-secondary hover:bg-secondary transition-colors">
          å–æ¶ˆ
        </button>
        <button @click="saveTitle()" class="px-4 py-2 rounded-lg text-white transition-colors"
          style="background-color: var(--accent);">
          å„²å­˜
        </button>
      </div>
    </div>
  </div>

  <!-- Note Input Modal -->
  <div x-cloak x-show="noteModal.show" x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0" class="modal-overlay" @click.self="closeNoteModal()">
    <div class="modal-content" x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100">
      <h3 class="text-lg font-semibold text-accent mb-2">ğŸ“ ç­†è¨˜</h3>
      <p class="text-secondary text-sm mb-4" x-text="noteModal.verse?.ref"></p>
      <textarea x-model="noteModal.note" x-ref="noteInput" @keydown.escape="closeNoteModal()" placeholder="è¼¸å…¥ç­†è¨˜..."
        rows="5"
        class="w-full px-4 py-3 rounded-lg bg-secondary border border-custom text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-amber-600 text-base mb-4 resize-none"></textarea>
      <div class="flex justify-end gap-3">
        <button @click="closeNoteModal()"
          class="px-4 py-2 rounded-lg text-secondary hover:bg-secondary transition-colors">
          å–æ¶ˆ
        </button>
        <button @click="saveNote()" class="px-4 py-2 rounded-lg text-white transition-colors"
          style="background-color: var(--accent);">
          å„²å­˜
        </button>
      </div>
    </div>
  </div>

  <!-- Strong's Number Definition Modal -->
  <div x-cloak x-show="snModal.show" x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0" class="modal-overlay" @click.self="snModal.show = false">
    <div class="modal-content max-w-lg" x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold text-accent flex items-center gap-2">
          <span>ğŸ“–</span>
          <span x-text="snModal.code"></span>
        </h3>
        <button @click="snModal.show = false" class="p-1 hover:bg-secondary rounded-full transition-colors">
          <span class="text-xl text-secondary">âœ•</span>
        </button>
      </div>
      <div class="max-h-[60vh] overflow-y-auto">
        <div x-show="snModal.loading" class="flex items-center justify-center py-8">
          <span class="animate-pulse text-2xl">â³</span>
        </div>
        <div x-show="!snModal.loading && snModal.definition" class="whitespace-pre-wrap leading-relaxed text-primary" x-html="snModal.definition"></div>
        <div x-show="!snModal.loading && !snModal.definition" class="text-secondary text-center py-8">
          <span class="text-2xl block mb-2">â“</span>
          <p>æ‰¾ä¸åˆ°å®šç¾©</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Reading Adjustment Overlay -->
  <div x-cloak x-show="readingOverlay.show"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 translate-y-4"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-4"
    class="fixed bottom-20 left-1/2 -translate-x-1/2 z-[150] pointer-events-none w-[90%] max-w-[320px]">
    <div class="pointer-events-auto bg-black/85 backdrop-blur-md text-white rounded-2xl shadow-2xl overflow-hidden"
      @click="resetOverlayTimeout()">

      <!-- Tab Selector -->
      <div class="flex border-b border-white/10">
        <button @click="switchOverlayTab(0)"
          :class="readingOverlay.activeTab === 0 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-xs font-medium transition-colors">
          <span class="block text-base mb-0.5">A</span>å­—è™Ÿ
        </button>
        <button @click="switchOverlayTab(1)"
          :class="readingOverlay.activeTab === 1 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-xs font-medium transition-colors">
          <span class="block text-base mb-0.5">â‰¡</span>è¡Œè·
        </button>
        <button @click="switchOverlayTab(2)"
          :class="readingOverlay.activeTab === 2 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-xs font-medium transition-colors">
          <span class="block text-base mb-0.5">Â¶</span>æ®µè·
        </button>
        <button @click="switchOverlayTab(3)"
          :class="readingOverlay.activeTab === 3 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-xs font-medium transition-colors">
          <span class="block text-base mb-0.5">å­—</span>å­—å‹
        </button>
      </div>

      <!-- Control Area -->
      <div class="px-5 py-4">
        <!-- Font Size Control -->
        <div x-show="readingOverlay.activeTab === 0" class="flex items-center gap-4">
          <button @click="adjustFontSize(-2)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-sm font-medium">A</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="fontSize + 'px'"></div>
          </div>
          <button @click="adjustFontSize(2)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-xl font-medium">A</span>
          </button>
        </div>

        <!-- Line Height Control -->
        <div x-show="readingOverlay.activeTab === 1" class="flex items-center gap-4">
          <button @click="adjustLineHeight(-0.2)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg leading-none">â‰¡</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="lineHeight.toFixed(1)"></div>
          </div>
          <button @click="adjustLineHeight(0.2)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95"
            style="letter-spacing: 3px;">
            <span class="text-lg leading-none">â‰¡</span>
          </button>
        </div>

        <!-- Verse Spacing Control -->
        <div x-show="readingOverlay.activeTab === 2" class="flex items-center gap-4">
          <button @click="adjustVerseSpacing(-4)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">âˆ’</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="verseSpacing + 'px'"></div>
          </div>
          <button @click="adjustVerseSpacing(4)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">+</span>
          </button>
        </div>

        <!-- Font Family Control -->
        <div x-show="readingOverlay.activeTab === 3" class="flex items-center gap-4">
          <button @click="adjustFontFamily(-1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">â—€</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-xl font-bold" x-text="currentFontFamilyName" :style="`font-family: ${currentFontFamily}`"></div>
          </div>
          <button @click="adjustFontFamily(1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">â–¶</span>
          </button>
        </div>

        <!-- Progress bar (hidden for font family tab) -->
        <div x-show="readingOverlay.activeTab !== 3" class="mt-4 h-1.5 bg-white/15 rounded-full overflow-hidden">
          <div class="h-full bg-white/70 rounded-full transition-all duration-200"
            :style="readingOverlay.activeTab === 0
              ? `width: ${((fontSize - 12) / 20) * 100}%`
              : readingOverlay.activeTab === 1
                ? `width: ${((lineHeight - 1.2) / 1.8) * 100}%`
                : `width: ${(verseSpacing / 48) * 100}%`">
          </div>
        </div>
        <!-- Font family indicator dots -->
        <div x-show="readingOverlay.activeTab === 3" class="mt-4 flex justify-center gap-2">
          <template x-for="(font, idx) in fontFamilies" :key="idx">
            <div class="w-2 h-2 rounded-full transition-colors"
              :class="fontFamily === idx ? 'bg-white' : 'bg-white/30'"></div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div x-cloak x-show="settingsModal.show" x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0" class="modal-overlay" @click.self="settingsModal.show = false">
    <div class="modal-content max-w-md max-h-[85vh] overflow-y-auto" x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100">
      <h3 class="text-lg font-semibold text-accent mb-4">âš™ï¸ è¨­å®š</h3>

      <!-- Reading Preferences -->
      <div class="space-y-3 mb-6">
        <h4 class="font-medium text-primary">ğŸ“– é–±è®€è¨­å®š</h4>

        <button @click="showReadingOverlay()"
          class="w-full flex items-center justify-between p-3 rounded-lg bg-primary border border-custom hover:border-amber-600 transition-colors">
          <div class="flex items-center gap-3">
            <span class="text-lg">ğŸ“</span>
            <span class="text-primary">èª¿æ•´é¡¯ç¤º</span>
          </div>
          <div class="text-secondary text-xs">
            <span x-text="currentFontFamilyName"></span>
          </div>
        </button>
      </div>

      <!-- File System Access Status -->
      <div class="mb-4 p-3 rounded-lg bg-primary border border-custom">
        <div class="flex items-center gap-2 mb-1">
          <span x-text="hasFileSystemAccess ? 'âœ…' : 'âš ï¸'"></span>
          <span class="font-medium text-primary" x-text="hasFileSystemAccess ? 'æ”¯æ´æª”æ¡ˆç³»çµ± API' : 'ä¸æ”¯æ´æª”æ¡ˆç³»çµ± API'"></span>
        </div>
        <p class="text-sm text-secondary" x-text="hasFileSystemAccess ? 'å¯è‡ªå‹•ï¿½ï¿½ï¿½æ­¥è‡³æœ¬æ©Ÿæª”æ¡ˆ' : 'å°‡ä½¿ç”¨ä¸‹è¼‰/ä¸Šå‚³æ–¹å¼å‚™ä»½'"></p>
      </div>

      <!-- Data Sync Section -->
      <div class="space-y-3 mb-6">
        <h4 class="font-medium text-primary">ğŸ“‚ è³‡æ–™å‚™ä»½</h4>

        <!-- File Handle Status -->
        <div x-show="fileHandle" class="p-3 rounded-lg bg-primary border border-custom">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-secondary">å·²é€£çµæª”æ¡ˆï¼š</p>
              <p class="font-medium text-primary" x-text="fileHandle?.name || 'æœªçŸ¥'"></p>
              <p class="text-xs text-secondary mt-1">ğŸ’¡ é‡æ–°é–‹å•Ÿ app å¾Œéœ€é‡æ–°æˆæ¬Š</p>
            </div>
            <button @click="unlinkFile()" class="text-sm text-red-500 hover:text-red-600">è§£é™¤é€£çµ</button>
          </div>
        </div>

        <!-- Export Button -->
        <button @click="exportData()" :disabled="settingsModal.isBusy"
          class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
          <span>ğŸ’¾</span>
          <span x-text="hasFileSystemAccess ? (fileHandle ? 'å„²å­˜è‡³æª”æ¡ˆ' : 'é¸æ“‡æª”æ¡ˆä¸¦å„²å­˜') : 'ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ'"></span>
        </button>

        <!-- Import Button -->
        <button @click="importData()" :disabled="settingsModal.isBusy"
          class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
          <span>ğŸ“‚</span>
          <span x-text="hasFileSystemAccess ? 'å¾æª”æ¡ˆè¼‰å…¥' : 'ä¸Šå‚³å‚™ä»½æª”æ¡ˆ'"></span>
        </button>

        <!-- Auto-sync toggle (only for File System Access) -->
        <div x-show="hasFileSystemAccess && fileHandle" class="flex items-center justify-between p-3 rounded-lg bg-primary border border-custom">
          <div>
            <p class="font-medium text-primary">è‡ªå‹•åŒæ­¥</p>
            <p class="text-sm text-secondary">è®Šæ›´æ™‚è‡ªå‹•å„²å­˜è‡³æª”æ¡ˆ</p>
          </div>
          <button @click="autoSync = !autoSync; saveAutoSyncPreference()"
            :class="autoSync ? 'bg-green-500' : 'bg-gray-400'"
            class="relative w-12 h-6 rounded-full transition-colors">
            <span :class="autoSync ? 'translate-x-6' : 'translate-x-1'"
              class="absolute top-1 left-0 w-4 h-4 bg-white rounded-full transition-transform shadow"></span>
          </button>
        </div>
      </div>

      <!-- Status Message -->
      <div x-show="settingsModal.message" class="mb-4 p-3 rounded-lg"
        :class="settingsModal.isError ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'">
        <p class="text-sm" x-text="settingsModal.message"></p>
      </div>

      <!-- Cache Section -->
      <div class="space-y-3 mb-6">
        <h4 class="font-medium text-primary">ğŸ—„ï¸ å¿«å–ç®¡ç†</h4>
        <div class="p-3 rounded-lg bg-primary border border-custom">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-secondary">å·²ä¸‹è¼‰è­¯æœ¬</p>
              <p class="font-medium text-primary" x-text="cachedVersions.length + ' å€‹è­¯æœ¬'"></p>
            </div>
            <button @click="versionModal.show = true; settingsModal.show = false"
              class="text-sm text-accent hover:underline">ç®¡ç†</button>
          </div>
        </div>
        <button @click="clearAllVersions()" x-show="cachedVersions.length > 1"
          class="w-full text-sm text-red-500 hover:text-red-600 p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors">
          æ¸…é™¤æ‰€æœ‰å¿«å–ï¼ˆä¿ç•™ç›®å‰ä½¿ç”¨ä¸­çš„è­¯æœ¬ï¼‰
        </button>
      </div>

      <!-- Close Button -->
      <div class="flex justify-end">
        <button @click="settingsModal.show = false"
          class="px-4 py-2 rounded-lg text-white transition-colors"
          style="background-color: var(--accent);">
          é—œé–‰
        </button>
      </div>
    </div>
  </div>

  <!-- Version Selector Modal -->
  <div x-cloak x-show="versionModal.show" x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0" class="modal-overlay" @click.self="versionModal.show = false">
    <div class="modal-content max-w-lg max-h-[80vh] overflow-hidden flex flex-col" x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-accent">ğŸ“š é¸æ“‡è­¯æœ¬</h3>
        <button @click="versionModal.show = false" class="p-1 hover:bg-secondary rounded-full transition-colors">
          <span class="text-xl text-secondary">âœ•</span>
        </button>
      </div>

      <div class="overflow-y-auto flex-1 -mx-2 px-2 scrollbar-thin">
        <!-- Group by language -->
        <template x-for="lang in ['ç¹é«”ä¸­æ–‡', 'English', 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬', '×¢×‘×¨×™×ª']" :key="lang">
          <div x-show="availableVersions.filter(v => v.lang === lang).length > 0" class="mb-4">
            <h4 class="text-sm font-semibold text-secondary mb-2" x-text="lang"></h4>
            <div class="space-y-2">
              <template x-for="version in availableVersions.filter(v => v.lang === lang)" :key="version.id">
                <div class="p-3 rounded-lg border border-custom transition-colors"
                  :class="selectedVersionId === version.id ? 'bg-primary border-amber-600' : 'hover:bg-primary'">
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-primary" x-text="version.name"></span>
                        <span x-show="selectedVersionId === version.id" class="text-xs px-1.5 py-0.5 rounded bg-amber-600 text-white">ä½¿ç”¨ä¸­</span>
                        <span x-show="isVersionCached(version.id) && selectedVersionId !== version.id" class="text-xs px-1.5 py-0.5 rounded bg-green-600 text-white">å·²ä¸‹è¼‰</span>
                      </div>
                      <p class="text-xs text-secondary mt-0.5" x-text="version.size"></p>
                    </div>
                    <div class="flex items-center gap-2">
                      <!-- Delete button for cached versions (not currently selected) -->
                      <button x-show="isVersionCached(version.id) && selectedVersionId !== version.id"
                        @click="deleteVersion(version.id)"
                        class="p-1.5 rounded-lg text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors"
                        title="åˆªé™¤å¿«å–">
                        <span class="text-sm">ğŸ—‘ï¸</span>
                      </button>
                      <!-- Select/Download button -->
                      <button @click="selectVersion(version.id)"
                        :disabled="versionModal.downloading === version.id"
                        class="px-3 py-1.5 rounded-lg text-sm transition-colors disabled:opacity-50"
                        :class="selectedVersionId === version.id ? 'bg-secondary text-secondary cursor-default' : 'text-white'"
                        :style="selectedVersionId !== version.id ? 'background-color: var(--accent);' : ''">
                        <span x-show="versionModal.downloading === version.id" class="flex items-center gap-1">
                          <span class="animate-spin">â³</span> ä¸‹è¼‰ä¸­...
                        </span>
                        <span x-show="versionModal.downloading !== version.id">
                          <span x-text="selectedVersionId === version.id ? 'ä½¿ç”¨ä¸­' : (isVersionCached(version.id) ? 'åˆ‡æ›' : 'ä¸‹è¼‰')"></span>
                        </span>
                      </button>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>

      <div class="mt-4 pt-4 border-t border-custom">
        <p class="text-xs text-secondary text-center">å·²å¿«å– <span x-text="cachedVersions.length"></span> å€‹è­¯æœ¬</p>
      </div>
    </div>
  </div>


    <div id="pwa-toast" role="alert" aria-labelledby="toast-message"
      class="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-secondary border border-custom rounded-xl p-4 shadow-lg z-[300] hidden">
      <div class="flex items-start gap-3">
        <span class="text-2xl">ğŸ”„</span>
        <div class="flex-1">
          <p id="toast-message" class="text-primary font-medium"></p>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="pwa-close" type="button"
          class="px-4 py-2 rounded-lg text-secondary hover:bg-primary transition-colors text-sm">
          Close
        </button>
        <button id="pwa-refresh" type="button"
          class="px-4 py-2 rounded-lg text-white transition-colors text-sm"
          style="background-color: var(--accent);">
          Reload
        </button>
      </div>
    </div>


  </div>



  <script>
    // Book code to name mapping
    const BOOK_NAMES = {
      // Old Testament
      'GEN': 'å‰µä¸–è¨˜', 'EXO': 'å‡ºåŸƒåŠè¨˜', 'LEV': 'åˆ©æœªè¨˜', 'NUM': 'æ°‘æ•¸è¨˜', 'DEU': 'ç”³å‘½è¨˜',
      'JOS': 'ç´„æ›¸äºè¨˜', 'JDG': 'å£«å¸«è¨˜', 'RUT': 'è·¯å¾—è¨˜', '1SA': 'æ’’æ¯è€³è¨˜ä¸Š', '2SA': 'æ’’æ¯è€³è¨˜ä¸‹',
      '1KI': 'åˆ—ç‹ç´€ä¸Š', '2KI': 'åˆ—ç‹ç´€ä¸‹', '1CH': 'æ­·ä»£å¿—ä¸Š', '2CH': 'æ­·ä»£å¿—ä¸‹',
      'EZR': 'ä»¥æ–¯æ‹‰è¨˜', 'NEH': 'å°¼å¸Œç±³è¨˜', 'EST': 'ä»¥æ–¯å¸–è¨˜', 'JOB': 'ç´„ä¼¯è¨˜', 'PSA': 'è©©ç¯‡',
      'PRO': 'ç®´è¨€', 'ECC': 'å‚³é“æ›¸', 'SNG': 'é›…æ­Œ', 'ISA': 'ä»¥è³½äºæ›¸', 'JER': 'è€¶åˆ©ç±³æ›¸',
      'LAM': 'è€¶åˆ©ç±³å“€æ­Œ', 'EZK': 'ä»¥è¥¿çµæ›¸', 'DAN': 'ä½†ä»¥ç†æ›¸', 'HOS': 'ä½•è¥¿é˜¿æ›¸',
      'JOL': 'ç´„ç¥æ›¸', 'AMO': 'é˜¿æ‘©å¸æ›¸', 'OBA': 'ä¿„å·´åº•äºæ›¸', 'JON': 'ç´„æ‹¿æ›¸', 'MIC': 'å½Œè¿¦æ›¸',
      'NAM': 'é‚£é´»æ›¸', 'HAB': 'å“ˆå·´è°·æ›¸', 'ZEP': 'è¥¿ç•ªé›…æ›¸', 'HAG': 'å“ˆè©²æ›¸', 'ZEC': 'æ’’è¿¦åˆ©äºæ›¸', 'MAL': 'ç‘ªæ‹‰åŸºæ›¸',
      // New Testament
      'MAT': 'é¦¬å¤ªç¦éŸ³', 'MRK': 'é¦¬å¯ç¦éŸ³', 'LUK': 'è·¯åŠ ç¦éŸ³', 'JHN': 'ç´„ç¿°ç¦éŸ³', 'ACT': 'ä½¿å¾’è¡Œå‚³',
      'ROM': 'ç¾…é¦¬æ›¸', '1CO': 'å“¥æ—å¤šå‰æ›¸', '2CO': 'å“¥æ—å¤šå¾Œæ›¸', 'GAL': 'åŠ æ‹‰å¤ªæ›¸', 'EPH': 'ä»¥å¼—æ‰€æ›¸',
      'PHP': 'è…“ç«‹æ¯”æ›¸', 'COL': 'æ­Œç¾…è¥¿æ›¸', '1TH': 'å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸', '2TH': 'å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸',
      '1TI': 'ææ‘©å¤ªå‰æ›¸', '2TI': 'ææ‘©å¤ªå¾Œæ›¸', 'TIT': 'æå¤šæ›¸', 'PHM': 'è…“åˆ©é–€æ›¸', 'HEB': 'å¸Œä¼¯ä¾†æ›¸',
      'JAS': 'é›…å„æ›¸', '1PE': 'å½¼å¾—å‰æ›¸', '2PE': 'å½¼å¾—å¾Œæ›¸', '1JN': 'ç´„ç¿°ä¸€æ›¸', '2JN': 'ç´„ç¿°äºŒæ›¸',
      '3JN': 'ç´„ç¿°ä¸‰æ›¸', 'JUD': 'çŒ¶å¤§æ›¸', 'REV': 'å•Ÿç¤ºéŒ„',
      // Alternate codes
      'SON': 'é›…æ­Œ', 'SOL': 'é›…æ­Œ', 'SOS': 'é›…æ­Œ', 'JOE': 'ç´„ç¥æ›¸', 'NAH': 'é‚£é´»æ›¸',
      'ZPH': 'è¥¿ç•ªé›…æ›¸', 'MK': 'é¦¬å¯ç¦éŸ³', 'JN': 'ç´„ç¿°ç¦éŸ³', 'PHI': 'è…“ç«‹æ¯”æ›¸',
      '1THS': 'å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸', '2THS': 'å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸', '1TIM': 'ææ‘©å¤ªå‰æ›¸', '2TIM': 'ææ‘©å¤ªå¾Œæ›¸',
      'PHILE': 'è…“åˆ©é–€æ›¸', '1PET': 'å½¼å¾—å‰æ›¸', '2PET': 'å½¼å¾—å¾Œæ›¸'
    };

    // Available Bible versions
    const BIBLE_VERSIONS = [
      { id: 'zh-rTW_CUV', file: 'zh-rTW_CUV.txt', name: 'å’Œåˆæœ¬', lang: 'ç¹é«”ä¸­æ–‡', size: '3.6 MB' },
      { id: 'zh-rTW_CUV-SN', file: 'zh-rTW_CUV-SN.txt', name: 'å’Œåˆæœ¬ (å«åŸæ–‡ç·¨è™Ÿ)', lang: 'ç¹é«”ä¸­æ–‡', size: '6.7 MB' },
      { id: 'zh-rTW_CNV', file: 'zh-rTW_CNV.txt', name: 'æ–°è­¯æœ¬', lang: 'ç¹é«”ä¸­æ–‡', size: '3.9 MB' },
      { id: 'zh-rTW_LCC', file: 'zh-rTW_LCC.txt', name: 'å‘‚æŒ¯ä¸­è­¯æœ¬', lang: 'ç¹é«”ä¸­æ–‡', size: '4.0 MB' },
      { id: 'en_KJV-SN', file: 'en_KJV-SN.txt', name: 'King James (Strong\'s)', lang: 'English', size: '7.4 MB' },
      { id: 'en_ASV', file: 'en_ASV.txt', name: 'American Standard', lang: 'English', size: '4.4 MB' },
      { id: 'en_WEB', file: 'en_WEB.txt', name: 'World English Bible', lang: 'English', size: '4.3 MB' },
      { id: 'en_BBE', file: 'en_BBE.txt', name: 'Bible in Basic English', lang: 'English', size: '4.4 MB' },
      { id: 'en_YLT', file: 'en_YLT.txt', name: 'Young\'s Literal', lang: 'English', size: '4.4 MB' },
      { id: 'el_Septuaginta', file: 'el_Septuaginta.txt', name: 'Septuaginta', lang: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬', size: '5.4 MB' },
      { id: 'iw_ModernHebrew', file: 'iw_ModernHebrew.txt', name: 'Modern Hebrew', lang: '×¢×‘×¨×™×ª', size: '4.0 MB' }
    ];

    function bibleReader() {
      return {
        isDark: false,
        allVerses: [],
        books: [],
        chapters: [],
        selectedBook: '',
        selectedChapter: 1,
        currentVerses: [],
        searchQuery: '',
        searchResults: [],
        totalVerses: 0,
        bibleData: {},
        customTitles: {},
        notes: {},
        longPressTimer: null,
        longPressDuration: 500,
        isLoading: false,
        loadingMessage: '',
        loadingSubMessage: '',
        // Version management
        availableVersions: BIBLE_VERSIONS,
        selectedVersionId: 'zh-rTW_CUV',
        cachedVersions: [],
        versionModal: {
          show: false,
          downloading: null
        },
        contextMenu: {
          show: false,
          x: 0,
          y: 0,
          verse: null
        },
        titleModal: {
          show: false,
          verse: null,
          title: ''
        },
        noteModal: {
          show: false,
          verse: null,
          note: ''
        },
        settingsModal: {
          show: false,
          isBusy: false,
          message: '',
          isError: false
        },
        snModal: {
          show: false,
          code: '',
          definition: '',
          loading: false
        },
        snDictionary: {},  // Cache for Strong's Number dictionary
        snDictLoading: false,
        hasFileSystemAccess: false,
        fileHandle: null,
        autoSync: false,
        // Reading preferences
        fontSize: 18,      // in pixels
        lineHeight: 1.8,   // multiplier
        verseSpacing: 16,  // in pixels (gap between verses)
        fontFamily: 0,     // index into fontFamilies array
        fontFamilies: [
          { name: 'ç³»çµ±å­—å‹', value: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' },
          { name: 'æ€æºå®‹é«”', value: '"Noto Serif TC", serif' },
          { name: 'é»‘é«”', value: '"Noto Sans TC", "Microsoft JhengHei", sans-serif' },
          { name: 'æ¥·é«”', value: '"TW-Kai", "DFKai-SB", "KaiTi", serif' }
        ],
        // Reading overlay control
        readingOverlay: {
          show: false,
          activeTab: 0,  // 0: fontSize, 1: lineHeight, 2: verseSpacing, 3: fontFamily
          hideTimeout: null
        },

        async init() {
          // Check File System Access API support
          this.hasFileSystemAccess = 'showSaveFilePicker' in window;
          // Check dark mode preference
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            this.isDark = true;
            document.documentElement.classList.add('dark');
          }
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            this.isDark = event.matches;
            document.documentElement.classList.toggle('dark', event.matches);
          });

          // Load saved data from IndexedDB
          await this.loadFromStorage();

          await this.parseVerses();
        },

        // IndexedDB helpers using idb-keyval
        async loadFromStorage() {
          try {
            const [savedTitles, savedNotes, savedBook, savedChapter, savedAutoSync, savedFileHandle, savedVersionId, savedCachedVersions, savedFontSize, savedLineHeight, savedVerseSpacing, savedFontFamily] = await Promise.all([
              idbKeyval.get('bible_customTitles'),
              idbKeyval.get('bible_notes'),
              idbKeyval.get('bible_selectedBook'),
              idbKeyval.get('bible_selectedChapter'),
              idbKeyval.get('bible_autoSync'),
              idbKeyval.get('bible_fileHandle'),
              idbKeyval.get('bible_selectedVersion'),
              idbKeyval.get('bible_cachedVersions'),
              idbKeyval.get('bible_fontSize'),
              idbKeyval.get('bible_lineHeight'),
              idbKeyval.get('bible_verseSpacing'),
              idbKeyval.get('bible_fontFamily')
            ]);

            if (savedTitles) {
              this.customTitles = savedTitles;
            }
            if (savedNotes) {
              this.notes = savedNotes;
            }
            if (savedBook) {
              this._pendingBook = savedBook;
            }
            if (savedChapter) {
              this._pendingChapter = savedChapter;
            }
            if (savedAutoSync !== undefined) {
              this.autoSync = savedAutoSync;
            }
            if (savedVersionId && this.availableVersions.some(v => v.id === savedVersionId)) {
              this.selectedVersionId = savedVersionId;
            }
            if (savedCachedVersions && Array.isArray(savedCachedVersions)) {
              this.cachedVersions = savedCachedVersions;
            }

            // Restore file handle if available (permissions will need to be re-requested)
            if (savedFileHandle && this.hasFileSystemAccess) {
              this.fileHandle = savedFileHandle;
              // Note: Permission will be checked/requested when user tries to use it
            }

            // Restore reading preferences
            if (savedFontSize && savedFontSize >= 12 && savedFontSize <= 32) {
              this.fontSize = savedFontSize;
            }
            if (savedLineHeight && savedLineHeight >= 1.2 && savedLineHeight <= 3) {
              this.lineHeight = savedLineHeight;
            }
            if (savedVerseSpacing && savedVerseSpacing >= 0 && savedVerseSpacing <= 48) {
              this.verseSpacing = savedVerseSpacing;
            }
            if (savedFontFamily !== undefined && savedFontFamily >= 0 && savedFontFamily < this.fontFamilies.length) {
              this.fontFamily = savedFontFamily;
            }
          } catch (e) {
            console.warn('Failed to load from IndexedDB:', e);
          }
        },

        // Save file handle to IndexedDB
        async saveFileHandle() {
          try {
            if (this.fileHandle) {
              await idbKeyval.set('bible_fileHandle', this.fileHandle);
            } else {
              await idbKeyval.del('bible_fileHandle');
            }
          } catch (e) {
            console.warn('Failed to save file handle:', e);
          }
        },

        // Verify and request permission for file handle
        async verifyPermission(readWrite = true) {
          if (!this.fileHandle) return false;

          const options = readWrite ? { mode: 'readwrite' } : {};

          // Check if permission was already granted
          if ((await this.fileHandle.queryPermission(options)) === 'granted') {
            return true;
          }

          // Request permission if not granted
          if ((await this.fileHandle.requestPermission(options)) === 'granted') {
            return true;
          }

          return false;
        },

        async saveCustomTitles() {
          try {
            // Clone to plain object to avoid DataCloneError with Alpine proxies
            await idbKeyval.set('bible_customTitles', JSON.parse(JSON.stringify(this.customTitles)));
            await this.triggerAutoSync();
          } catch (e) {
            console.warn('Failed to save custom titles:', e);
          }
        },

        async saveNotes() {
          try {
            // Clone to plain object to avoid DataCloneError with Alpine proxies
            await idbKeyval.set('bible_notes', JSON.parse(JSON.stringify(this.notes)));
            await this.triggerAutoSync();
          } catch (e) {
            console.warn('Failed to save notes:', e);
          }
        },

        async saveReadingPosition() {
          try {
            await Promise.all([
              idbKeyval.set('bible_selectedBook', this.selectedBook),
              idbKeyval.set('bible_selectedChapter', this.selectedChapter)
            ]);
          } catch (e) {
            console.warn('Failed to save reading position:', e);
          }
        },

        async saveReadingPreferences() {
          try {
            await Promise.all([
              idbKeyval.set('bible_fontSize', this.fontSize),
              idbKeyval.set('bible_lineHeight', this.lineHeight),
              idbKeyval.set('bible_verseSpacing', this.verseSpacing),
              idbKeyval.set('bible_fontFamily', this.fontFamily)
            ]);
          } catch (e) {
            console.warn('Failed to save reading preferences:', e);
          }
        },

        // Show reading overlay control
        showReadingOverlay() {
          this.readingOverlay.show = true;
          this.settingsModal.show = false;
          this.resetOverlayTimeout();
        },

        resetOverlayTimeout() {
          if (this.readingOverlay.hideTimeout) {
            clearTimeout(this.readingOverlay.hideTimeout);
          }
          this.readingOverlay.hideTimeout = setTimeout(() => {
            this.readingOverlay.show = false;
          }, 3000);
        },

        hideReadingOverlay() {
          if (this.readingOverlay.hideTimeout) {
            clearTimeout(this.readingOverlay.hideTimeout);
          }
          this.readingOverlay.show = false;
        },

        switchOverlayTab(tab) {
          this.readingOverlay.activeTab = tab;
          this.resetOverlayTimeout();
        },

        adjustFontSize(delta) {
          this.fontSize = Math.max(12, Math.min(32, parseInt(this.fontSize) + delta));
          this.saveReadingPreferences();
          this.resetOverlayTimeout();
        },

        adjustLineHeight(delta) {
          this.lineHeight = Math.max(1.2, Math.min(3, Math.round((parseFloat(this.lineHeight) + delta) * 10) / 10));
          this.saveReadingPreferences();
          this.resetOverlayTimeout();
        },

        adjustVerseSpacing(delta) {
          this.verseSpacing = Math.max(0, Math.min(48, parseInt(this.verseSpacing) + delta));
          this.saveReadingPreferences();
          this.resetOverlayTimeout();
        },

        adjustFontFamily(delta) {
          const len = this.fontFamilies.length;
          this.fontFamily = ((this.fontFamily + delta) % len + len) % len;
          this.saveReadingPreferences();
          this.resetOverlayTimeout();
        },

        get currentFontFamily() {
          return this.fontFamilies[this.fontFamily]?.value || this.fontFamilies[0].value;
        },

        get currentFontFamilyName() {
          return this.fontFamilies[this.fontFamily]?.name || this.fontFamilies[0].name;
        },

        // Get current selected version info
        get currentVersion() {
          return this.availableVersions.find(v => v.id === this.selectedVersionId) || this.availableVersions[0];
        },

        // Check if a version is cached
        isVersionCached(versionId) {
          return this.cachedVersions.includes(versionId);
        },

        // Save selected version preference
        async saveSelectedVersion() {
          try {
            await idbKeyval.set('bible_selectedVersion', this.selectedVersionId);
          } catch (e) {
            console.warn('Failed to save selected version:', e);
          }
        },

        // Save cached versions list
        async saveCachedVersions() {
          try {
            await idbKeyval.set('bible_cachedVersions', JSON.parse(JSON.stringify(this.cachedVersions)));
          } catch (e) {
            console.warn('Failed to save cached versions list:', e);
          }
        },

        // Download and cache a Bible version
        async downloadVersion(version) {
          this.versionModal.downloading = version.id;

          try {
            const response = await fetch(`./txt/${version.file}`);
            if (!response.ok) {
              throw new Error(`Failed to download: ${response.status}`);
            }
            const text = await response.text();

            // Cache in IndexedDB
            await idbKeyval.set(`bible_version_${version.id}`, text);

            // Update cached versions list
            if (!this.cachedVersions.includes(version.id)) {
              this.cachedVersions.push(version.id);
              await this.saveCachedVersions();
            }

            this.versionModal.downloading = null;
            return true;
          } catch (error) {
            console.error('Download failed:', error);
            this.versionModal.downloading = null;
            return false;
          }
        },

        // Delete cached version
        async deleteVersion(versionId) {
          try {
            await idbKeyval.del(`bible_version_${versionId}`);
            this.cachedVersions = this.cachedVersions.filter(id => id !== versionId);
            await this.saveCachedVersions();
          } catch (e) {
            console.warn('Failed to delete version:', e);
          }
        },

        // Select and load a version
        async selectVersion(versionId) {
          const version = this.availableVersions.find(v => v.id === versionId);
          if (!version) return;

          // Download if not cached
          if (!this.isVersionCached(versionId)) {
            const success = await this.downloadVersion(version);
            if (!success) return;
          }

          this.selectedVersionId = versionId;
          await this.saveSelectedVersion();
          this.versionModal.show = false;

          // Clear SN dictionary when switching versions
          this.snDictionary = {};

          // Reload verses
          await this.parseVerses();
        },

        async parseVerses() {
          let rawText;
          const version = this.currentVersion;

          // Reset data
          this.allVerses = [];
          this.books = [];
          this.bibleData = {};

          // Try to load from IndexedDB cache first
          try {
            const cachedData = await idbKeyval.get(`bible_version_${this.selectedVersionId}`);
            if (cachedData) {
              this.isLoading = true;
              this.loadingMessage = 'æ­£åœ¨è¼‰å…¥ç¶“æ–‡...';
              this.loadingSubMessage = `${version.name} - å¾å¿«å–è®€å–`;
              rawText = cachedData;
              // Small delay to show loading state
              await new Promise(resolve => setTimeout(resolve, 100));
            }
          } catch (e) {
            console.warn('Failed to read from cache:', e);
          }

          // If not cached, fetch from network
          if (!rawText) {
            this.isLoading = true;
            this.loadingMessage = 'æ­£åœ¨ä¸‹è¼‰ç¶“æ–‡è³‡æ–™...';
            this.loadingSubMessage = `${version.name} (${version.size})`;

            try {
              const response = await fetch(`./txt/${version.file}`);
              if (!response.ok) {
                throw new Error(`Failed to load ${version.file}: ${response.status}`);
              }
              rawText = await response.text();

              // Cache the data in IndexedDB
              this.loadingMessage = 'æ­£åœ¨å„²å­˜å¿«å–...';
              this.loadingSubMessage = 'ä¸‹æ¬¡è¼‰å…¥å°‡æ›´å¿«';
              try {
                await idbKeyval.set(`bible_version_${this.selectedVersionId}`, rawText);
                if (!this.cachedVersions.includes(this.selectedVersionId)) {
                  this.cachedVersions.push(this.selectedVersionId);
                  await this.saveCachedVersions();
                }
                console.log('Bible data cached successfully');
              } catch (cacheError) {
                console.warn('Failed to cache Bible data:', cacheError);
              }
            } catch (error) {
              console.error('Failed to load Bible data:', error);
              this.isLoading = false;
              this.loadingMessage = '';
              this.loadingSubMessage = '';
              return;
            }
          }

          // Parse the new format
          const lines = rawText.split('\n');
          const bookOrder = []; // Maintain book order
          const bookSet = new Set();
          const seenRefs = new Set();

          for (const line of lines) {
            // Skip header line and empty lines
            if (line.startsWith('@') || !line.trim()) continue;

            // Parse format: BOOK_CODE|chapter|verse|text
            const parts = line.split('|');
            if (parts.length >= 4) {
              const [bookCode, chapter, verse, ...textParts] = parts;
              const text = textParts.join('|'); // In case text contains |
              const chapterNum = parseInt(chapter);
              const verseNum = parseInt(verse);

              if (isNaN(chapterNum) || isNaN(verseNum)) continue;

              // Get book name from mapping or use code
              const book = BOOK_NAMES[bookCode] || bookCode;
              const ref = `${book}${chapterNum}:${verseNum}`;

              // Skip duplicates
              if (seenRefs.has(ref)) continue;
              seenRefs.add(ref);

              // Track book order
              if (!bookSet.has(book)) {
                bookSet.add(book);
                bookOrder.push(book);
              }

              if (!this.bibleData[book]) {
                this.bibleData[book] = {};
              }
              if (!this.bibleData[book][chapterNum]) {
                this.bibleData[book][chapterNum] = [];
              }

              const verseData = {
                ref,
                book,
                chapter: chapterNum,
                verseNum,
                text
              };

              this.bibleData[book][chapterNum].push(verseData);
              this.allVerses.push(verseData);
            }
          }

          this.totalVerses = this.allVerses.length;
          this.books = bookOrder;

          // Clear loading state
          this.isLoading = false;
          this.loadingMessage = '';
          this.loadingSubMessage = '';

          if (this.books.length > 0) {
            // Set initial book (first book as default)
            this.selectedBook = this.books[0];
            this.updateChapters();
            this.loadVerses();

            // Preload dictionary for SN versions (don't await, let it load in background)
            if (this.hasSN) {
              this.loadDictionary();
            }

            // Restore saved position after DOM is ready
            this.$nextTick(() => {
              let needsReload = false;

              if (this._pendingBook && this.books.includes(this._pendingBook)) {
                this.selectedBook = this._pendingBook;
                this.updateChapters();
                needsReload = true;
              }

              if (this._pendingChapter && this.chapters.includes(this._pendingChapter)) {
                this.selectedChapter = this._pendingChapter;
                needsReload = true;
              }

              if (needsReload) {
                this.loadVerses();
              }
            });
          }
        },

        updateChapters() {
          if (this.bibleData[this.selectedBook]) {
            this.chapters = Object.keys(this.bibleData[this.selectedBook])
              .map(Number)
              .sort((a, b) => a - b);
          } else {
            this.chapters = [];
          }
        },

        onBookChange() {
          this.updateChapters();
          this.selectedChapter = this.chapters[0] || 1;
          this.loadVerses();
          this.saveReadingPosition();
        },

        loadVerses() {
          if (this.bibleData[this.selectedBook] && this.bibleData[this.selectedBook][this.selectedChapter]) {
            this.currentVerses = this.bibleData[this.selectedBook][this.selectedChapter];
          } else {
            this.currentVerses = [];
          }
          this.saveReadingPosition();
        },

        get canGoPrev() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          const bookIndex = this.books.indexOf(this.selectedBook);
          return chapterIndex > 0 || bookIndex > 0;
        },

        get canGoNext() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          const bookIndex = this.books.indexOf(this.selectedBook);
          return chapterIndex < this.chapters.length - 1 || bookIndex < this.books.length - 1;
        },

        prevChapter() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          if (chapterIndex > 0) {
            this.selectedChapter = this.chapters[chapterIndex - 1];
            this.loadVerses();
          } else {
            const bookIndex = this.books.indexOf(this.selectedBook);
            if (bookIndex > 0) {
              this.selectedBook = this.books[bookIndex - 1];
              this.updateChapters();
              this.selectedChapter = this.chapters[this.chapters.length - 1];
              this.loadVerses();
            }
          }
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        nextChapter() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          if (chapterIndex < this.chapters.length - 1) {
            this.selectedChapter = this.chapters[chapterIndex + 1];
            this.loadVerses();
          } else {
            const bookIndex = this.books.indexOf(this.selectedBook);
            if (bookIndex < this.books.length - 1) {
              this.selectedBook = this.books[bookIndex + 1];
              this.updateChapters();
              this.selectedChapter = this.chapters[0];
              this.loadVerses();
            }
          }
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        search() {
          if (!this.searchQuery.trim()) {
            this.searchResults = [];
            return;
          }

          const query = this.searchQuery.toLowerCase();
          this.searchResults = this.allVerses.filter(verse =>
            verse.text.toLowerCase().includes(query) ||
            verse.ref.toLowerCase().includes(query)
          );
        },

        clearSearch() {
          this.searchQuery = '';
          this.searchResults = [];
        },

        goToVerse(verse) {
          this.selectedBook = verse.book;
          this.updateChapters();
          this.selectedChapter = verse.chapter;
          this.loadVerses();
          this.clearSearch();

          // Scroll to and highlight the verse after DOM updates
          this.$nextTick(() => {
            this.scrollToAndHighlightVerse(verse.verseNum);
          });
        },

        toggleDarkMode() {
          this.isDark = !this.isDark;
          document.documentElement.classList.toggle('dark', this.isDark);
        },

        // Long press handling
        startLongPress(event, verse) {
          this.cancelLongPress();
          this.longPressTimer = setTimeout(() => {
            this.showContextMenu(event, verse);
          }, this.longPressDuration);
        },

        cancelLongPress() {
          if (this.longPressTimer) {
            clearTimeout(this.longPressTimer);
            this.longPressTimer = null;
          }
        },

        // Context menu
        showContextMenu(event, verse) {
          this.cancelLongPress();

          let x, y;
          if (event.touches && event.touches.length > 0) {
            x = event.touches[0].clientX;
            y = event.touches[0].clientY;
          } else if (event.changedTouches && event.changedTouches.length > 0) {
            x = event.changedTouches[0].clientX;
            y = event.changedTouches[0].clientY;
          } else {
            x = event.clientX;
            y = event.clientY;
          }

          // Adjust position to stay within viewport
          const menuWidth = 160;
          const menuHeight = 100;
          if (x + menuWidth > window.innerWidth) {
            x = window.innerWidth - menuWidth - 10;
          }
          if (y + menuHeight > window.innerHeight) {
            y = window.innerHeight - menuHeight - 10;
          }

          this.contextMenu = {
            show: true,
            x: Math.max(10, x),
            y: Math.max(10, y),
            verse: verse
          };
        },

        closeContextMenu() {
          this.contextMenu.show = false;
        },

        // Title modal
        openTitleModal() {
          const verse = this.contextMenu.verse;
          this.titleModal = {
            show: true,
            verse: verse,
            title: this.customTitles[verse.ref] || ''
          };
          this.closeContextMenu();

          // Focus input after modal opens
          this.$nextTick(() => {
            if (this.$refs.titleInput) {
              this.$refs.titleInput.focus();
            }
          });
        },

        closeTitleModal() {
          this.titleModal.show = false;
          this.titleModal.title = '';
        },

        saveTitle() {
          const ref = this.titleModal.verse?.ref;
          if (ref && this.titleModal.title.trim()) {
            this.customTitles[ref] = this.titleModal.title.trim();
          } else if (ref) {
            delete this.customTitles[ref];
          }
          this.saveCustomTitles();
          this.closeTitleModal();
        },

        // Note modal
        openNoteModal(verse) {
          if (!verse) verse = this.contextMenu.verse;
          this.noteModal = {
            show: true,
            verse: verse,
            note: this.notes[verse.ref] || ''
          };
          this.closeContextMenu();

          this.$nextTick(() => {
            if (this.$refs.noteInput) {
              this.$refs.noteInput.focus();
            }
          });
        },

        closeNoteModal() {
          this.noteModal.show = false;
          this.noteModal.note = '';
        },

        saveNote() {
          const ref = this.noteModal.verse?.ref;
          if (ref && this.noteModal.note.trim()) {
            this.notes[ref] = this.noteModal.note.trim();
          } else if (ref) {
            delete this.notes[ref];
          }
          this.saveNotes();
          this.closeNoteModal();
        },

        // Settings & File System Access API methods
        async saveAutoSyncPreference() {
          try {
            await idbKeyval.set('bible_autoSync', this.autoSync);
          } catch (e) {
            console.warn('Failed to save auto-sync preference:', e);
          }
        },

        getExportData() {
          return {
            version: 1,
            exportedAt: new Date().toISOString(),
            customTitles: JSON.parse(JSON.stringify(this.customTitles)),
            notes: JSON.parse(JSON.stringify(this.notes)),
            selectedBook: this.selectedBook,
            selectedChapter: this.selectedChapter
          };
        },

        async exportData() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            const data = this.getExportData();
            const jsonString = JSON.stringify(data, null, 2);

            if (this.hasFileSystemAccess) {
              // Use File System Access API
              if (!this.fileHandle) {
                // Prompt user to select/create a file
                this.fileHandle = await window.showSaveFilePicker({
                  suggestedName: 'bible-backup.json',
                  types: [{
                    description: 'JSON Files',
                    accept: { 'application/json': ['.json'] }
                  }]
                });
                // Save the new file handle to IndexedDB
                await this.saveFileHandle();
              } else {
                // Verify permission for existing file handle
                const hasPermission = await this.verifyPermission(true);
                if (!hasPermission) {
                  this.settingsModal.message = 'æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹é‡æ–°é¸æ“‡æª”æ¡ˆ';
                  this.settingsModal.isError = true;
                  this.fileHandle = null;
                  await this.saveFileHandle();
                  return;
                }
              }

              // Write to the file
              const writable = await this.fileHandle.createWritable();
              await writable.write(jsonString);
              await writable.close();

              this.settingsModal.message = `å·²å„²å­˜è‡³ ${this.fileHandle.name}`;
              this.settingsModal.isError = false;
            } else {
              // Fallback to download
              const blob = new Blob([jsonString], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `bible-backup-${new Date().toISOString().slice(0, 10)}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              this.settingsModal.message = 'å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰';
              this.settingsModal.isError = false;
            }
          } catch (e) {
            if (e.name === 'AbortError') {
              // User cancelled the file picker
              this.settingsModal.message = '';
            } else {
              console.error('Export failed:', e);
              this.settingsModal.message = 'åŒ¯å‡ºå¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        async importData() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            let fileContent;

            if (this.hasFileSystemAccess) {
              // Use File System Access API
              const [handle] = await window.showOpenFilePicker({
                types: [{
                  description: 'JSON Files',
                  accept: { 'application/json': ['.json'] }
                }],
                multiple: false
              });

              const file = await handle.getFile();
              fileContent = await file.text();

              // Store the handle for future use and persist to IndexedDB
              this.fileHandle = handle;
              await this.saveFileHandle();
            } else {
              // Fallback to file input
              fileContent = await new Promise((resolve, reject) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,application/json';
                input.onchange = async (e) => {
                  const file = e.target.files[0];
                  if (file) {
                    resolve(await file.text());
                  } else {
                    reject(new Error('No file selected'));
                  }
                };
                input.click();
              });
            }

            const data = JSON.parse(fileContent);

            // Validate data structure
            if (!data.version || !data.exportedAt) {
              throw new Error('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼');
            }

            // Import the data
            if (data.customTitles) {
              this.customTitles = data.customTitles;
              await this.saveCustomTitles();
            }
            if (data.notes) {
              this.notes = data.notes;
              await this.saveNotes();
            }
            if (data.selectedBook && this.books.includes(data.selectedBook)) {
              this.selectedBook = data.selectedBook;
              this.updateChapters();
            }
            if (data.selectedChapter && this.chapters.includes(data.selectedChapter)) {
              this.selectedChapter = data.selectedChapter;
            }
            this.loadVerses();
            await this.saveReadingPosition();

            const noteCount = Object.keys(this.notes).length;
            const titleCount = Object.keys(this.customTitles).length;
            this.settingsModal.message = `å·²åŒ¯å…¥ ${titleCount} å€‹æ¨™é¡Œå’Œ ${noteCount} å€‹ç­†è¨˜`;
            this.settingsModal.isError = false;
          } catch (e) {
            if (e.name === 'AbortError') {
              // User cancelled
              this.settingsModal.message = '';
            } else {
              console.error('Import failed:', e);
              this.settingsModal.message = 'åŒ¯å…¥å¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        async unlinkFile() {
          this.fileHandle = null;
          await this.saveFileHandle();
          this.settingsModal.message = 'å·²è§£é™¤æª”æ¡ˆé€£çµ';
          this.settingsModal.isError = false;
        },

        // Clear all cached versions except the currently selected one
        async clearAllVersions() {
          try {
            const versionsToDelete = this.cachedVersions.filter(id => id !== this.selectedVersionId);
            for (const versionId of versionsToDelete) {
              await idbKeyval.del(`bible_version_${versionId}`);
            }
            this.cachedVersions = [this.selectedVersionId];
            await this.saveCachedVersions();
            this.settingsModal.message = `å·²æ¸…é™¤ ${versionsToDelete.length} å€‹è­¯æœ¬å¿«å–`;
            this.settingsModal.isError = false;
          } catch (e) {
            console.error('Failed to clear cache:', e);
            this.settingsModal.message = 'æ¸…é™¤å¿«å–å¤±æ•—ï¼š' + e.message;
            this.settingsModal.isError = true;
          }
        },

        // Auto-sync on data changes (call after saving notes/titles)
        async triggerAutoSync() {
          if (this.autoSync && this.fileHandle && this.hasFileSystemAccess) {
            try {
              // Verify permission before writing
              const hasPermission = await this.verifyPermission(true);
              if (!hasPermission) {
                console.warn('Auto-sync skipped: permission denied');
                return;
              }

              const data = this.getExportData();
              const jsonString = JSON.stringify(data, null, 2);
              const writable = await this.fileHandle.createWritable();
              await writable.write(jsonString);
              await writable.close();
              console.log('Auto-synced to file');
            } catch (e) {
              console.warn('Auto-sync failed:', e);
            }
          }
        },

        // Strong's Number support
        // Check if current version has Strong's Numbers
        get hasSN() {
          return this.selectedVersionId.includes('-SN') || this.selectedVersionId.includes('_SN');
        },

        // Get dictionary file name for current version
        getDictFileName() {
          // For SN versions, the dict file should match the version
          // e.g., zh-rTW_CUV-SN -> zh-rTW_CUV-SN.dict
          // e.g., en_KJV-SN -> en_KJV-SN.dict
          return `${this.selectedVersionId}.dict`;
        },

        // Load dictionary for current version
        async loadDictionary() {
          if (!this.hasSN) return;
          if (Object.keys(this.snDictionary).length > 0) return; // Already loaded

          this.snDictLoading = true;

          try {
            // Try to load from cache first
            const cacheKey = `bible_dict_${this.selectedVersionId}`;
            let dictText = await idbKeyval.get(cacheKey);

            if (!dictText) {
              // Fetch from network
              const dictFile = this.getDictFileName();
              const response = await fetch(`./dict/${dictFile}`);
              if (!response.ok) {
                console.warn(`Dictionary not found: ${dictFile}`);
                return;
              }
              dictText = await response.text();

              // Cache it
              try {
                await idbKeyval.set(cacheKey, dictText);
              } catch (e) {
                console.warn('Failed to cache dictionary:', e);
              }
            }

            // Parse dictionary: CODE,definition format
            this.snDictionary = {};
            const lines = dictText.split('\n');
            for (const line of lines) {
              if (!line.trim()) continue;
              const commaIndex = line.indexOf(',');
              if (commaIndex > 0) {
                const code = line.substring(0, commaIndex).trim();
                const definition = line.substring(commaIndex + 1);
                this.snDictionary[code] = definition;
              }
            }

            console.log(`Loaded ${Object.keys(this.snDictionary).length} dictionary entries`);
          } catch (e) {
            console.error('Failed to load dictionary:', e);
          } finally {
            this.snDictLoading = false;
          }
        },

        // Render verse text with clickable SN codes
        renderVerseText(text) {
          if (!this.hasSN || !text) {
            // Escape HTML for safety
            return this.escapeHtml(text);
          }

          // Match Strong's Number patterns: <H####> or <G####>
          // H = Hebrew (OT), G = Greek (NT)
          const snPattern = /<([HG]\d+)>/g;

          // Replace SN codes with clickable spans
          return text.replace(snPattern, (match, code) => {
            return `<span class="sn-code" onclick="Alpine.$data(document.querySelector('[x-data]')).showSNDefinition('${code}')">${code}</span>`;
          });
        },

        // Escape HTML to prevent XSS
        escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        },

        // Show SN definition modal
        async showSNDefinition(code) {
          this.snModal.show = true;
          this.snModal.code = code;
          this.snModal.definition = '';
          this.snModal.loading = true;

          // Load dictionary if not loaded
          if (Object.keys(this.snDictionary).length === 0) {
            await this.loadDictionary();
          }

          this.snModal.loading = false;

          // Look up definition
          const definition = this.snDictionary[code];
          if (definition) {
            // Convert \n to <br> for display and escape HTML in the definition
            this.snModal.definition = this.formatDefinition(definition);
          }
        },

        // Format definition for display
        formatDefinition(definition) {
          if (!definition) return '';

          // Replace literal \n with actual line breaks
          let formatted = definition.replace(/\\n/g, '\n');

          // Process special links BEFORE escaping HTML
          // Pattern: <SN|display_text|code> -> clickable SN link
          // Pattern: <Verse|display_text|BOOK:chapter:verse> -> clickable verse link
          // Pattern: #<Verse|...|...>| -> verse with # prefix and | suffix

          // First, replace the patterns with placeholders to protect them from HTML escaping
          const snLinks = [];
          const verseLinks = [];

          // Extract SN links: <SN|display|code>
          formatted = formatted.replace(/<SN\|([^|]+)\|([^>]+)>/g, (match, display, code) => {
            const index = snLinks.length;
            snLinks.push({ display, code });
            return `__SN_LINK_${index}__`;
          });

          // Extract Verse links: <Verse|display|BOOK:chapter:verse> or #<Verse|...|...>|
          formatted = formatted.replace(/#?<Verse\|([^|]+)\|([^>]+)>\|?/g, (match, display, ref) => {
            const index = verseLinks.length;
            verseLinks.push({ display, ref });
            return `__VERSE_LINK_${index}__`;
          });

          // Escape HTML
          formatted = this.escapeHtml(formatted);

          // Restore SN links as clickable elements
          snLinks.forEach((link, index) => {
            const escapedDisplay = this.escapeHtml(link.display);
            const clickHandler = `Alpine.$data(document.querySelector('[x-data]')).showSNDefinition('${link.code}')`;
            formatted = formatted.replace(
              `__SN_LINK_${index}__`,
              `<span class="sn-link" onclick="${clickHandler}">${escapedDisplay}</span>`
            );
          });

          // Restore Verse links as clickable elements
          verseLinks.forEach((link, index) => {
            const escapedDisplay = this.escapeHtml(link.display);
            const clickHandler = `Alpine.$data(document.querySelector('[x-data]')).goToVerseByRef('${link.ref}')`;
            formatted = formatted.replace(
              `__VERSE_LINK_${index}__`,
              `<span class="verse-link" onclick="${clickHandler}">${escapedDisplay}</span>`
            );
          });

          // Convert newlines to <br>
          formatted = formatted.replace(/\n/g, '<br>');

          return formatted;
        },

        // Navigate to verse by reference string (e.g., "ISA:59:9" or "MAT:15:23")
        goToVerseByRef(ref) {
          // Parse format: BOOK:chapter:verse or BOOK:chapter
          const parts = ref.split(':');
          if (parts.length < 2) return;

          const bookCode = parts[0];
          const chapter = parseInt(parts[1]);
          const verseNum = parts.length > 2 ? parseInt(parts[2]) : 1;

          // Get book name from mapping
          const bookName = BOOK_NAMES[bookCode];
          if (!bookName || !this.books.includes(bookName)) {
            console.warn(`Book not found: ${bookCode}`);
            return;
          }

          // Close modal and navigate
          this.snModal.show = false;
          this.selectedBook = bookName;
          this.updateChapters();

          if (this.chapters.includes(chapter)) {
            this.selectedChapter = chapter;
          } else {
            this.selectedChapter = this.chapters[0] || 1;
          }

          this.loadVerses();
          this.saveReadingPosition();

          // Scroll to and highlight the verse after DOM updates
          this.$nextTick(() => {
            this.scrollToAndHighlightVerse(verseNum);
          });
        },

        // Scroll to a specific verse and highlight it
        scrollToAndHighlightVerse(verseNum) {
          // Small delay to ensure animations are complete
          setTimeout(() => {
            const verseElement = document.querySelector(`[data-verse-num="${verseNum}"]`);
            if (verseElement) {
              // Scroll the verse into view with some offset for the header
              const headerHeight = 80;
              const elementTop = verseElement.getBoundingClientRect().top + window.scrollY;
              window.scrollTo({
                top: elementTop - headerHeight - 20,
                behavior: 'smooth'
              });

              // Remove class first if present, force reflow, then add back to restart animation
              verseElement.classList.remove('verse-highlight');
              void verseElement.offsetWidth;
              verseElement.classList.add('verse-highlight');
              // Don't remove the class - it will stay at final animation state (no visual effect)
              // Removing it would cause the verse-item opacity:0 to kick in again
            }
          }, 100);
        }
      };
    }
  </script>
</body>

</html>