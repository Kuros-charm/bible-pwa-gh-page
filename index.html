<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" >
  <title>bible-pwa</title>
  <!-- <script src="https://cdn.tailwindcss.com"></script> --> <!-- using tailwindcss/vite now-->
  <script src="https://unpkg.com/idb-keyval@6/dist/umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* === Essential: Alpine.js cloak === */
    [x-cloak] { display: none !important; }

    /* === Theme: CSS Variables === */
    :root {
      --bg-primary: #faf8f5;
      --bg-secondary: #f0ebe3;
      --text-primary: #2c2416;
      --text-secondary: #6b5d4d;
      --accent: #8b4513;
      --accent-light: #d4a574;
      --border: #e0d5c7;
    }
    .dark {
      --bg-primary: #1a1612;
      --bg-secondary: #2a2420;
      --text-primary: #e8e0d5;
      --text-secondary: #a89a88;
      --accent: #d4a574;
      --accent-light: #8b6543;
      --border: #3d352d;
    }

    /* === Theme: Utility classes using CSS vars === */
    html { touch-action: pan-x pan-y; }
    body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; touch-action: pan-x pan-y; }
    .bg-primary { background-color: var(--bg-primary); }
    .bg-secondary { background-color: var(--bg-secondary); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-accent { color: var(--accent); }
    .bg-accent { background-color: var(--accent); }
    .border-accent { border-color: var(--accent); }
    .border-accent-light { border-color: var(--accent-light); }
    .border-custom { border-color: var(--border); }

    /* === Scrollbar (no Tailwind equivalent) === */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: var(--bg-secondary); }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--accent-light); border-radius: 3px; }

    /* === Animations === */
    .verse-item {
      opacity: 1;
      padding: 0rem 0.5rem;
    }

    /* === Components using CSS vars (can't fully convert to Tailwind) === */
    .section-title { color: var(--accent); font-weight: 700; }
    .source-title { color: var(--text-secondary); font-weight: 600; font-style: italic; opacity: 0.85; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 200; }
    .modal-content { background-color: var(--bg-primary); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; width: 90%; max-width: 400px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); }
    .verse-container { user-select: none; -webkit-user-select: none; cursor: pointer; transition: box-shadow 0.2s ease, border-radius 0.2s ease; }
    .verse-container.tts-playing { pointer-events: none; cursor: default; }

    /* === Dynamic content styles (used in x-html, can't use Tailwind) === */
    .sn-code { color: var(--accent); cursor: pointer; text-decoration: underline; text-decoration-style: dotted; transition: color 0.2s; margin: 0 0.15em; }
    .sn-code:hover { color: var(--accent-light); text-decoration-style: solid; }
    .sn-link { color: var(--accent); cursor: pointer; text-decoration: underline; text-decoration-style: dotted; transition: color 0.2s; }
    .sn-link:hover { color: var(--accent-light); text-decoration-style: solid; }
    .verse-link { color: #4a90d9; cursor: pointer; text-decoration: underline; transition: color 0.2s, background-color 0.2s; padding: 0 2px; border-radius: 2px; }
    .dark .verse-link { color: #6bb3ff; }
    .verse-link:hover { background-color: rgba(74, 144, 217, 0.15); }
    .search-highlight { background-color: #fef08a; color: #854d0e; padding: 0.1em 0.2em; border-radius: 0.2em; }
    .dark .search-highlight { background-color: #854d0e; color: #fef9c3; }

    /* Drawer panel - fixed height on mobile, min-height on desktop */
    .drawer-panel {
      height: 75dvh;
      max-height: 75dvh;
    }
    @media (min-width: 640px) {
      .drawer-panel {
        height: auto;
        min-height: 75dvh;
        max-height: 90dvh;
      }
    }

    /* =====================================================================
       REUSABLE DRAWER DIALOG STYLES
       =====================================================================
       Usage: Apply .drawer-dialog to <dialog> element
       Inner structure uses .drawer-panel-container, .drawer-handle,
       .drawer-header, .drawer-title, .drawer-close-btn, .drawer-content, .drawer-footer
       ===================================================================== */

    .drawer-dialog {
      padding: 0;
      margin: 0;
      border: 0;
      background: transparent;
      position: fixed;
      inset: 0;
      z-index: 200;
      width: 100%;
      max-width: none;
      height: 100%;
      max-height: none;
    }
    .drawer-dialog::backdrop {
      background-color: rgba(0, 0, 0, 0.4);
    }
    .drawer-dialog[open] .drawer-panel,
    .drawer-dialog[open] .drawer-panel-container {
      animation: drawerSlideUp 0.3s ease-out;
    }
    @keyframes drawerSlideUp {
      from { transform: translate(-50%, 100%); }
      to { transform: translate(-50%, 0); }
    }

    /* Drawer panel container - the visible bottom sheet */
    .drawer-panel-container {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: 100%;
      max-width: 42rem; /* max-w-2xl */
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      border-radius: 1rem 1rem 0 0;
      background-color: var(--bg-primary);
      height: 75dvh;
      max-height: 75dvh;
    }
    @media (min-width: 640px) {
      .drawer-panel-container {
        height: auto;
        min-height: 75dvh;
        max-height: 90dvh;
      }
    }

    /* Drag handle */
    .drawer-handle {
      flex-shrink: 0;
      display: flex;
      justify-content: center;
      padding: 0.5rem 0;
    }
    .drawer-handle::after {
      content: '';
      width: 2.5rem;
      height: 0.25rem;
      border-radius: 9999px;
      background-color: var(--border);
    }

    /* Header */
    .drawer-header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    /* Title */
    .drawer-title {
      font-weight: 600;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Close button */
    .drawer-close-btn {
      padding: 0.5rem;
      border-radius: 9999px;
      flex-shrink: 0;
      transition: background-color 0.2s;
    }
    .drawer-close-btn:hover {
      background-color: var(--bg-secondary);
    }

    /* Content area */
    .drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    /* Footer */
    .drawer-footer {
      flex-shrink: 0;
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--border);
    }

    /* Prevent background scroll when any dialog is open */
    body:has(dialog[open]) {
      overflow: hidden;
    }
  </style>
  <script type="module" crossorigin src="/bible-pwa-gh-page/assets/index-CN4y9Sss.js"></script>
  <link rel="stylesheet" crossorigin href="/bible-pwa-gh-page/assets/index-B58fT-fA.css">
<link rel="manifest" href="/bible-pwa-gh-page/manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<link rel="icon" href="/bible-pwa-gh-page/favicon.ico" sizes="48x48">
<link rel="icon" href="/bible-pwa-gh-page/favicon.svg" sizes="any" type="image/svg+xml">
<link rel="apple-touch-icon" href="/bible-pwa-gh-page/apple-touch-icon-180x180.png"></head>

<body class="min-h-screen" x-data="bibleReader()">
  <svg style="display: none;">
    <symbol id="icon-close" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </symbol>
  </svg>
  <script>
    // Prevent pinch zoom on Safari (ignores viewport meta)
    document.addEventListener('gesturestart', function(e) { e.preventDefault(); }, { passive: false });
    document.addEventListener('gesturechange', function(e) { e.preventDefault(); }, { passive: false });
    document.addEventListener('gestureend', function(e) { e.preventDefault(); }, { passive: false });
  </script>

  <div id="app" :style="`zoom: ${zoom / 100};`"
    @touchstart="handlePinchStart($event)"
    @touchmove="handlePinchMove($event)"
    @touchend="handlePinchEnd($event)"
    @touchcancel="handlePinchEnd($event)">
      <!-- Header -->
  <header class="bg-primary sticky top-0 z-50">
    <!-- Top Row: Navigation & Controls -->
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">

      <!-- Left: Book/Chapter & Version -->
      <div class="flex items-center gap-3">
        <!-- Location -->
        <button @click="navModal.pendingBook = null; navModal.pendingChapter = null; navModal.tab = 'chapters'; navModal.show = true; $refs.navDialog.showModal()"
          class="flex items-center gap-1 py-1.5 hover:opacity-70 transition-opacity">
          <span class="text-base font-medium text-primary" x-text="selectedBookName + ' ' + selectedChapter + ' ç« '"></span>
          <svg class="w-3.5 h-3.5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <!-- Vertical Divider -->
        <div class="w-px h-4" style="background-color: var(--border);"></div>

        <!-- Version -->
        <button @click="versionModal.tab = 'select'; versionModal.show = true; $refs.versionDialog.showModal()"
          class="flex items-center gap-1 py-1.5 hover:opacity-70 transition-opacity">
          <span class="text-base text-secondary" x-text="currentVersion.name"></span>
          <svg class="w-3.5 h-3.5 text-secondary opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
      </div>

      <!-- Right: Actions -->
      <div class="flex items-center gap-1">
        <!-- Visible header actions -->
        <template x-for="action in headerActions.filter(a => a.visible)" :key="'header-action-' + action.id">
          <button @click="triggerHeaderAction(action.id)"
            :class="action.id === 'search' && headerSearchOpen ? 'text-accent bg-secondary' : 'text-secondary'"
            class="p-2 rounded-full hover:bg-secondary transition-colors"
            :title="action.name">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" x-html="getHeaderActionIcon(action.id)"></svg>
          </button>
        </template>
        <!-- Overflow menu (shown when there are hidden actions) -->
        <div x-show="headerActions.some(a => !a.visible)" class="relative">
          <button @click="headerOverflowOpen = !headerOverflowOpen"
            :class="headerOverflowOpen ? 'text-accent bg-secondary' : 'text-secondary'"
            class="p-2 rounded-full hover:bg-secondary transition-colors" title="æ›´å¤š">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
            </svg>
          </button>
          <!-- Dropdown menu -->
          <div x-show="headerOverflowOpen" x-cloak
            @click.away="headerOverflowOpen = false"
            x-transition:enter="transition ease-out duration-150"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition ease-in duration-100"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="absolute right-0 top-full mt-1 py-1 min-w-[140px] rounded-lg shadow-lg border border-custom z-50"
            style="background-color: var(--bg-primary);">
            <template x-for="action in headerActions.filter(a => !a.visible)" :key="'overflow-action-' + action.id">
              <button @click="triggerHeaderAction(action.id); headerOverflowOpen = false"
                class="w-full px-4 py-2 text-left text-primary hover:bg-secondary transition-colors flex items-center gap-3"
                :style="`font-size: ${fontSize * 0.9}rem;`">
                <svg class="w-4 h-4 text-secondary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" x-html="getHeaderActionIcon(action.id)"></svg>
                <span x-text="action.name"></span>
              </button>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Expandable Search Bar -->
    <div class="overflow-hidden transition-all duration-300 ease-in-out"
      :class="headerSearchOpen ? 'max-h-20 opacity-100' : 'max-h-0 opacity-0'">
      <div class="max-w-4xl mx-auto px-4 pt-2 pb-3">
        <div class="flex items-center gap-2">
          <div class="relative flex-1">
            <input type="text" x-model="searchQuery" @input="search()" placeholder="æœå°‹ç¶“æ–‡..."
              x-ref="headerSearchInput"
              class="w-full bg-secondary border border-custom rounded-lg py-2 pl-4 pr-10 text-sm text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-accent/30 shadow-inner">
            <button x-show="searchQuery" @click="clearSearch()"
              class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-secondary hover:text-primary">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <!-- Close search bar button -->
          <button @click="headerSearchOpen = false; searchQuery = ''; searchResults = []"
            class="p-2 text-secondary hover:text-primary hover:bg-secondary rounded-full transition-colors flex-shrink-0"
            title="é—œé–‰æœå°‹">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Expandable TTS Control Bar -->
    <div class="overflow-hidden transition-all duration-300 ease-in-out"
      :class="tts.show ? 'max-h-32 opacity-100' : 'max-h-0 opacity-0'">
      <div class="max-w-4xl mx-auto px-4 pt-2 pb-3">
        <div class="flex flex-wrap items-center gap-3">
          <!-- Play/Stop Toggle Button -->
          <div class="flex items-center gap-1">
            <button @click="ttsToggle()"
              :disabled="!tts.playing && !tts.paused && (!currentVerses || currentVerses.length === 0)"
              class="p-2 rounded-lg transition-colors disabled:opacity-50"
              :class="tts.playing || tts.paused ? 'bg-accent text-white' : 'bg-secondary text-primary hover:bg-primary hover:text-accent'"
              :title="tts.playing || tts.paused ? 'åœæ­¢' : 'æ’­æ”¾'">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" x-show="!(tts.playing || tts.paused)">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" x-show="tts.playing || tts.paused">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
              </svg>
            </button>
          </div>

          <!-- Speed Control -->
          <div class="flex items-center gap-2">
            <span class="text-secondary text-sm">é€Ÿåº¦</span>
            <button @click="tts.speed -= 0.1; tts.speed = Math.max(0.5, tts.speed); saveTtsSettings()"
              :disabled="tts.speed <= 0.5"
              class="p-1 rounded hover:bg-secondary text-secondary transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
              </svg>
            </button>
            <span class="text-primary font-medium min-w-[3ch] text-center" x-text="tts.speed.toFixed(2) + 'x'"></span>
            <button @click="tts.speed += 0.1; tts.speed = Math.min(2, tts.speed); saveTtsSettings()"
              :disabled="tts.speed >= 2"
              class="p-1 rounded hover:bg-secondary text-secondary transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
            </button>
          </div>

          <!-- Language/Voice Selection -->
          <div class="flex items-center gap-2">
            <select x-model="tts.language" @change="onTtsLanguageChange(); saveTtsSettings()"
              class="bg-secondary border border-custom rounded-lg px-2 py-1.5 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-accent/30">
              <option value="zh-TW">ä¸­æ–‡ï¼ˆåœ‹èªï¼‰</option>
              <option value="zh-HK">ä¸­æ–‡ï¼ˆç²µèªï¼‰</option>
              <option value="en-US">English</option>
            </select>
            <select x-model="tts.selectedVoice" x-show="tts.voices.length > 0" @change="saveTtsSettings()"
              class="bg-secondary border border-custom rounded-lg px-2 py-1.5 text-sm text-primary focus:outline-none focus:ring-2 focus:ring-accent/30 max-w-[150px]">
              <template x-for="voice in tts.voices" :key="voice.name">
                <option :value="voice.name" x-text="voice.name"></option>
              </template>
            </select>
          </div>

          <!-- Close TTS bar button -->
          <button @click="tts.show = false; ttsStop()"
            class="ml-auto p-2 text-secondary hover:text-primary hover:bg-secondary rounded-full transition-colors"
            title="é—œé–‰æœ—è®€">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <!-- Playing indicator -->
        <div x-show="tts.playing || tts.paused" class="mt-2 text-sm text-secondary">
          <span x-text="tts.playing ? 'ğŸ”Š æ’­æ”¾ä¸­' : 'â¸ å·²æš«åœ'"></span>
          <span x-show="currentVerses[tts.currentVerseIndex]"> - <span x-text="currentVerses[tts.currentVerseIndex] ? formatRef(currentVerses[tts.currentVerseIndex].ref): ''"></span></span>
        </div>
      </div>
    </div>

    <!-- Subtle bottom border -->
    <div class="h-px w-full opacity-50" style="background: linear-gradient(to right, transparent, var(--border), transparent);"></div>
  </header>

  <main class="max-w-4xl mx-auto px-1 sm:px-1 py-4"
    @touchstart="handleSwipeStart($event)"
    @touchmove="handleSwipeMove($event)"
    @touchend="handleSwipeEnd()"
    @touchcancel="handleSwipeEnd()">
    <!-- Verses Display -->
    <div class="py-2 min-h-[400px]">
      <!-- Search Results -->
      <template x-if="searchQuery && searchResults.length > 0">
        <div :style="`display: flex; flex-direction: column; gap: ${verseSpacing}px;`">
          <h2 class="text-lg font-semibold text-accent">
            æœå°‹çµæœ (<span x-text="searchResults.length"></span> ç­†)
          </h2>
          <template x-for="(verse, index) in searchResults.slice(0, 100)" :key="'search-' + index">
            <div class="verse-item pl-3 border-l-2 border-custom hover:border-accent cursor-pointer transition-colors"
              :style="'animation-delay: ' + (index * 30) + 'ms'"
              @click="goToVerse(verse)">
              <!-- Reference as section title -->
              <div class="section-title"
                :style="`font-size: ${fontSize}rem; font-family: ${currentFontFamily}; margin-bottom: ${verseSpacing * 0.25}px;`"
                x-html="highlightSearch(formatRef(verse.ref))"></div>
              <!-- Verse text -->
              <div :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
                class="text-primary"
                x-html="highlightSearch(verse.text)"></div>
            </div>
          </template>
          <p x-show="searchResults.length > 100" class="text-secondary text-sm text-center">
            é¡¯ç¤ºå‰ 100 ç­†çµæœï¼Œå…± <span x-text="searchResults.length"></span> ç­†
          </p>
        </div>
      </template>

      <!-- No Search Results -->
      <template x-if="searchQuery && searchResults.length === 0">
        <div class="flex flex-col items-center justify-center py-16 text-secondary">
          <span class="text-4xl mb-4">ğŸ“­</span>
          <p>æ‰¾ä¸åˆ°ç¬¦åˆï¿½ï¿½ï¿½ï¿½ï¿½ç¶“æ–‡</p>
        </div>
      </template>

      <!-- Chapter Verses -->
      <template x-if="!searchQuery">
        <div class="flex flex-col">
          <template x-for="(verse, index) in currentVerses" :key="'verse-' + index">
            <div class="verse-container"
              :style="`padding-top: ${verseSpacing / 2}px; padding-bottom: ${verseSpacing / 2}px;`"
              :class="{ 'tts-playing': tts.playing || tts.paused }"
              @click="showVerseActions(verse)"
              @contextmenu.prevent="showVerseActions(verse)">
              <!-- Source Title (pre-existing from Bible text, not editable) -->
              <div x-show="sourceTitles[verse.ref]"
                class="source-title"
                :style="`font-size: ${fontSize * 0.9}rem; font-family: ${currentFontFamily}; margin-top: ${verseSpacing * 0.5}px; margin-bottom: ${verseSpacing * 0.25}px;`"
                x-text="sourceTitles[verse.ref]"></div>
              <!-- Custom Section Title (user-defined, displayed before the verse, click to edit) -->
              <div x-show="customTitles[verse.ref]"
                @click.stop="openTitleModalForVerse(verse)"
                class="section-title cursor-pointer hover:opacity-70 transition-opacity"
                :style="`font-size: ${fontSize}rem; font-family: ${currentFontFamily}; margin-top: ${sourceTitles[verse.ref] ? verseSpacing * 0.25 : verseSpacing * 0.5}px; margin-bottom: ${verseSpacing * 0.5}px;`"
                x-text="customTitles[verse.ref]"></div>
              <!-- Verse Content -->
              <div class="verse-item"
                :data-verse-num="verse.verseNum"
                :class="{
                  'verse-selected': verseActions.show && verseActions.verse?.ref === verse.ref && !(tts.playing || tts.paused),
                  'verse-tts': (tts.playing || tts.paused) && tts.currentVerseIndex === index
                }"
                :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};` + (getHighlightColor(verse.ref) ? `background-color: ${getHighlightColor(verse.ref)}cc; color: ${getHighlightTextColor(verse.ref)};` : '')">
                <sup
                  class="font-medium opacity-70"
                  :style="`font-size: 0.75em; margin-right: 0em;` + (getVerseNumBgColor(verse.ref) ? `background-color: ${getVerseNumBgColor(verse.ref)}; color: ${getVerseNumColor(verse.ref)}; box-shadow: -0.25em 0 0 ${getVerseNumBoxShadowColor(verse.ref)}, 0.25em 0 0 ${getVerseNumBoxShadowColor(verse.ref)};` : `color: ${getVerseNumColor(verse.ref)}`)"
                  x-text="verse.verseNum"
                ></sup>
                <span x-html="renderVerseText(verse.text)"></span>
                <button x-show="notes[verse.ref] && !(tts.playing || tts.paused)" @click.stop="openNoteModal(verse)"
                  class="inline-flex ml-1 opacity-70 hover:opacity-100" title="æŸ¥çœ‹ç­†è¨˜">âœï¸</button>
              </div>
              <!-- Comparison Verses -->
              <template x-if="compareVerseRef === verse.ref && compareVerses.length > 0">
                <div x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 -translate-y-2"
                  x-transition:enter-end="opacity-100 translate-y-0"
                  class="mt-2 pl-1 border-l-2 border-accent/30 flex flex-col"
                  :style="`gap: ${verseSpacing * 0.5}px;`">
                  <template x-for="(cv, cvIdx) in compareVerses" :key="'compare-' + cvIdx">
                    <div class="py-1">
                      <div class="text-accent text-base font-medium mb-1" x-text="cv.versionName"></div>
                      <div class="text-primary"
                        :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
                        x-html="renderCompareVerseText(cv.text, cv.versionId)"></div>
                    </div>
                  </template>
                  <!-- Close button -->
                  <button @click.stop="compareVerseRef = null; compareVerses = []"
                    class="self-start text-sm text-secondary hover:text-accent transition-colors">
                    âœ• é—œé–‰å°ç…§
                  </button>
                </div>
              </template>
              <!-- No other versions message -->
              <template x-if="compareVerseRef === verse.ref && compareVerses.length === 0 && cachedVersions.length <= 1">
                <div class="mt-2 pl-4 border-l-2 border-accent/30 py-2 text-secondary text-sm">
                  <p>å°šæœªä¸‹è¼‰å…¶ä»–è­¯æœ¬ã€‚è«‹è‡³è¨­å®šä¸­ä¸‹è¼‰å…¶ä»–è­¯æœ¬ä»¥ä½¿ç”¨å°ç…§åŠŸèƒ½ã€‚</p>
                  <button @click.stop="compareVerseRef = null"
                    class="mt-1 text-accent hover:underline">é—œé–‰</button>
                </div>
              </template>
            </div>
          </template>


          <!-- Empty State -->
          <div x-show="currentVerses.length === 0 && !isLoading"
            class="flex flex-col items-center justify-center py-16 text-secondary">
            <span class="text-4xl mb-4">ğŸ“–</span>
            <p>é¸æ“‡æ›¸å·å’Œç« ç¯€é–‹å§‹é–±è®€</p>
          </div>

          <!-- Loading State -->
          <div x-show="isLoading" class="flex flex-col items-center justify-center py-16 text-secondary">
            <div class="relative mb-4">
              <span class="text-4xl animate-pulse">ğŸ“¥</span>
            </div>
            <p class="font-medium text-primary mb-2" x-text="loadingMessage"></p>
            <p x-show="loadingSubMessage" class="text-sm" x-text="loadingSubMessage"></p>
          </div>
        </div>
      </template>
    </div>

  </main>

  <!-- Swipe Navigation Arrows -->
  <!-- Left Arrow (Previous Chapter) -->
  <div x-cloak x-show="shouldShowArrow('left')" x-data="{ hovered: false }"
    class="fixed top-1/2 -translate-y-1/2 z-[100] select-none"
    :class="isDesktop && !swipeState.active ? 'pointer-events-auto cursor-pointer' : 'pointer-events-none'"
    :style="`opacity: ${getSwipeArrowOpacity('left')}; left: ${isDesktop ? 'max(0.5rem, calc(50% - 32rem))' : '0.5rem'};`"
    @click="isDesktop && prevChapter()"
    @mouseenter="hovered = true"
    @mouseleave="hovered = false">
    <div class="flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 rounded-full transition-all duration-200"
      :class="swipeState.progress >= 1 || (isDesktop && hovered) ? 'scale-110' : ''"
      :style="swipeState.progress >= 1 || (isDesktop && hovered) ? 'background-color: var(--text-primary);' : 'background-color: var(--bg-primary); box-shadow: 0 0 0 1px var(--border);'">
      <svg class="w-6 h-6 sm:w-7 sm:h-7 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        :style="swipeState.progress >= 1 || (isDesktop && hovered) ? 'color: var(--bg-primary);' : 'color: var(--text-primary);'">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
      </svg>
    </div>
  </div>

  <!-- Right Arrow (Next Chapter) -->
  <div x-cloak x-show="shouldShowArrow('right')" x-data="{ hovered: false }"
    class="fixed top-1/2 -translate-y-1/2 z-[100] select-none"
    :class="isDesktop && !swipeState.active ? 'pointer-events-auto cursor-pointer' : 'pointer-events-none'"
    :style="`opacity: ${getSwipeArrowOpacity('right')}; right: ${isDesktop ? 'max(0.5rem, calc(50% - 32rem))' : '0.5rem'};`"
    @click="isDesktop && nextChapter()"
    @mouseenter="hovered = true"
    @mouseleave="hovered = false">
    <div class="flex items-center justify-center w-10 h-10 sm:w-12 sm:h-12 rounded-full transition-all duration-200"
      :class="swipeState.progress <= -1 || (isDesktop && hovered) ? 'scale-110' : ''"
      :style="swipeState.progress <= -1 || (isDesktop && hovered) ? 'background-color: var(--text-primary);' : 'background-color: var(--bg-primary); box-shadow: 0 0 0 1px var(--border);'">
      <svg class="w-6 h-6 sm:w-7 sm:h-7 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        :style="swipeState.progress <= -1 || (isDesktop && hovered) ? 'color: var(--bg-primary);' : 'color: var(--text-primary);'">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
      </svg>
    </div>
  </div>


  <!-- Verse Actions Widget -->
  <div x-cloak x-show="verseActions.show && !(tts.playing || tts.paused)"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 translate-y-4"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-4"
    @click.away="if (!$event.target.closest('.verse-container')) hideVerseActions()"
    class="fixed bottom-20 left-1/2 -translate-x-1/2 z-[150] pointer-events-none w-[90%] max-w-[320px]">
    <div class="pointer-events-auto bg-black/85 backdrop-blur-md text-white rounded-2xl shadow-2xl overflow-hidden"
      @click.stop>

      <!-- Verse Reference Header -->
      <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between h-12">
        <span class="font-medium" x-text="verseActions.verse ? formatRef(verseActions.verse.ref) : ''"></span>
        <!-- Highlight indicator -->
        <div class="flex items-center gap-2 text-sm px-2 py-1 rounded-full"
          :class="(verseActions.verse && verseHighlights[verseActions.verse.ref] && highlightDefs[verseHighlights[verseActions.verse.ref]]) ? '' : 'invisible'"
          :style="verseActions.verse ? `background-color: ${getHighlightColor(verseActions.verse.ref)}cc; color: ${getHighlightTextColor(verseActions.verse.ref)};` : ''">
          <span x-text="verseActions.verse && highlightDefs[verseHighlights[verseActions.verse.ref]]?.name"></span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex">
        <button @click="openTitleModal()"
          class="flex-1 py-4 flex flex-col items-center gap-1 hover:bg-white/10 transition-colors active:scale-95">
          <span class="text-xl">ğŸ·ï¸</span>
          <span class="text-sm">æ¨™é¡Œ</span>
        </button>
        <button @click="openNoteModal()"
          class="flex-1 py-4 flex flex-col items-center gap-1 hover:bg-white/10 transition-colors active:scale-95">
          <span class="text-xl">ğŸ“</span>
          <span class="text-sm">ç­†è¨˜</span>
        </button>
        <button @click="openHighlightModal()"
          class="flex-1 py-4 flex flex-col items-center gap-1 hover:bg-white/10 transition-colors active:scale-95">
          <span class="text-xl">ğŸ¨</span>
          <span class="text-sm">æ¨™è¨»</span>
        </button>
        <button @click="toggleCompare()"
          :class="compareVerseRef === verseActions.verse?.ref ? 'bg-white/20' : ''"
          class="flex-1 py-4 flex flex-col items-center gap-1 hover:bg-white/10 transition-colors active:scale-95">
          <span class="text-xl">ğŸ“š</span>
          <span class="text-sm">å°ç…§</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Unified Verse Modal (Title/Note/Highlight) - Uses reusable drawer pattern -->
  <dialog x-ref="verseDialog"
    @close="verseModal.show = false"
    @click="if ($event.target === $el) $el.close()"
    class="drawer-dialog">
    <div class="drawer-panel-container">
      <div class="drawer-handle"></div>
      <div class="drawer-header">
        <h3 class="drawer-title" :style="`font-size: ${fontSize * 1.1}rem;`">
          <span x-text="verseModalConfig.icon"></span>
          <span x-text="verseModalConfig.label"></span>
          <span class="text-secondary font-normal" x-text="verseModal.verse ? ' - ' + formatRef(verseModal.verse.ref) : ''"></span>
        </h3>
        <button onclick="this.closest('dialog').close()" class="drawer-close-btn">
          <svg class="w-5 h-5 text-secondary"><use href="#icon-close"></use></svg>
        </button>
      </div>
      <!-- Verse Reference - scrollable, height for 2 lines -->
      <div x-show="verseModal.verse" class="flex-shrink-0 px-4 py-2 border-b overflow-y-auto scrollbar-thin"
        :style="`border-color: var(--border); background-color: var(--bg-secondary); max-height: calc(${fontSize * 2}rem * ${lineHeight} + 1.25rem);`">
        <p class="text-primary"
          :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
          x-html="verseModal.verse ? renderVerseText(verseModal.verse.text) : ''"></p>
      </div>

      <!-- Title Content -->
      <template x-if="verseModal.type === 'title'">
        <div class="drawer-content scrollbar-thin pt-4" :style="`font-size: ${fontSize}rem;`">
          <input type="text" x-model="verseModal.title" x-ref="titleInput" @keydown.enter="saveTitle()"
            @keydown.escape="$refs.verseDialog.close()" placeholder="è¼¸å…¥æ¨™é¡Œ..."
            :style="`font-size: ${fontSize}rem; font-family: ${currentFontFamily};`"
            class="w-full px-4 py-3 rounded-lg bg-secondary border border-custom text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-amber-600">
        </div>
      </template>

      <!-- Note Content -->
      <template x-if="verseModal.type === 'note'">
        <div class="drawer-content scrollbar-thin pt-4" :style="`font-size: ${fontSize}rem;`">
          <textarea x-model="verseModal.note" x-ref="noteInput" @keydown.escape="$refs.verseDialog.close()" placeholder="è¼¸å…¥ç­†è¨˜..."
            :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
            class="w-full px-4 py-3 rounded-lg bg-secondary border border-custom text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-amber-600 resize-none min-h-[80px]"></textarea>
        </div>
      </template>

      <!-- Highlight Content -->
      <template x-if="verseModal.type === 'highlight'">
        <div class="drawer-content scrollbar-thin pt-4" :style="`font-size: ${fontSize}rem;`">
          <!-- Highlight List -->
          <div class="space-y-2 mb-4">
            <template x-for="(def, id) in highlightDefs" :key="id">
              <div class="flex items-center gap-2">
                <!-- Edit Mode -->
                <template x-if="verseModal.editingId === id">
                  <div class="flex-1 flex items-center gap-2 p-2 rounded-lg bg-secondary">
                    <input type="color" x-model="verseModal.editColor" class="w-8 h-8 rounded cursor-pointer border-0">
                    <span contenteditable="true"
                      x-text="verseModal.editName"
                      @input="verseModal.editName = $el.innerText"
                      @keydown.enter.prevent="saveHighlightEdit(id)"
                      @keydown.escape="cancelHighlightEdit()"
                      class="flex-1 px-2 py-1 rounded bg-primary border border-custom text-primary text-sm focus:outline-none focus:ring-1 focus:ring-amber-600"
                      style="font-size: 16px; min-width: 60px;"></span>
                    <button @click="saveHighlightEdit(id)" class="p-1 text-green-600 hover:bg-green-100 dark:hover:bg-green-900/30 rounded" title="å„²å­˜">âœ“</button>
                    <button @click="cancelHighlightEdit()" class="p-1 text-secondary hover:bg-primary rounded" title="å–æ¶ˆ">âœ•</button>
                  </div>
                </template>
                <!-- View Mode -->
                <template x-if="verseModal.editingId !== id">
                  <div class="flex-1 flex items-center gap-2">
                    <button @click="selectHighlight(id)"
                      class="flex-1 flex items-center gap-3 p-3 rounded-lg border border-custom hover:bg-secondary transition-colors text-left"
                      :class="verseModal.selectedHighlightId === id ? 'ring-2 ring-amber-500' : ''">
                      <span class="w-6 h-6 rounded-full flex-shrink-0" :style="`background-color: ${def.color}`"></span>
                      <span class="font-medium text-primary" x-text="def.name"></span>
                      <span x-show="verseModal.selectedHighlightId === id" class="ml-auto text-amber-600 text-sm">âœ“ å·²é¸å–</span>
                    </button>
                    <button @click="startHighlightEdit(id)" class="p-2 text-secondary hover:bg-secondary rounded-lg transition-colors" title="ç·¨è¼¯">
                      âœï¸
                    </button>
                    <button x-show="Object.keys(highlightDefs).length > 1" @click="deleteHighlight(id)"
                      class="p-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors" title="åˆªé™¤">
                      ğŸ—‘ï¸
                    </button>
                  </div>
                </template>
              </div>
            </template>
          </div>

          <!-- Add New Highlight -->
          <button @click="addNewHighlight()"
            class="w-full flex items-center justify-center gap-2 p-3 rounded-lg border border-dashed border-custom hover:bg-secondary transition-colors text-secondary">
            <span>+</span>
            <span>æ–°å¢æ¨™è¨»</span>
          </button>
        </div>
      </template>

      <!-- Common Footer with Save/Cancel buttons (hidden for highlight type) -->
      <div x-show="verseModal.type !== 'highlight'" class="drawer-footer">
        <div class="flex justify-end gap-3">
          <button @click="$refs.verseDialog.close()"
            class="px-4 py-2 rounded-lg text-secondary hover:bg-secondary transition-colors">
            å–æ¶ˆ
          </button>
          <button @click="verseModal.type === 'title' ? saveTitle() : saveNote()"
            class="px-4 py-2 rounded-lg text-white transition-colors"
            style="background-color: var(--accent);">
            å„²å­˜
          </button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Strong's Number Definition Drawer (Bottom Sheet) - Uses reusable drawer pattern -->
  <dialog x-ref="snDialog"
    @close="snModal.show = false"
    @click="if ($event.target === $el) $el.close()"
    class="drawer-dialog">
    <div class="drawer-panel-container">
      <div class="drawer-handle"></div>
      <div class="drawer-header">
        <h3 class="drawer-title" :style="`font-size: ${fontSize * 1.1}rem;`">
          <span>ğŸ“–</span>
          <span x-text="snModal.code"></span>
        </h3>
        <button onclick="this.closest('dialog').close()" class="drawer-close-btn">
          <svg class="w-5 h-5 text-secondary"><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="drawer-content scrollbar-thin"
        :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`">
        <div x-show="snModal.loading" class="flex items-center justify-center py-8">
          <span class="animate-pulse text-2xl">â³</span>
        </div>
        <div x-show="!snModal.loading && snModal.definition"
          class="whitespace-pre-wrap text-primary"
          x-html="snModal.definition"></div>
        <div x-show="!snModal.loading && !snModal.definition" class="text-secondary text-center py-8">
          <span class="text-2xl block mb-2">â“</span>
          <p>æ‰¾ä¸åˆ°å®šç¾©</p>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Confirm Dialog Modal -->
  <div x-cloak x-show="confirmModal.show"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[250] bg-black/50 flex items-center justify-center" @click.self="confirmDialogCancel()">
    <div x-show="confirmModal.show"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 scale-100"
      x-transition:leave-end="opacity-0 scale-95"
      class="rounded-2xl shadow-2xl p-6 w-[90%] max-w-sm"
      style="background-color: var(--bg-primary);">
      <p class="text-primary mb-6" :style="`font-size: ${fontSize}rem;`" x-text="confirmModal.message"></p>
      <div class="flex justify-end gap-3">
        <button @click="confirmDialogCancel()"
          class="px-4 py-2 rounded-lg text-secondary hover:bg-secondary transition-colors">
          å–æ¶ˆ
        </button>
        <button @click="confirmDialogConfirm()"
          class="px-4 py-2 rounded-lg text-white transition-colors"
          style="background-color: var(--accent);">
          ç¢ºå®š
        </button>
      </div>
    </div>
  </div>

  <!-- Reading Adjustment Overlay Backdrop (click to dismiss) -->
  <div x-cloak x-show="readingOverlay.show"
    @click="hideReadingOverlay()"
    class="fixed inset-0 z-[149]"></div>

  <!-- Reading Adjustment Overlay -->
  <div x-cloak x-show="readingOverlay.show"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 translate-y-4"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-4"
    class="fixed bottom-20 left-1/2 -translate-x-1/2 z-[150] pointer-events-none w-[90%] max-w-[320px]">
    <div class="pointer-events-auto bg-black/85 backdrop-blur-md text-white rounded-2xl shadow-2xl overflow-hidden"
      @click.stop>

      <!-- Tab Selector -->
      <div class="flex border-b border-white/10">
        <button @click="switchOverlayTab(0)"
          :class="readingOverlay.activeTab === 0 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">A</span>å­—è™Ÿ
        </button>
        <button @click="switchOverlayTab(1)"
          :class="readingOverlay.activeTab === 1 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">â‰¡</span>è¡Œè·
        </button>
        <button @click="switchOverlayTab(2)"
          :class="readingOverlay.activeTab === 2 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">Â¶</span>æ®µè·
        </button>
        <button @click="switchOverlayTab(3)"
          :class="readingOverlay.activeTab === 3 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">å­—</span>å­—å‹
        </button>
        <button @click="switchOverlayTab(4)"
          :class="readingOverlay.activeTab === 4 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">ğŸ”</span>ç¸®æ”¾
        </button>
      </div>

      <!-- Control Area -->
      <div class="px-5 py-4">
        <!-- Font Size Control -->
        <div x-show="readingOverlay.activeTab === 0" class="flex items-center gap-4">
          <button @click="adjustFontSize(-0.05)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-sm font-medium">A</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="fontSize.toFixed(2) + ' rem'"></div>
          </div>
          <button @click="adjustFontSize(0.05)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-xl font-medium">A</span>
          </button>
        </div>

        <!-- Line Height Control -->
        <div x-show="readingOverlay.activeTab === 1" class="flex items-center gap-4">
          <button @click="adjustLineHeight(-0.1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg leading-none">â‰¡</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="lineHeight.toFixed(1)"></div>
          </div>
          <button @click="adjustLineHeight(0.1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95"
            style="letter-spacing: 3px;">
            <span class="text-lg leading-none">â‰¡</span>
          </button>
        </div>

        <!-- Verse Spacing Control -->
        <div x-show="readingOverlay.activeTab === 2" class="flex items-center gap-4">
          <button @click="adjustVerseSpacing(-2)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">âˆ’</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="verseSpacing + 'px'"></div>
          </div>
          <button @click="adjustVerseSpacing(2)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">+</span>
          </button>
        </div>

        <!-- Font Family Control -->
        <div x-show="readingOverlay.activeTab === 3" class="flex items-center gap-4">
          <button @click="adjustFontFamily(-1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">â—€</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-xl font-bold" x-text="currentFontFamilyName" :style="`font-family: ${currentFontFamily}`"></div>
          </div>
          <button @click="adjustFontFamily(1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">â–¶</span>
          </button>
        </div>

        <!-- Zoom Control -->
        <div x-show="readingOverlay.activeTab === 4" class="flex items-center gap-4">
          <button @click="adjustZoom(-5)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">âˆ’</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="zoom + '%'"></div>
          </div>
          <button @click="adjustZoom(5)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">+</span>
          </button>
        </div>

        <!-- Draggable Progress bar (hidden for font family tab) -->
        <div x-show="readingOverlay.activeTab !== 3"
          class="mt-4 h-6 flex items-center cursor-pointer touch-none"
          @mousedown="startSliderDrag($event)"
          @touchstart.prevent="startSliderDrag($event)">
          <div class="w-full h-2 bg-white/15 rounded-full overflow-hidden relative">
            <div class="h-full bg-white/70 rounded-full transition-all"
              :class="readingOverlay.isDragging ? 'duration-0' : 'duration-200'"
              :style="readingOverlay.activeTab === 0
                ? `width: ${((fontSize - 0.75) / 1.5) * 100}%`
                : readingOverlay.activeTab === 1
                  ? `width: ${((lineHeight - 1.0) / 2.0) * 100}%`
                  : readingOverlay.activeTab === 2
                    ? `width: ${(verseSpacing / 64) * 100}%`
                    : `width: ${((zoom - 50) / 100) * 100}%`">
            </div>
            <!-- Slider handle -->
            <div class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-md transition-all"
              :class="readingOverlay.isDragging ? 'scale-125 duration-0' : 'duration-200'"
              :style="readingOverlay.activeTab === 0
                ? `left: calc(${((fontSize - 0.75) / 1.5) * 100}% - 8px)`
                : readingOverlay.activeTab === 1
                  ? `left: calc(${((lineHeight - 1.0) / 2.0) * 100}% - 8px)`
                  : readingOverlay.activeTab === 2
                    ? `left: calc(${(verseSpacing / 64) * 100}% - 8px)`
                    : `left: calc(${((zoom - 50) / 100) * 100}% - 8px)`">
            </div>
          </div>
        </div>
        <!-- Font family indicator dots -->
        <div x-show="readingOverlay.activeTab === 3" class="mt-4 flex justify-center gap-2">
          <template x-for="(font, idx) in fontFamilies" :key="idx">
            <div class="w-2 h-2 rounded-full transition-colors"
              :class="fontFamily === idx ? 'bg-white' : 'bg-white/30'"></div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!--
    =====================================================================
    REUSABLE DRAWER PATTERN
    =====================================================================
    To create a new drawer, use the following template structure:

    <dialog x-ref="yourDialogRef"
      @close="yourModal.show = false"
      @click="if ($event.target === $el) $el.close()"
      class="drawer-dialog">
      <div class="drawer-panel-container">
        <div class="drawer-handle"></div>
        <div class="drawer-header">
          <h3 class="drawer-title" :style="`font-size: ${fontSize * 1.1}rem;`">
            <span>ğŸ”§</span>
            <span>Title</span>
          </h3>
          <button onclick="this.closest('dialog').close()" class="drawer-close-btn">
            <svg class="w-5 h-5 text-secondary"><use href="#icon-close"></use></svg>
          </button>
        </div>
        <div class="drawer-content scrollbar-thin" :style="`font-size: ${fontSize}rem;`">
          Your content here
        </div>
        <div class="drawer-footer">Optional footer</div>
      </div>
    </dialog>

    To open: this.$refs.yourDialogRef.showModal();
    To close: this.$refs.yourDialogRef.close();
    =====================================================================
  -->

  <!-- Settings Drawer (Bottom Sheet) - Uses reusable drawer pattern -->
  <dialog x-ref="settingsDialog"
    @close="settingsModal.show = false"
    @click="if ($event.target === $el) $el.close()"
    class="drawer-dialog">
    <div class="drawer-panel-container">
      <div class="drawer-handle"></div>
      <div class="drawer-header">
        <h3 class="drawer-title" :style="`font-size: ${fontSize * 1.1}rem;`">
          <span>âš™ï¸</span>
          <span>è¨­å®š</span>
        </h3>
        <button onclick="this.closest('dialog').close()" class="drawer-close-btn">
          <svg class="w-5 h-5 text-secondary"><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="drawer-content scrollbar-thin" :style="`font-size: ${fontSize}rem;`">
        <!-- Appearance Section -->
        <div class="space-y-3 mb-6">
          <h4 class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`">ğŸ¨ å¤–è§€</h4>

          <!-- Dark Mode Toggle -->
          <div class="flex items-center justify-between p-3 rounded-lg bg-primary border border-custom">
            <div class="flex items-center gap-3">
              <span x-text="isDark ? 'ğŸŒ™' : 'â˜€ï¸'"></span>
              <span class="text-primary">æ·±è‰²æ¨¡å¼</span>
            </div>
            <button @click="toggleDarkMode()"
              :class="isDark ? 'bg-amber-600' : 'bg-gray-400'"
              class="relative w-12 h-6 rounded-full transition-colors">
              <span :class="isDark ? 'translate-x-6' : 'translate-x-1'"
                class="absolute top-1 left-0 w-4 h-4 bg-white rounded-full transition-transform shadow"></span>
            </button>
          </div>

          <!-- Reading Display -->
          <button @click="showReadingOverlay()"
            class="w-full flex items-center justify-between p-3 rounded-lg bg-primary border border-custom hover:border-amber-600 transition-colors">
            <div class="flex items-center gap-3">
              <span>ğŸ“</span>
              <span class="text-primary">èª¿æ•´é¡¯ç¤º</span>
            </div>
            <div class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`">
              <span x-text="currentFontFamilyName"></span>
            </div>
          </button>

          <!-- Header Actions -->
          <button @click="openHeaderActionsModal()"
            class="w-full flex items-center justify-between p-3 rounded-lg bg-primary border border-custom hover:border-amber-600 transition-colors">
            <div class="flex items-center gap-3">
              <span>ğŸ”§</span>
              <span class="text-primary">å·¥å…·åˆ—æŒ‰éˆ•</span>
            </div>
            <div class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`">
              <span x-text="headerActions.filter(a => a.visible).length + '/' + headerActions.length + ' é¡¯ç¤º'"></span>
            </div>
          </button>
        </div>

        <!-- Data Sync Section -->
        <div class="space-y-3 mb-6">
          <h4 class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`">ğŸ“‚ è³‡æ–™å‚™ä»½</h4>

          <!-- Buttons row (when File System API supported) -->
          <div x-show="hasFileSystemAccess" class="grid grid-cols-3 gap-2">
            <!-- Save Button -->
            <button @click="saveToFile()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>ğŸ’¾</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">å„²å­˜</span>
            </button>

            <!-- Download Backup Button -->
            <button @click="downloadBackup()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>â¬‡ï¸</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">å»ºç«‹å‚™ä»½</span>
            </button>

            <!-- Open File Button -->
            <button @click="importData()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>ğŸ“‚</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">é–‹å•Ÿæª”æ¡ˆ</span>
            </button>
          </div>

          <!-- Buttons row (when File System API NOT supported) -->
          <div x-show="!hasFileSystemAccess" class="grid grid-cols-2 gap-2">
            <!-- Download Backup Button -->
            <button @click="downloadBackup()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>â¬‡ï¸</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">å»ºç«‹å‚™ä»½</span>
            </button>

            <!-- Open File Button -->
            <button @click="importData()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>ğŸ“‚</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">é–‹å•Ÿæª”æ¡ˆ</span>
            </button>
          </div>

          <!-- Auto-save checkbox with file info -->
          <div class="p-3 rounded-lg bg-primary border border-custom">
            <label class="flex items-center gap-3 cursor-pointer" :class="{ 'opacity-50 cursor-not-allowed': !hasFileSystemAccess }">
              <input type="checkbox" x-model="autoSync" @change="saveAutoSyncPreference()"
                :disabled="!hasFileSystemAccess"
                class="w-5 h-5 rounded border-gray-300 text-accent focus:ring-accent">
              <div class="flex-1">
                <p class="font-medium text-primary">è‡ªå‹•å„²å­˜</p>
                <p class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`" x-text="fileHandle ? 'å·²é¸æ“‡ï¼š' + fileHandle.name : (hasFileSystemAccess ? 'å°šæœªé¸æ“‡æª”æ¡ˆ' : 'ç€è¦½å™¨ä¸æ”¯æ´æª”æ¡ˆç³»çµ± API')"></p>
              </div>
            </label>
            <!-- Re-select file button -->
            <button x-show="hasFileSystemAccess && fileHandle" @click="reselectFile()" :disabled="settingsModal.isBusy"
              class="mt-2 w-full text-accent hover:underline disabled:opacity-50" :style="`font-size: ${fontSize * 0.85}rem;`">
              é‡æ–°ç¶å®š ZIP æª”æ¡ˆ
            </button>
          </div>
        </div>

        <!-- Status Message -->
        <div x-show="settingsModal.message" class="mb-4 p-3 rounded-lg"
          :class="settingsModal.isError ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'">
          <p :style="`font-size: ${fontSize * 0.85}rem;`" x-text="settingsModal.message"></p>
        </div>

        <!-- Cache Section -->
        <div class="space-y-3 mb-6">
          <h4 class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`">ğŸ—„ï¸ å¿«å–ç®¡ç†</h4>
          <button @click="clearAllVersions()" x-show="cachedVersions.length > 1"
            class="w-full text-red-500 hover:text-red-600 p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors border border-red-200 dark:border-red-800"
            :style="`font-size: ${fontSize * 0.85}rem;`">
            æ¸…é™¤æ‰€æœ‰å¿«å–ï¼ˆä¿ç•™ç›®å‰ä½¿ç”¨ä¸­çš„è­¯æœ¬ï¼‰
          </button>
          <p x-show="cachedVersions.length <= 1" class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`">ç›®å‰ç„¡é¡å¤–å¿«å–å¯æ¸…é™¤</p>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Reading History Drawer (Bottom Sheet) - Uses reusable drawer pattern -->
  <dialog x-ref="historyDialog"
    @close="historyModal.show = false"
    @click="if ($event.target === $el) $el.close()"
    class="drawer-dialog">
    <div class="drawer-panel-container">
      <div class="drawer-handle"></div>
      <div class="drawer-header">
        <h3 class="drawer-title" :style="`font-size: ${fontSize * 1.1}rem;`">
          <span>ğŸ•</span>
          <span>é–±è®€ç´€éŒ„</span>
        </h3>
        <button onclick="this.closest('dialog').close()" class="drawer-close-btn">
          <svg class="w-5 h-5 text-secondary"><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="drawer-content scrollbar-thin" :style="`font-size: ${fontSize}rem;`">
        <!-- Empty State -->
        <div x-show="readingHistory.length === 0" class="flex flex-col items-center justify-center py-12 text-secondary">
          <span class="text-4xl mb-4">ğŸ“š</span>
          <p>å°šç„¡é–±è®€ç´€éŒ„</p>
          <p class="text-sm mt-1 opacity-70">é–±è®€ç¶“æ–‡æ™‚æœƒè‡ªå‹•è¨˜éŒ„</p>
        </div>
        <!-- History List -->
        <div x-show="readingHistory.length > 0" class="space-y-2">
          <template x-for="(item, index) in readingHistory" :key="'history-' + index">
            <div class="p-3 rounded-lg border border-custom hover:border-accent-light hover:bg-secondary/50 transition-colors cursor-pointer"
              @click="goToHistoryItem(item)">
              <div class="font-medium text-primary truncate" x-text="getBookName(item.bookCode) + ' ç¬¬ ' + item.chapter + ' ç« '"></div>
              <div class="text-secondary text-sm" :style="`font-size: ${fontSize * 0.8}rem;`" x-text="formatHistoryTime(item.timestamp)"></div>
            </div>
          </template>
        </div>
      </div>
      <!-- Footer -->
      <div x-show="readingHistory.length > 0" class="drawer-footer">
        <p class="text-secondary text-center" :style="`font-size: ${fontSize * 0.85}rem;`">å…± <span x-text="readingHistory.length"></span> ç­†ç´€éŒ„ï¼ˆæœ€å¤šä¿ç•™ 50 ç­†ï¼‰</p>
      </div>
    </div>
  </dialog>

  <!-- Header Actions Editor Modal (Bottom Sheet) - Uses reusable drawer pattern -->
  <dialog x-ref="headerActionsDialog"
    @close="headerActionsModal.show = false"
    @click="if ($event.target === $el) $el.close()"
    class="drawer-dialog">
    <div class="drawer-panel-container">
      <div class="drawer-handle"></div>
      <div class="drawer-header">
        <h3 class="drawer-title" :style="`font-size: ${fontSize * 1.1}rem;`">
          <span>ğŸ”§</span>
          <span>å·¥å…·åˆ—æŒ‰éˆ•</span>
        </h3>
        <button onclick="this.closest('dialog').close()" class="drawer-close-btn">
          <svg class="w-5 h-5 text-secondary"><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="drawer-content scrollbar-thin" :style="`font-size: ${fontSize}rem;`">
        <p class="text-secondary mb-4" :style="`font-size: ${fontSize * 0.85}rem;`">æ‹–æ›³èª¿æ•´é †åºï¼Œé»æ“Šåˆ‡æ›é¡¯ç¤º/éš±è—ã€‚éš±è—çš„æŒ‰éˆ•æœƒé¡¯ç¤ºåœ¨ã€Œâ‹®ã€é¸å–®ä¸­ã€‚</p>
        <!-- Actions List -->
        <div class="space-y-2">
          <template x-for="action in headerActions" :key="'edit-action-' + action.id">
            <div
              class="flex items-center gap-3 p-3 rounded-lg border transition-all cursor-move"
              :class="headerActionsModal.draggedId === action.id ? 'border-accent bg-accent/10 scale-[1.02]' : (action.visible ? 'border-accent-light bg-secondary/30' : 'border-custom bg-primary')"
              draggable="true"
              @dragstart="startHeaderActionDrag(action.id)"
              @dragover="handleHeaderActionDragOver($event, action.id)"
              @dragend="endHeaderActionDrag()"
              @touchstart="startHeaderActionDrag(action.id)"
              @touchend="endHeaderActionDrag()">
              <!-- Drag Handle -->
              <div class="text-secondary cursor-grab active:cursor-grabbing">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                </svg>
              </div>
              <!-- Icon -->
              <div class="w-8 h-8 rounded-full flex items-center justify-center"
                :class="action.visible ? 'bg-accent/20 text-accent' : 'bg-secondary text-secondary'">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" x-html="getHeaderActionIcon(action.id)"></svg>
              </div>
              <!-- Name -->
              <div class="flex-1">
                <span class="font-medium" :class="action.visible ? 'text-primary' : 'text-secondary'" x-text="action.name"></span>
              </div>
              <!-- Visibility Toggle -->
              <button @click="toggleHeaderActionVisibility(action.id)"
                class="p-2 rounded-lg transition-colors"
                :class="action.visible ? 'text-accent hover:bg-accent/20' : 'text-secondary hover:bg-secondary'">
                <svg x-show="action.visible" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                <svg x-show="!action.visible" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                </svg>
              </button>
            </div>
          </template>
        </div>
      </div>
      <div class="drawer-footer">
        <p class="text-secondary text-center" :style="`font-size: ${fontSize * 0.85}rem;`">
          <span x-text="headerActions.filter(a => a.visible).length"></span> å€‹æŒ‰éˆ•é¡¯ç¤ºæ–¼å·¥å…·åˆ—
        </p>
      </div>
    </div>
  </dialog>

  <!-- Navigation Drawer (Book & Chapter Selection) - Uses reusable drawer pattern -->
  <dialog x-ref="navDialog"
    @close="navModal.show = false"
    @click="if ($event.target === $el) applyNavSelection()"
    class="drawer-dialog">
    <div class="drawer-panel-container">
      <div class="drawer-handle"></div>
      <!-- Custom Header with Tabs (instead of standard drawer-header) -->
      <div class="flex items-center justify-between px-4 pb-2 border-b" style="border-color: var(--border);">
        <div class="flex gap-1 flex-1">
          <button @click="navModal.tab = 'books'"
            :class="navModal.tab === 'books' ? 'text-accent' : 'text-secondary hover:text-primary'"
            class="flex-1 py-2 flex items-center justify-center gap-2 font-medium transition-colors border-b-2"
            :style="`font-size: ${fontSize}rem; ` + (navModal.tab === 'books' ? 'border-color: var(--accent)' : 'border-color: transparent')">
            <span>ğŸ“š</span>
            <span>æ›¸å·ç›®éŒ„</span>
          </button>
          <button @click="navModal.tab = 'chapters'"
            :class="navModal.tab === 'chapters' ? 'text-accent' : 'text-secondary hover:text-primary'"
            class="flex-1 py-2 flex items-center justify-center gap-2 font-medium transition-colors border-b-2"
            :style="`font-size: ${fontSize}rem; ` + (navModal.tab === 'chapters' ? 'border-color: var(--accent)' : 'border-color: transparent')">
            <span>ğŸ“–</span>
            <span x-text="getBookName(navModal.pendingBook || selectedBook)"></span>
          </button>
        </div>
        <button onclick="applyNavSelection(); this.closest('dialog').close()" class="drawer-close-btn ml-2">
          <svg class="w-5 h-5 text-secondary"><use href="#icon-close"></use></svg>
        </button>
      </div>

      <!-- Content -->
      <div class="flex-1 overflow-hidden flex flex-col p-4">
        <!-- Book Selection Tab -->
        <div x-show="navModal.tab === 'books'" class="flex-1 overflow-hidden flex flex-col">
          <!-- Testament Toggle -->
          <div class="flex rounded-lg border border-custom overflow-hidden mb-3">
            <button @click="navModal.testament = 'old'; navModal.category = bookCategoriesOT[0].id"
              :class="navModal.testament === 'old' ? 'bg-secondary text-primary' : 'bg-primary text-secondary hover:bg-secondary/50'"
              class="flex-1 py-2.5 text-center font-medium transition-colors"
              :style="`font-size: ${fontSize}rem;`">
              èˆŠç´„
            </button>
            <button @click="navModal.testament = 'new'; navModal.category = bookCategoriesNT[0].id"
              :class="navModal.testament === 'new' ? 'bg-secondary text-primary' : 'bg-primary text-secondary hover:bg-secondary/50'"
              class="flex-1 py-2.5 text-center font-medium transition-colors"
              :style="`font-size: ${fontSize}rem;`">
              æ–°ç´„
            </button>
          </div>

          <!-- Category Pills -->
          <div class="flex flex-wrap gap-2 mb-3">
            <template x-for="cat in (navModal.testament === 'old' ? bookCategoriesOT : bookCategoriesNT)" :key="cat.id">
              <button @click="navModal.category = cat.id"
                :class="navModal.category === cat.id ? 'bg-accent text-white' : 'bg-primary text-secondary border border-custom hover:border-accent'"
                class="px-3 py-1.5 rounded-full font-medium transition-colors"
                :style="`font-size: ${fontSize * 0.85}rem;`"
                x-text="cat.name"></button>
            </template>
          </div>

          <!-- Book Grid -->
          <div class="flex-1 overflow-y-auto scrollbar-thin -mx-1.5 px-1.5">
            <div class="grid grid-cols-2 gap-2">
              <template x-for="bookCode in getFilteredBooks()" :key="'nav-book-' + bookCode">
                <button @click="navModal.pendingBook = bookCode; navModal.pendingChapter = getFirstChapterForBook(bookCode); navModal.tab = 'chapters'"
                  class="flex items-center justify-between p-3 rounded-lg bg-primary border border-custom hover:bg-secondary transition-colors text-left">
                  <span class="font-medium text-primary" :style="`font-size: ${fontSize}rem;`" x-text="getBookName(bookCode)"></span>
                  <div class="flex items-center gap-2">
                    <span x-show="(navModal.pendingBook || selectedBook) === bookCode" class="w-2 h-2 rounded-full bg-accent"></span>
                    <span class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`">â†’</span>
                  </div>
                </button>
              </template>
            </div>
          </div>
        </div>

        <!-- Chapter Selection Tab -->
        <div x-show="navModal.tab === 'chapters'" class="flex-1 overflow-hidden flex flex-col">
          <!-- Current Selection -->
          <div class="mb-3">
            <p class="text-accent font-medium mb-1" :style="`font-size: ${fontSize * 0.85}rem;`">ğŸ“– é¸æ“‡ç« ç¯€</p>
            <p class="font-bold text-primary" :style="`font-size: ${fontSize * 1.15}rem;`">
              <span x-text="getBookName(navModal.pendingBook || selectedBook)"></span>
              <template x-if="navModal.pendingChapter || (!navModal.pendingBook && selectedChapter)">
                <span>
                  <span class="text-secondary font-normal"> / </span>
                  <span>ç¬¬ <span x-text="navModal.pendingChapter || selectedChapter"></span> ç« </span>
                </span>
              </template>
            </p>
          </div>

          <!-- Chapter Grid -->
          <div x-ref="chapterGrid" class="flex-1 overflow-y-auto scrollbar-thin -mx-1.5 px-1.5">
            <div class="grid grid-cols-5 gap-2">
              <template x-for="chapter in getChaptersForPendingBook()" :key="'nav-ch-' + chapter">
                <button @click="navModal.pendingChapter = chapter; applyNavSelection()"
                  :class="getNavChapterClass(chapter)"
                  class="aspect-square rounded-lg flex items-center justify-center font-medium transition-all"
                  :style="`font-size: ${fontSize * 1.1}rem;`"
                  x-text="chapter"></button>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Version Selector Drawer (Bottom Sheet) - Uses reusable drawer pattern -->
  <dialog x-ref="versionDialog"
    @close="versionModal.show = false"
    @click="if ($event.target === $el) $el.close()"
    class="drawer-dialog">
    <div class="drawer-panel-container">
      <div class="drawer-handle"></div>
      <div class="drawer-header">
        <h3 class="drawer-title" :style="`font-size: ${fontSize * 1.1}rem;`">
          <span>ğŸ“š</span>
          <span>é¸æ“‡è­¯æœ¬</span>
        </h3>
        <button onclick="this.closest('dialog').close()" class="drawer-close-btn">
          <svg class="w-5 h-5 text-secondary"><use href="#icon-close"></use></svg>
        </button>
      </div>
      <!-- Custom Tab Switcher (instead of standard drawer-header) -->
      <div class="flex border-b px-4" style="border-color: var(--border);">
        <button @click="versionModal.tab = 'select'"
          :class="versionModal.tab === 'select' ? 'border-b-2 border-amber-600 text-accent' : 'text-secondary'"
          class="flex-1 py-2.5 text-center font-medium transition-colors"
          :style="`font-size: ${fontSize * 0.9}rem;`">
          è­¯æœ¬é¸æ“‡
        </button>
        <button @click="versionModal.tab = 'compare'"
          :class="versionModal.tab === 'compare' ? 'border-b-2 border-amber-600 text-accent' : 'text-secondary'"
          class="flex-1 py-2.5 text-center font-medium transition-colors"
          :style="`font-size: ${fontSize * 0.9}rem;`">
          å°ç…§è¨­å®š
        </button>
      </div>
      <div class="drawer-content scrollbar-thin" :style="`font-size: ${fontSize}rem;`">
        <!-- Content: Select Tab -->
        <div x-show="versionModal.tab === 'select'" class="p-4 pt-0">
          <div class="space-y-2">
            <template x-for="version in availableVersions" :key="version.id">
              <div class="p-3 rounded-lg border border-custom transition-colors"
                :class="selectedVersionId === version.id ? 'bg-primary border-amber-600' : 'hover:bg-primary'">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="font-medium text-primary" :style="`font-size: ${fontSize}rem;`" x-text="version.name"></span>
                      <span class="px-1.5 py-0.5 rounded text-xs"
                        :style="`font-size: ${fontSize * 0.7}rem; background-color: var(--bg-secondary); color: var(--text-secondary);`"
                        x-text="version.lang"></span>
                      <template x-if="selectedVersionId === version.id">
                        <span class="px-1.5 py-0.5 rounded bg-amber-600 text-white"
                          :style="`font-size: ${fontSize * 0.75}rem;`">ä½¿ç”¨ä¸­</span>
                      </template>
                      <template x-if="isVersionCached(version.id) && selectedVersionId !== version.id">
                        <span class="px-1.5 py-0.5 rounded bg-green-600 text-white"
                          :style="`font-size: ${fontSize * 0.75}rem;`">å·²ä¸‹è¼‰</span>
                      </template>
                    </div>
                    <p class="text-secondary mt-0.5" :style="`font-size: ${fontSize * 0.85}rem;`" x-text="version.size"></p>
                  </div>
                  <div class="flex items-center gap-2">
                    <!-- Delete button for cached versions (not currently selected) -->
                    <button x-show="isVersionCached(version.id) && selectedVersionId !== version.id"
                      @click="deleteVersion(version.id)"
                      class="p-1.5 rounded-lg text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors"
                      title="åˆªé™¤å¿«å–">
                      <span :style="`font-size: ${fontSize * 0.85}rem;`">ğŸ—‘ï¸</span>
                    </button>
                    <!-- Select/Download button -->
                    <button @click="isVersionCached(version.id) ? selectVersion(version.id) : downloadVersionOnly(version.id)"
                      :disabled="versionModal.downloading === version.id || selectedVersionId === version.id"
                      class="px-3 py-1.5 rounded-lg transition-colors disabled:opacity-50"
                      :class="selectedVersionId === version.id ? 'bg-secondary text-secondary cursor-default' : 'text-white'"
                      :style="`font-size: ${fontSize * 0.85}rem; ` + (selectedVersionId !== version.id ? 'background-color: var(--accent);' : '')">
                      <span x-show="versionModal.downloading === version.id" class="flex items-center gap-1">
                        <span class="animate-spin">â³</span> ä¸‹è¼‰ä¸­...
                      </span>
                      <span x-show="versionModal.downloading !== version.id">
                        <span x-text="selectedVersionId === version.id ? 'ä½¿ç”¨ä¸­' : (isVersionCached(version.id) ? 'åˆ‡æ›' : 'ä¸‹è¼‰')"></span>
                      </span>
                    </button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
        <!-- Content: Compare Tab -->
        <div x-show="versionModal.tab === 'compare'" class="p-4 pt-0">
          <p class="text-secondary mb-3" :style="`font-size: ${fontSize * 0.85}rem;`">
            é¸æ“‡ä¸¦å•Ÿç”¨å°ç…§çš„è­¯æœ¬ï¼Œä¸¦æ‹–æ›³èª¿æ•´é¡¯ç¤ºé †åº
          </p>
          <!-- Enabled versions (reorderable) -->
          <div x-show="compareVersionOrder.length > 0" class="mb-4">
            <h4 class="font-medium text-accent mb-2" :style="`font-size: ${fontSize * 0.9}rem;`">å·²å•Ÿç”¨ (<span x-text="compareVersionOrder.length"></span>)</h4>
            <div class="space-y-1.5">
              <template x-for="(versionId, idx) in compareVersionOrder" :key="'enabled-' + versionId">
                <div class="p-2.5 rounded-lg border transition-all flex items-center gap-2"
                  :class="versionModal.draggedVersionId === versionId ? 'border-amber-600 bg-primary opacity-50' : 'border-custom hover:border-accent-light'"
                  draggable="true"
                  @dragstart="versionModal.draggedVersionId = versionId"
                  @dragend="versionModal.draggedVersionId = null"
                  @dragover.prevent
                  @drop.prevent="reorderCompareVersion(versionId, idx)">
                  <!-- Drag handle -->
                  <span class="cursor-move text-secondary select-none" style="touch-action: none;">â ¿</span>
                  <!-- Version info -->
                  <div class="flex-1 flex items-center gap-2 flex-wrap">
                    <span class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`"
                      x-text="availableVersions.find(v => v.id === versionId)?.name || versionId"></span>
                    <span class="px-1.5 py-0.5 rounded text-xs"
                      :style="`font-size: ${fontSize * 0.7}rem; background-color: var(--bg-secondary); color: var(--text-secondary);`"
                      x-text="availableVersions.find(v => v.id === versionId)?.lang"></span>
                  </div>
                  <!-- Move buttons for touch devices -->
                  <button @click="moveCompareVersion(idx, -1)" :disabled="idx === 0"
                    class="p-1 rounded hover:bg-secondary disabled:opacity-30 text-secondary transition-colors" title="ä¸Šç§»">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                  </button>
                  <button @click="moveCompareVersion(idx, 1)" :disabled="idx === compareVersionOrder.length - 1"
                    class="p-1 rounded hover:bg-secondary disabled:opacity-30 text-secondary transition-colors" title="ä¸‹ç§»">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </button>
                  <!-- Toggle off -->
                  <button @click="toggleCompareVersion(versionId)"
                    class="p-1.5 rounded-lg transition-colors text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30" title="ç§»é™¤">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
              </template>
            </div>
          </div>
          <!-- Available cached versions to add -->
          <div x-show="getAvailableCompareVersions().length > 0">
            <h4 class="font-medium text-secondary mb-2" :style="`font-size: ${fontSize * 0.9}rem;`">å¯åŠ å…¥å°ç…§</h4>
            <div class="space-y-1.5">
              <template x-for="version in getAvailableCompareVersions()" :key="'available-' + version.id">
                <div class="p-2.5 rounded-lg border border-custom hover:border-accent-light transition-colors flex items-center gap-2">
                  <div class="flex-1 flex items-center gap-2 flex-wrap">
                    <span class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`" x-text="version.name"></span>
                    <span class="px-1.5 py-0.5 rounded text-xs"
                      :style="`font-size: ${fontSize * 0.7}rem; background-color: var(--bg-secondary); color: var(--text-secondary);`"
                      x-text="version.lang"></span>
                  </div>
                  <button @click="toggleCompareVersion(version.id)"
                    class="p-1.5 rounded-lg transition-colors text-green-600 hover:bg-green-100 dark:hover:bg-green-900/30" title="åŠ å…¥å°ç…§">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                  </button>
                </div>
              </template>
            </div>
          </div>
          <!-- No cached versions message -->
          <div x-show="cachedVersions.length <= 1" class="text-center py-8">
            <span class="text-4xl mb-3 block">ğŸ“¥</span>
            <p class="text-secondary" :style="`font-size: ${fontSize * 0.9}rem;`">
              è«‹å…ˆåœ¨ã€Œè­¯æœ¬é¸æ“‡ã€é ç±¤ä¸‹è¼‰å…¶ä»–è­¯æœ¬
            </p>
          </div>
        </div>
      </div>
      <!-- Footer -->
      <div class="drawer-footer">
        <p class="text-secondary text-center" :style="`font-size: ${fontSize * 0.85}rem;`">å·²å¿«å– <span x-text="cachedVersions.length"></span> å€‹è­¯æœ¬</p>
      </div>
    </div>
  </dialog>


    <div id="pwa-toast" role="alert" aria-labelledby="toast-message"
      class="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-secondary border border-custom rounded-xl p-4 shadow-lg z-[300] hidden">
      <div class="flex items-start gap-3">
        <span class="text-2xl">ğŸ”„</span>
        <div class="flex-1">
          <p id="toast-message" class="text-primary font-medium"></p>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="pwa-close" type="button"
          class="px-4 py-2 rounded-lg text-secondary hover:bg-primary transition-colors text-sm">
          Close
        </button>
        <button id="pwa-refresh" type="button"
          class="px-4 py-2 rounded-lg text-white transition-colors text-sm"
          style="background-color: var(--accent);">
          Reload
        </button>
      </div>
    </div>


  </div>



  <script>
    // Canonical book codes in order
    const BOOK_CODES = [
      'GEN', 'EXO', 'LEV', 'NUM', 'DEU', 'JOS', 'JUG', 'RUT', 'SA1', 'SA2',
      'KI1', 'KI2', 'CH1', 'CH2', 'EZR', 'NEH', 'EST', 'JOB', 'PSM', 'PRO',
      'ECC', 'SON', 'ISA', 'JER', 'LAM', 'EZE', 'DAN', 'HOS', 'JOE', 'AMO',
      'OBA', 'JON', 'MIC', 'NAH', 'HAB', 'ZEP', 'HAG', 'ZEC', 'MAL',
      'MAT', 'MAK', 'LUK', 'JHN', 'ACT', 'ROM', 'CO1', 'CO2', 'GAL', 'EPH',
      'PHL', 'COL', 'TS1', 'TS2', 'TI1', 'TI2', 'TIT', 'PHM', 'HEB', 'JAS',
      'PE1', 'PE2', 'JN1', 'JN2', 'JN3', 'JUD', 'REV'
    ];

    // Book code to display name mapping (for current language)
    const BOOK_NAMES = {
      // Old Testament
      'GEN': 'å‰µä¸–è¨˜', 'EXO': 'å‡ºåŸƒåŠè¨˜', 'LEV': 'åˆ©æœªè¨˜', 'NUM': 'æ°‘æ•¸è¨˜', 'DEU': 'ç”³å‘½è¨˜',
      'JOS': 'ç´„æ›¸äºè¨˜', 'JUG': 'å£«å¸«è¨˜', 'RUT': 'è·¯å¾—è¨˜', 'SA1': 'æ’’æ¯è€³è¨˜ä¸Š', 'SA2': 'æ’’æ¯è€³è¨˜ä¸‹',
      'KI1': 'åˆ—ç‹ç´€ä¸Š', 'KI2': 'åˆ—ç‹ç´€ä¸‹', 'CH1': 'æ­·ä»£å¿—ä¸Š', 'CH2': 'æ­·ä»£å¿—ä¸‹',
      'EZR': 'ä»¥æ–¯æ‹‰è¨˜', 'NEH': 'å°¼å¸Œç±³è¨˜', 'EST': 'ä»¥æ–¯å¸–è¨˜', 'JOB': 'ç´„ä¼¯è¨˜', 'PSM': 'è©©ç¯‡',
      'PRO': 'ç®´è¨€', 'ECC': 'å‚³é“æ›¸', 'SON': 'é›…æ­Œ', 'ISA': 'ä»¥è³½äºæ›¸', 'JER': 'è€¶åˆ©ç±³æ›¸',
      'LAM': 'è€¶åˆ©ç±³å“€æ­Œ', 'EZE': 'ä»¥è¥¿çµæ›¸', 'DAN': 'ä½†ä»¥ç†æ›¸', 'HOS': 'ä½•è¥¿é˜¿æ›¸',
      'JOE': 'ç´„ç¥æ›¸', 'AMO': 'é˜¿æ‘©å¸æ›¸', 'OBA': 'ï¿½ï¿½ï¿½å·´åº•äºæ›¸', 'JON': 'ç´„æ‹¿æ›¸', 'MIC': 'å½Œè¿¦æ›¸',
      'NAH': 'é‚£é´»æ›¸', 'HAB': 'å“ˆå·´è°·æ›¸', 'ZEP': 'è¥¿ç•ªé›…æ›¸', 'HAG': 'å“ˆè©²æ›¸', 'ZEC': 'æ’’è¿¦åˆ©äºæ›¸', 'MAL': 'ç‘ªæ‹‰åŸºæ›¸',
      // New Testament
      'MAT': 'é¦¬å¤ªç¦éŸ³', 'MAK': 'é¦¬å¯ç¦éŸ³', 'LUK': 'è·¯åŠ ç¦éŸ³', 'JHN': 'ç´„ç¿°ç¦éŸ³', 'ACT': 'ä½¿å¾’è¡Œå‚³',
      'ROM': 'ç¾…é¦¬æ›¸', 'CO1': 'å“¥æ—å¤šå‰æ›¸', 'CO2': 'å“¥æ—å¤šå¾Œæ›¸', 'GAL': 'åŠ æ‹‰å¤ªæ›¸', 'EPH': 'ä»¥å¼—æ‰€æ›¸',
      'PHL': 'è…“ç«‹æ¯”æ›¸', 'COL': 'æ­Œç¾…è¥¿æ›¸', 'TS1': 'å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸', 'TS2': 'å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸',
      'TI1': 'ææ‘©å¤ªå‰æ›¸', 'TI2': 'ææ‘©å¤ªå¾Œæ›¸', 'TIT': 'æå¤šæ›¸', 'PHM': 'è…“åˆ©é–€æ›¸', 'HEB': 'å¸Œä¼¯ä¾†æ›¸',
      'JAS': 'é›…å„æ›¸', 'PE1': 'å½¼å¾—å‰æ›¸', 'PE2': 'å½¼å¾—å¾Œæ›¸', 'JN1': 'ç´„ç¿°ä¸€æ›¸', 'JN2': 'ç´„ç¿°äºŒæ›¸',
      'JN3': 'ç´„ç¿°ä¸‰æ›¸', 'JUD': 'çŒ¶å¤§æ›¸', 'REV': 'å•Ÿç¤ºéŒ„'
    };

    // Map alternate/legacy book codes to canonical codes
    const CODE_ALIASES = {
      // Old format codes
      'JDG': 'JUG', 'PSA': 'PSM', 'SNG': 'SON', 'EZK': 'EZE', 'JOL': 'JOE',
      'MRK': 'MAK', 'PHP': 'PHL', '1TH': 'TS1', '2TH': 'TS2',
      // Number prefix format (1SA -> SA1)
      '1SA': 'SA1', '2SA': 'SA2', '1KI': 'KI1', '2KI': 'KI2',
      '1CH': 'CH1', '2CH': 'CH2', '1CO': 'CO1', '2CO': 'CO2',
      '1TI': 'TI1', '2TI': 'TI2', '1PE': 'PE1', '2PE': 'PE2',
      '1JN': 'JN1', '2JN': 'JN2', '3JN': 'JN3',
      // Other alternate codes
      'SOL': 'SON', 'SOS': 'SON', 'NAM': 'NAH', 'ZPH': 'ZEP',
      'MK': 'MAK', 'JN': 'JHN', 'PHI': 'PHL',
      '1THS': 'TS1', '2THS': 'TS2', '1TIM': 'TI1', '2TIM': 'TI2',
      'PHILE': 'PHM', '1PET': 'PE1', '2PET': 'PE2',
      // TH variants
      'TH1': 'TS1', 'TH2': 'TS2'
    };

    // Normalize any book code to canonical form
    function normalizeBookCode(code) {
      return CODE_ALIASES[code] || code;
    }

    // Get display name for a book code
    function getBookName(code) {
      const normalized = normalizeBookCode(code);
      return BOOK_NAMES[normalized] || code;
    }

    // Reverse lookup: get book code from display name (for backward compatibility)
    const NAME_TO_CODE = Object.fromEntries(
      Object.entries(BOOK_NAMES).map(([code, name]) => [name, code])
    );
    function getBookCode(nameOrCode) {
      // If it's already a valid code, return normalized version
      const normalized = normalizeBookCode(nameOrCode);
      if (BOOK_NAMES[normalized]) return normalized;
      // Try reverse lookup from name
      return NAME_TO_CODE[nameOrCode] || nameOrCode;
    }

    // Available Bible versions
    const BIBLE_VERSIONS = [
      { id: 'zh-rTW_CUV', file: 'zh-rTW_CUV.txt', name: 'å’Œåˆæœ¬', lang: 'ç¹é«”ä¸­æ–‡', size: '3.6 MB' },
      { id: 'zh-rTW_CUV-SN', file: 'zh-rTW_CUV-SN.txt', name: 'å’Œåˆæœ¬ (å«åŸæ–‡ç·¨è™Ÿ)', lang: 'ç¹é«”ä¸­æ–‡', size: '6.7 MB' },
      { id: 'zh-rTW_CNV', file: 'zh-rTW_CNV.txt', name: 'æ–°è­¯æœ¬', lang: 'ç¹é«”ä¸­æ–‡', size: '3.9 MB' },
      { id: 'zh-rTW_LCC', file: 'zh-rTW_LCC.txt', name: 'å‘‚æŒ¯ä¸­è­¯æœ¬', lang: 'ç¹é«”ä¸­æ–‡', size: '4.0 MB' },
      { id: 'en_KJV-SN', file: 'en_KJV-SN.txt', name: 'King James (Strong\'s)', lang: 'English', size: '7.4 MB' },
      { id: 'en_ASV', file: 'en_ASV.txt', name: 'American Standard', lang: 'English', size: '4.4 MB' },
      { id: 'en_WEB', file: 'en_WEB.txt', name: 'World English Bible', lang: 'English', size: '4.3 MB' },
      { id: 'en_BBE', file: 'en_BBE.txt', name: 'Bible in Basic English', lang: 'English', size: '4.4 MB' },
      { id: 'en_YLT', file: 'en_YLT.txt', name: 'Young\'s Literal', lang: 'English', size: '4.4 MB' },
      { id: 'el_Septuaginta', file: 'el_Septuaginta.txt', name: 'Septuaginta', lang: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬', size: '5.4 MB' },
      { id: 'iw_ModernHebrew', file: 'iw_ModernHebrew.txt', name: 'Modern Hebrew', lang: '×¢ï¿½ï¿½×¨×™×ª', size: '4.0 MB' }
    ];

    function bibleReader() {
      return {
        isDark: false,
        allVerses: [],
        books: [],
        chapters: [],
        selectedBook: '',
        selectedChapter: 1,
        currentVerses: [],
        searchQuery: '',
        searchResults: [],
        headerSearchOpen: false,
        totalVerses: 0,
        bibleData: {},
        sourceTitles: {},  // { [verseRef]: title } - pre-existing titles from source text
        customTitles: {},
        notes: {},
        // Highlight system
        highlightDefs: {
          'h1': { name: 'é‡é»', color: '#fef08a' },
          'h2': { name: 'ç¶“æ–‡', color: '#bbf7d0' },
          'h3': { name: 'æ‡‰ç”¨', color: '#fecaca' }
        },
        verseHighlights: {},  // { [verseRef]: highlightId }
        isLoading: false,
        loadingMessage: '',
        loadingSubMessage: '',
        // Version management
        availableVersions: BIBLE_VERSIONS,
        selectedVersionId: 'zh-rTW_CUV',
        cachedVersions: [],
        versionModal: {
          show: false,
          downloading: null,
          tab: 'select', // 'select' or 'compare'
          draggedVersionId: null
        },
        compareVersionOrder: [], // ordered list of version IDs enabled for comparison
        navModal: {
          show: false,
          tab: 'chapters',  // 'books' or 'chapters'
          testament: 'old', // 'old' or 'new'
          category: 'pentateuch',  // category filter
          pendingBook: null,    // temporarily selected book
          pendingChapter: null  // temporarily selected chapter
        },
        verseActions: {
          show: false,
          verse: null
        },
        compareVerseRef: null,  // ref of verse being compared
        compareVerses: [],      // array of {versionName, versionId, text} for comparison
        // Unified verse modal for title/note/highlight
        verseModal: {
          show: false,
          type: null,  // 'title' | 'note' | 'highlight'
          verse: null,
          // Type-specific data
          title: '',              // for title type
          note: '',               // for note type
          selectedHighlightId: null, // for highlight type - selected but not yet applied
          editingId: null,        // for highlight type - editing definition
          editName: '',           // for highlight type
          editColor: ''           // for highlight type
        },
        settingsModal: {
          show: false,
          isBusy: false,
          message: '',
          isError: false
        },
        snModal: {
          show: false,
          code: '',
          definition: '',
          loading: false
        },
        confirmModal: {
          show: false,
          message: '',
          onConfirm: null
        },
        historyModal: {
          show: false
        },
        readingHistory: [],  // Array of { bookCode, chapter, timestamp }
        _skipHistoryRecording: true,  // Skip history during initial load
        // TTS (Text-to-Speech) state
        tts: {
          show: false,
          playing: false,
          paused: false,
          currentVerseIndex: 0,
          speed: 1,
          language: 'zh-TW',
          voices: [],
          selectedVoice: null
        },
        snDictTexts: {},  // Cache for raw dictionary text by version ID
        snDictLoading: false,
        hasFileSystemAccess: false,
        fileHandle: null,
        autoSync: false,
        // Header actions configuration
        headerActions: [
          { id: 'search', name: 'æœå°‹', visible: true },
          { id: 'tts', name: 'æœ—è®€', visible: true },
          { id: 'history', name: 'é–±è®€ç´€éŒ„', visible: true },
          { id: 'settings', name: 'è¨­å®š', visible: true }
        ],
        headerActionsModal: {
          show: false,
          draggedId: null
        },
        headerOverflowOpen: false,
        // Reading preferences
        fontSize: 1.125,   // in rem (default ~18px at 16px base)
        lineHeight: 1.8,   // multiplier
        verseSpacing: 16,  // in pixels (gap between verses)
        fontFamily: 0,     // index into fontFamilies array
        zoom: 100,         // global zoom percentage (50-150%)
        fontFamilies: [
          { name: 'ç³»çµ±å­—å‹', value: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' },
          { name: 'æ€æºå®‹é«”', value: '"Noto Serif TC", serif' },
          { name: 'é»‘é«”', value: '"Noto Sans TC", "Microsoft JhengHei", sans-serif' },
          { name: 'æ¥·é«”', value: '"TW-Kai", "DFKai-SB", "KaiTi", serif' }
        ],
        // Book categories for navigation
        bookCategoriesOT: [
          { id: 'pentateuch', name: 'æ‘©è¥¿äº”ç¶“', books: ['GEN', 'EXO', 'LEV', 'NUM', 'DEU'] },
          { id: 'history', name: 'æ­·å²æ›¸', books: ['JOS', 'JUG', 'RUT', 'SA1', 'SA2', 'KI1', 'KI2', 'CH1', 'CH2', 'EZR', 'NEH', 'EST'] },
          { id: 'poetry', name: 'è©©æ­Œæ™ºæ…§æ›¸', books: ['JOB', 'PSM', 'PRO', 'ECC', 'SON'] },
          { id: 'major', name: 'å¤§å…ˆçŸ¥æ›¸', books: ['ISA', 'JER', 'LAM', 'EZE', 'DAN'] },
          { id: 'minor', name: 'å°å…ˆçŸ¥æ›¸', books: ['HOS', 'JOE', 'AMO', 'OBA', 'JON', 'MIC', 'NAH', 'HAB', 'ZEP', 'HAG', 'ZEC', 'MAL'] }
        ],
        bookCategoriesNT: [
          { id: 'gospels', name: 'ç¦éŸ³æ›¸', books: ['MAT', 'MAK', 'LUK', 'JHN'] },
          { id: 'acts', name: 'ä½¿å¾’è¡Œå‚³', books: ['ACT'] },
          { id: 'pauline', name: 'ä¿ç¾…æ›¸ä¿¡', books: ['ROM', 'CO1', 'CO2', 'GAL', 'EPH', 'PHL', 'COL', 'TS1', 'TS2', 'TI1', 'TI2', 'TIT', 'PHM'] },
          { id: 'general', name: 'æ™®é€šæ›¸ä¿¡', books: ['HEB', 'JAS', 'PE1', 'PE2', 'JN1', 'JN2', 'JN3', 'JUD'] },
          { id: 'revelation', name: 'å•Ÿç¤ºéŒ„', books: ['REV'] }
        ],
        // Reading overlay control
        readingOverlay: {
          show: false,
          activeTab: 0,  // 0: fontSize, 1: lineHeight, 2: verseSpacing, 3: fontFamily, 4: zoom
          isDragging: false,
          sliderRect: null
        },
        // Pinch zoom state
        pinchState: {
          active: false,
          initialDistance: 0,
          initialZoom: 100
        },

        // Swipe navigation state
        swipeState: {
          active: false,
          startX: 0,
          currentX: 0,
          progress: 0  // -1 to 1 (negative = left/prev, positive = right/next)
        },

        // Desktop detection (non-touch primary input)
        isDesktop: false,

        async init() {
          // Detect if desktop (non-touch primary input)
          this.isDesktop = window.matchMedia('(pointer: fine)').matches;
          // Check File System Access API support
          this.hasFileSystemAccess = 'showSaveFilePicker' in window;
          // Check dark mode preference
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            this.isDark = true;
            document.documentElement.classList.add('dark');
          }
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            this.isDark = event.matches;
            document.documentElement.classList.toggle('dark', event.matches);
          });

          // Initialize TTS voices
          this.initTTS();

          // Load saved data from IndexedDB
          await this.loadFromStorage();

          await this.parseVerses();
        },

        // IndexedDB helpers using idb-keyval
        async loadFromStorage() {
          try {
            const [savedTitles, savedNotes, savedBook, savedChapter, savedAutoSync, savedFileHandle, savedVersionId, savedCachedVersions, savedFontSize, savedLineHeight, savedVerseSpacing, savedFontFamily, savedHighlightDefs, savedVerseHighlights, savedZoom, savedTtsSpeed, savedTtsLanguage, savedTtsVoice] = await Promise.all([
              this._storageLoad('bible_customTitles'),
              this._storageLoad('bible_notes'),
              this._storageLoad('bible_selectedBook'),
              this._storageLoad('bible_selectedChapter'),
              this._storageLoad('bible_autoSync'),
              this._storageLoad('bible_fileHandle'),
              this._storageLoad('bible_selectedVersion'),
              this._storageLoad('bible_cachedVersions'),
              this._storageLoad('bible_fontSize'),
              this._storageLoad('bible_lineHeight'),
              this._storageLoad('bible_verseSpacing'),
              this._storageLoad('bible_fontFamily'),
              this._storageLoad('bible_highlightDefs'),
              this._storageLoad('bible_verseHighlights'),
              this._storageLoad('bible_zoom'),
              this._storageLoad('bible_ttsSpeed'),
              this._storageLoad('bible_ttsLanguage'),
              this._storageLoad('bible_ttsVoice')
            ]);

            if (savedTitles) {
              this.customTitles = this.migrateRefKeys(savedTitles);
            }
            if (savedNotes) {
              this.notes = this.migrateRefKeys(savedNotes);
            }
            if (savedBook) {
              // Convert old book names to codes for backward compatibility
              this._pendingBook = getBookCode(savedBook);
            }
            if (savedChapter) {
              this._pendingChapter = savedChapter;
            }
            if (savedAutoSync !== undefined) {
              this.autoSync = savedAutoSync;
            }
            if (savedVersionId && this.availableVersions.some(v => v.id === savedVersionId)) {
              this.selectedVersionId = savedVersionId;
            }
            if (savedCachedVersions && Array.isArray(savedCachedVersions)) {
              this.cachedVersions = savedCachedVersions;
            }

            // Restore file handle if available (permissions will need to be re-requested)
            if (savedFileHandle && this.hasFileSystemAccess) {
              this.fileHandle = savedFileHandle;
              // Note: Permission will be checked/requested when user tries to use it
            }

            // Restore reading preferences
            if (savedFontSize) {
              // Migrate old px values to rem (old values were 12-36, new are 0.75-2.25)
              if (savedFontSize >= 10) {
                // Old px value, convert to rem (assuming 16px base)
                this.fontSize = Math.max(0.75, Math.min(2.25, savedFontSize / 16));
              } else if (savedFontSize >= 0.75 && savedFontSize <= 2.25) {
                // Already in rem
                this.fontSize = savedFontSize;
              }
            }
            if (savedLineHeight && savedLineHeight >= 1.0 && savedLineHeight <= 3) {
              this.lineHeight = savedLineHeight;
            }
            if (savedVerseSpacing && savedVerseSpacing >= 0 && savedVerseSpacing <= 64) {
              this.verseSpacing = savedVerseSpacing;
            }
            if (savedFontFamily !== undefined && savedFontFamily >= 0 && savedFontFamily < this.fontFamilies.length) {
              this.fontFamily = savedFontFamily;
            }
            if (savedZoom && savedZoom >= 50 && savedZoom <= 150) {
              this.zoom = savedZoom;
            }
            // Restore highlight data
            if (savedHighlightDefs && typeof savedHighlightDefs === 'object') {
              this.highlightDefs = { ...this.highlightDefs, ...savedHighlightDefs };
            }
            if (savedVerseHighlights) {
              this.verseHighlights = this.migrateRefKeys(savedVerseHighlights);
            }

            // Restore TTS settings
            if (savedTtsSpeed && savedTtsSpeed >= 0.5 && savedTtsSpeed <= 2) {
              this.tts.speed = savedTtsSpeed;
            }
            if (savedTtsLanguage) {
              this.tts.language = savedTtsLanguage;
            }
            if (savedTtsVoice) {
              this.tts.selectedVoice = savedTtsVoice;
            }

            // Load compare version order
            await this.loadCompareVersionOrder();

            // Load reading history (stored separately, not in user data zip)
            await this.loadReadingHistory();

            // Load header actions configuration
            await this.loadHeaderActions();
          } catch (e) {
            console.warn('Failed to load from IndexedDB:', e);
          }
        },

        // === TTS (Text-to-Speech) Methods ===
        initTTS() {
          if ('speechSynthesis' in window) {
            // Load voices
            const loadVoices = () => {
              const voices = speechSynthesis.getVoices();
              const lang = this.tts.language;
              
              // Filter voices by language
              let filteredVoices = voices.filter(v => {
                if (lang === 'zh-TW' || lang === 'zh-HK') {
                  return v.lang.startsWith('zh');
                } else if (lang === 'en-US') {
                  return v.lang.startsWith('en');
                }
                return v.lang === lang;
              });
              
              // If no specific voices, use all available
              if (filteredVoices.length === 0) {
                filteredVoices = voices.filter(v => v.lang.startsWith(lang.split('-')[0]));
              }
              
              this.tts.voices = filteredVoices;
              
              // Auto-select first voice if none selected
              if (filteredVoices.length > 0 && !this.tts.selectedVoice) {
                this.tts.selectedVoice = filteredVoices[0].name;
              }
            };
            
            // Voices might load asynchronously
            loadVoices();
            speechSynthesis.onvoiceschanged = loadVoices;
          } else {
            console.warn('Speech synthesis not supported');
          }
        },

        onTtsLanguageChange() {
          // Re-filter voices when language changes
          this.initTTS();
        },

        getTtsSpeed() {
          return this.tts.speed;
        },

        getSelectedVoice() {
          if (!this.tts.selectedVoice || this.tts.voices.length === 0) return null;
          return this.tts.voices.find(v => v.name === this.tts.selectedVoice) || null;
        },

        async ttsPlay() {
          if (!this.currentVerses || this.currentVerses.length === 0) return;
          
          // Cancel any ongoing speech
          speechSynthesis.cancel();
          
          // Determine starting verse: selected verse if exists, otherwise from current index
          let startIndex = 0;
          if (this.verseActions.show && this.verseActions.verse) {
            const selectedRef = this.verseActions.verse.ref;
            const idx = this.currentVerses.findIndex(v => v.ref === selectedRef);
            if (idx !== -1) startIndex = idx;
          }
          
          this.tts.currentVerseIndex = startIndex;
          this.tts.playing = true;
          this.tts.paused = false;
          
          await this.ttsSpeakCurrentVerse();
        },

        async ttsSpeakCurrentVerse() {
          if (this.tts.currentVerseIndex >= this.currentVerses.length) {
            this.ttsStop();
            return;
          }
          
          const verse = this.currentVerses[this.tts.currentVerseIndex];
          if (!verse) {
            this.ttsStop();
            return;
          }
          
          const currentVerseEl = document.querySelector(`[data-verse-num="${verse.verseNum}"]`);

          
          // Scroll to current verse
          currentVerseEl?.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          const text = this.renderVerseText(verse.text).replace(/<[^>]*>/g, '');
          const utterance = new SpeechSynthesisUtterance(text);
          
          utterance.rate = this.tts.speed;
          utterance.lang = this.tts.language;
          
          const selectedVoice = this.getSelectedVoice();
          if (selectedVoice) {
            utterance.voice = selectedVoice;
          }
          
          utterance.onend = () => {
            this.tts.currentVerseIndex++;
            this.ttsSpeakCurrentVerse();
          };
          
          utterance.onerror = (e) => {
            console.warn('TTS error:', e);
            if (e.error !== 'interrupted') {
              this.tts.currentVerseIndex++;
              this.ttsSpeakCurrentVerse();
            }
          };
          
          speechSynthesis.speak(utterance);
        },

        ttsPause() {
          if (speechSynthesis.paused) {
            speechSynthesis.resume();
            this.tts.paused = false;
            this.tts.playing = true;
          } else if (speechSynthesis.speaking) {
            speechSynthesis.pause();
            this.tts.paused = true;
            this.tts.playing = false;
          }
        },

        ttsResume() {
          if (speechSynthesis.paused) {
            speechSynthesis.resume();
            this.tts.paused = false;
            this.tts.playing = true;
          }
        },

        ttsStop() {
          speechSynthesis.cancel();
          this.tts.playing = false;
          this.tts.paused = false;
          // Remove highlight from all verses
          document.querySelectorAll('.verse-item.verse-tts').forEach(el => {
            el.classList.remove('verse-tts');
          });
          const verse = this.currentVerses[this.tts.currentVerseIndex];
          this.showVerseActions(verse);
        },

        ttsToggle() {
          if (this.tts.playing || this.tts.paused) {
            this.ttsStop();
          } else {
            this.ttsPlay();
          }
        },

        // Generic IndexedDB helpers
        async _storageSave(key, value) {
          try {
            await idbKeyval.set(key, value);
          } catch (e) {
            console.warn(`Failed to save ${key}:`, e);
          }
        },
        async _storageLoad(key) {
          try {
            return await idbKeyval.get(key);
          } catch (e) {
            console.warn(`Failed to load ${key}:`, e);
            return undefined;
          }
        },

        // Save file handle to IndexedDB
        async saveFileHandle() {
          if (this.fileHandle) {
            await this._storageSave('bible_fileHandle', this.fileHandle);
          } else {
            try {
              await idbKeyval.del('bible_fileHandle');
            } catch (e) {
              console.warn('Failed to delete file handle:', e);
            }
          }
        },

        // Verify and request permission for file handle
        async verifyPermission(readWrite = true) {
          if (!this.fileHandle) return false;

          const options = readWrite ? { mode: 'readwrite' } : {};

          // Check if permission was already granted
          if ((await this.fileHandle.queryPermission(options)) === 'granted') {
            return true;
          }

          // Request permission if not granted
          if ((await this.fileHandle.requestPermission(options)) === 'granted') {
            return true;
          }

          return false;
        },

        async saveCustomTitles() {
          const value = JSON.parse(JSON.stringify(this.customTitles));
          await this._storageSave('bible_customTitles', value);
          await this.triggerAutoSync();
        },

        async saveNotes() {
          const value = JSON.parse(JSON.stringify(this.notes));
          await this._storageSave('bible_notes', value);
          await this.triggerAutoSync();
        },

        async saveReadingPosition() {
          await Promise.all([
            this._storageSave('bible_selectedBook', this.selectedBook),
            this._storageSave('bible_selectedChapter', this.selectedChapter)
          ]);
        },

        async saveReadingPreferences() {
          await Promise.all([
            this._storageSave('bible_fontSize', this.fontSize),
            this._storageSave('bible_lineHeight', this.lineHeight),
            this._storageSave('bible_verseSpacing', this.verseSpacing),
            this._storageSave('bible_fontFamily', this.fontFamily),
            this._storageSave('bible_zoom', this.zoom)
          ]);
        },

        async saveTtsSettings() {
          await Promise.all([
            this._storageSave('bible_ttsSpeed', this.tts.speed),
            this._storageSave('bible_ttsLanguage', this.tts.language),
            this._storageSave('bible_ttsVoice', this.tts.selectedVoice)
          ]);
        },

        // Show reading overlay control
        showReadingOverlay() {
          this.readingOverlay.show = true;
          this.$refs.settingsDialog?.close();
        },

        hideReadingOverlay() {
          this.readingOverlay.show = false;
        },

        switchOverlayTab(tab) {
          this.readingOverlay.activeTab = tab;
        },

        adjustFontSize(delta) {
          // delta is in 0.05rem increments
          this.fontSize = Math.max(0.75, Math.min(2.25, Math.round((parseFloat(this.fontSize) + delta) * 100) / 100));
          this.saveReadingPreferences();
        },

        adjustLineHeight(delta) {
          this.lineHeight = Math.max(1.0, Math.min(3.0, Math.round((parseFloat(this.lineHeight) + delta) * 10) / 10));
          this.saveReadingPreferences();
        },

        adjustVerseSpacing(delta) {
          this.verseSpacing = Math.max(0, Math.min(64, parseInt(this.verseSpacing) + delta));
          this.saveReadingPreferences();
        },

        adjustFontFamily(delta) {
          const len = this.fontFamilies.length;
          this.fontFamily = ((this.fontFamily + delta) % len + len) % len;
          this.saveReadingPreferences();
        },

        adjustZoom(delta) {
          this.zoom = Math.max(50, Math.min(150, parseInt(this.zoom) + delta));
          this.saveReadingPreferences();
        },

        // Pinch-to-zoom functionality
        handlePinchStart(event) {
          if (event.touches.length !== 2) return;

          const touch1 = event.touches[0];
          const touch2 = event.touches[1];
          const distance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );

          this.pinchState.active = true;
          this.pinchState.initialDistance = distance;
          this.pinchState.initialZoom = this.zoom;

          // Show reading overlay with zoom tab
          this.readingOverlay.activeTab = 4;
          this.readingOverlay.show = true;
        },

        handlePinchMove(event) {
          if (!this.pinchState.active || event.touches.length !== 2) return;

          const touch1 = event.touches[0];
          const touch2 = event.touches[1];
          const distance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );

          // Calculate zoom based on pinch scale with dampening for less sensitivity
          const scale = distance / this.pinchState.initialDistance;
          const dampening = 0.4; // Lower = less sensitive (0.4 means 40% of the gesture effect)
          const dampenedScale = 1 + (scale - 1) * dampening;
          const newZoom = Math.round(this.pinchState.initialZoom * dampenedScale);

          // Clamp to valid range
          this.zoom = Math.max(50, Math.min(150, newZoom));
        },

        handlePinchEnd(event) {
          if (!this.pinchState.active) return;

          // If no touches left or only one touch, end pinch
          if (event.touches.length < 2) {
            this.pinchState.active = false;
            this.saveReadingPreferences();
          }
        },

        // Slider drag functionality
        startSliderDrag(event) {
          this.readingOverlay.isDragging = true;
          const sliderEl = event.currentTarget.querySelector('.bg-white\\/15');
          this.readingOverlay.sliderRect = sliderEl.getBoundingClientRect();
          this.handleSliderMove(event);

          const moveHandler = (e) => this.handleSliderMove(e);
          const endHandler = () => {
            this.readingOverlay.isDragging = false;
            this.saveReadingPreferences();
            document.removeEventListener('mousemove', moveHandler);
            document.removeEventListener('mouseup', endHandler);
            document.removeEventListener('touchmove', moveHandler);
            document.removeEventListener('touchend', endHandler);
          };

          document.addEventListener('mousemove', moveHandler);
          document.addEventListener('mouseup', endHandler);
          document.addEventListener('touchmove', moveHandler, { passive: false });
          document.addEventListener('touchend', endHandler);
        },

        handleSliderMove(event) {
          if (!this.readingOverlay.sliderRect) return;
          const rect = this.readingOverlay.sliderRect;
          const clientX = event.touches ? event.touches[0].clientX : event.clientX;
          let ratio = (clientX - rect.left) / rect.width;
          ratio = Math.max(0, Math.min(1, ratio));

          if (this.readingOverlay.activeTab === 0) {
            // Font size: 0.75-2.25rem (30 steps of 0.05rem)
            this.fontSize = Math.round((0.75 + ratio * 1.5) * 20) / 20;
          } else if (this.readingOverlay.activeTab === 1) {
            // Line height: 1.0-3.0 (20 steps of 0.1)
            this.lineHeight = Math.round((1.0 + ratio * 2.0) * 10) / 10;
          } else if (this.readingOverlay.activeTab === 2) {
            // Verse spacing: 0-64px (16 steps of 4)
            this.verseSpacing = Math.round(ratio * 16) * 4;
          } else if (this.readingOverlay.activeTab === 4) {
            // Zoom: 50-150% (20 steps of 5%)
            this.zoom = Math.round((50 + ratio * 100) / 5) * 5;
          }
        },

        // Swipe navigation handlers
        handleSwipeStart(event) {
          // Only handle touch events for swipe (desktop uses clickable arrows)
          if (!event.touches) return;
          // Only handle single touch for swipe (pinch uses 2 touches)
          if (event.touches.length !== 1) return;
          // Don't start swipe if pinch is active
          if (this.pinchState.active) return;

          const clientX = event.touches[0].clientX;
          this.swipeState.active = true;
          this.swipeState.startX = clientX;
          this.swipeState.currentX = clientX;
          this.swipeState.progress = 0;
        },

        handleSwipeMove(event) {
          if (!this.swipeState.active) return;
          // Only handle touch events
          if (!event.touches) return;
          // Cancel swipe if pinch starts
          if (this.pinchState.active) {
            this.swipeState.active = false;
            this.swipeState.progress = 0;
            return;
          }

          const clientX = event.touches[0].clientX;
          this.swipeState.currentX = clientX;

          const deltaX = clientX - this.swipeState.startX;
          const threshold = 120; // pixels needed to trigger action

          // Calculate progress: positive = swiping right (prev chapter), negative = swiping left (next chapter)
          // Clamp to -1 to 1 range
          this.swipeState.progress = Math.max(-1, Math.min(1, deltaX / threshold));
        },

        handleSwipeEnd() {
          if (!this.swipeState.active) return;

          const progress = this.swipeState.progress;

          // If threshold reached, trigger navigation
          if (progress >= 1 && this.canGoPrev) {
            this.prevChapter();
          } else if (progress <= -1 && this.canGoNext) {
            this.nextChapter();
          }

          // Reset state
          this.swipeState.active = false;
          this.swipeState.progress = 0;
        },

        // Get arrow opacity based on swipe progress (0 to 1)
        getSwipeArrowOpacity(direction) {
          const progress = this.swipeState.progress;

          if (direction === 'left') {
            // Left arrow shows when swiping right (positive progress) for prev chapter
            if (progress > 0) {
              return Math.min(1, progress);
            }
            // On desktop, show subtle arrow when not swiping
            return this.isDesktop ? 0.15 : 0;
          } else {
            // Right arrow shows when swiping left (negative progress) for next chapter
            if (progress < 0) {
              return Math.min(1, Math.abs(progress));
            }
            // On desktop, show subtle arrow when not swiping
            return this.isDesktop ? 0.15 : 0;
          }
        },

        // Check if arrow should be visible at all
        shouldShowArrow(direction) {
          if (direction === 'left') {
            return this.canGoPrev && (this.isDesktop || this.swipeState.progress > 0);
          } else {
            return this.canGoNext && (this.isDesktop || this.swipeState.progress < 0);
          }
        },

        get currentFontFamily() {
          return this.fontFamilies[this.fontFamily]?.value || this.fontFamilies[0].value;
        },

        get currentFontFamilyName() {
          return this.fontFamilies[this.fontFamily]?.name || this.fontFamilies[0].name;
        },

        // Verse modal helpers
        get verseModalConfig() {
          const configs = {
            title: { icon: 'âœï¸', label: 'è‡ªè¨‚æ¨™é¡Œ' },
            note: { icon: 'ğŸ“', label: 'ç­†è¨˜' },
            highlight: { icon: 'ğŸ¨', label: 'æ¨™è¨»' }
          };
          return configs[this.verseModal.type] || { icon: '', label: '' };
        },

        // Get display name for a book code
        getBookName(code) {
          return getBookName(code);
        },

        // Get display name for current selected book
        get selectedBookName() {
          return getBookName(this.selectedBook);
        },

        // Format verse reference for display (e.g., "GEN:1:1" -> "å‰µä¸–è¨˜ 1:1")
        formatRef(ref) {
          const parts = ref.split(':');
          if (parts.length >= 2) {
            const bookName = getBookName(parts[0]);
            return `${bookName} ${parts[1]}:${parts[2] || 1}`;
          }
          return ref;
        },

        // Get filtered books based on current testament and category
        getFilteredBooks() {
          const categories = this.navModal.testament === 'old' ? this.bookCategoriesOT : this.bookCategoriesNT;
          const category = categories.find(c => c.id === this.navModal.category);
          if (category) {
            // Filter to only include books that exist in our data
            return category.books.filter(code => this.books.includes(code));
          }
          // Default: return all books for current testament
          const allBooksInTestament = categories.flatMap(c => c.books);
          return allBooksInTestament.filter(code => this.books.includes(code));
        },

        // Migrate old ref keys (e.g., "å‰µä¸–è¨˜1:1" -> "GEN:1:1") for backward compatibility
        migrateRefKeys(obj) {
          if (!obj || typeof obj !== 'object') return obj;
          const migrated = {};
          for (const [key, value] of Object.entries(obj)) {
            // Check if key is in old format (book name + chapter:verse, e.g., "å‰µä¸–è¨˜1:1")
            // New format uses colons: "GEN:1:1"
            if (key.includes(':') && !key.match(/^[A-Z0-9]+:/)) {
              // Old format: try to extract book name and convert
              const match = key.match(/^(.+?)(\d+:\d+)$/);
              if (match) {
                const bookName = match[1];
                const chapterVerse = match[2];
                const bookCode = getBookCode(bookName);
                const newKey = `${bookCode}:${chapterVerse}`;
                migrated[newKey] = value;
                continue;
              }
            }
            // Keep as-is (already in new format or unrecognized)
            migrated[key] = value;
          }
          return migrated;
        },

        // Get current selected version info
        get currentVersion() {
          return this.availableVersions.find(v => v.id === this.selectedVersionId) || this.availableVersions[0];
        },

        // Check if a version is cached
        isVersionCached(versionId) {
          return this.cachedVersions.includes(versionId);
        },

        // Save selected version preference
        async saveSelectedVersion() {
          await this._storageSave('bible_selectedVersion', this.selectedVersionId);
        },

        async saveCachedVersions() {
          const value = JSON.parse(JSON.stringify(this.cachedVersions));
          await this._storageSave('bible_cachedVersions', value);
        },

        // Save cached versions list
        async saveCachedVersions() {
          const value = JSON.parse(JSON.stringify(this.cachedVersions));
          await this._storageSave('bible_cachedVersions', value);
        },

        // Download and cache a Bible version
        async downloadVersion(version) {
          this.versionModal.downloading = version.id;

          try {
            const response = await fetch(`./txt/${version.file}`);
            if (!response.ok) {
              throw new Error(`Failed to download: ${response.status}`);
            }
            const text = await response.text();

            // Cache in IndexedDB
            await idbKeyval.set(`bible_version_${version.id}`, text);

            // Update cached versions list
            if (!this.cachedVersions.includes(version.id)) {
              this.cachedVersions.push(version.id);
              await this.saveCachedVersions();
            }

            this.versionModal.downloading = null;
            return true;
          } catch (error) {
            console.error('Download failed:', error);
            this.versionModal.downloading = null;
            return false;
          }
        },

        // Delete cached version
        async deleteVersion(versionId) {
          try {
            await idbKeyval.del(`bible_version_${versionId}`);
            this.cachedVersions = this.cachedVersions.filter(id => id !== versionId);
            await this.saveCachedVersions();
            // Also remove from compare order
            const idx = this.compareVersionOrder.indexOf(versionId);
            if (idx !== -1) {
              this.compareVersionOrder.splice(idx, 1);
              await this.saveCompareVersionOrder();
            }
          } catch (e) {
            console.warn('Failed to delete version:', e);
          }
        },

        // Download a version without switching to it
        async downloadVersionOnly(versionId) {
          const version = this.availableVersions.find(v => v.id === versionId);
          if (!version) return;

          if (!this.isVersionCached(versionId)) {
            await this.downloadVersion(version);
          }
        },

        // Select and load a version (without closing drawer)
        async selectVersion(versionId) {
          const version = this.availableVersions.find(v => v.id === versionId);
          if (!version) return;

          // Download if not cached
          if (!this.isVersionCached(versionId)) {
            const success = await this.downloadVersion(version);
            if (!success) return;
          }

          this.selectedVersionId = versionId;
          await this.saveSelectedVersion();

          // Reload verses
          await this.parseVerses();
        },

        async parseVerses() {
          let rawText;
          const version = this.currentVersion;

          // Reset data
          this.allVerses = [];
          this.books = [];
          this.bibleData = {};
          this.sourceTitles = {};

          // Try to load from IndexedDB cache first
          try {
            const cachedData = await idbKeyval.get(`bible_version_${this.selectedVersionId}`);
            if (cachedData) {
              this.isLoading = true;
              this.loadingMessage = 'æ­£åœ¨è¼‰å…¥ç¶“æ–‡...';
              this.loadingSubMessage = `${version.name} - å¾å¿«å–è®€å–`;
              rawText = cachedData;
              // Small delay to show loading state
              await new Promise(resolve => setTimeout(resolve, 100));
            }
          } catch (e) {
            console.warn('Failed to read from cache:', e);
          }

          // If not cached, fetch from network
          if (!rawText) {
            this.isLoading = true;
            this.loadingMessage = 'æ­£åœ¨ä¸‹è¼‰ç¶“æ–‡è³‡æ–™...';
            this.loadingSubMessage = `${version.name} (${version.size})`;

            try {
              const response = await fetch(`./txt/${version.file}`);
              if (!response.ok) {
                throw new Error(`Failed to load ${version.file}: ${response.status}`);
              }
              rawText = await response.text();

              // Cache the data in IndexedDB
              this.loadingMessage = 'æ­£åœ¨å„²å­˜å¿«å–...';
              this.loadingSubMessage = 'ä¸‹æ¬¡è¼‰å…¥å°‡æ›´å¿«';
              try {
                await idbKeyval.set(`bible_version_${this.selectedVersionId}`, rawText);
                if (!this.cachedVersions.includes(this.selectedVersionId)) {
                  this.cachedVersions.push(this.selectedVersionId);
                  await this.saveCachedVersions();
                }
                console.log('Bible data cached successfully');
              } catch (cacheError) {
                console.warn('Failed to cache Bible data:', cacheError);
              }
            } catch (error) {
              console.error('Failed to load Bible data:', error);
              this.isLoading = false;
              this.loadingMessage = '';
              this.loadingSubMessage = '';
              return;
            }
          }

          // Parse the new format
          const lines = rawText.split('\n');
          const bookOrder = []; // Maintain book order
          const bookSet = new Set();
          const seenRefs = new Set();
          let pendingSourceTitle = null; // Track source title for next verse

          for (const line of lines) {
            // Skip header line and empty lines
            if (line.startsWith('@') || !line.trim()) continue;

            // Parse format: BOOK_CODE|chapter|verse|text
            const parts = line.split('|');
            if (parts.length >= 4) {
              const [rawBookCode, chapter, verse, ...textParts] = parts;
              const text = textParts.join('|'); // In case text contains |
              const chapterNum = parseInt(chapter);

              // Check if this is a source title line (verse is '@')
              if (verse === '@') {
                // Store title for the next verse in this book/chapter
                pendingSourceTitle = {
                  bookCode: normalizeBookCode(rawBookCode),
                  chapter: chapterNum,
                  title: text
                };
                continue;
              }

              const verseNum = parseInt(verse);

              if (isNaN(chapterNum) || isNaN(verseNum)) continue;

              // Normalize book code to canonical form
              const bookCode = normalizeBookCode(rawBookCode);
              const ref = `${bookCode}:${chapterNum}:${verseNum}`;

              // Skip duplicates
              if (seenRefs.has(ref)) continue;
              seenRefs.add(ref);

              // Track book order using canonical codes
              if (!bookSet.has(bookCode)) {
                bookSet.add(bookCode);
                bookOrder.push(bookCode);
              }

              if (!this.bibleData[bookCode]) {
                this.bibleData[bookCode] = {};
              }
              if (!this.bibleData[bookCode][chapterNum]) {
                this.bibleData[bookCode][chapterNum] = [];
              }

              const verseData = {
                ref,
                bookCode,
                chapter: chapterNum,
                verseNum,
                text
              };

              // Assign pending source title to this verse if it matches
              if (pendingSourceTitle &&
                  pendingSourceTitle.bookCode === bookCode &&
                  pendingSourceTitle.chapter === chapterNum) {
                this.sourceTitles[ref] = pendingSourceTitle.title;
                pendingSourceTitle = null;
              }

              this.bibleData[bookCode][chapterNum].push(verseData);
              this.allVerses.push(verseData);
            }
          }

          this.totalVerses = this.allVerses.length;
          this.books = bookOrder;

          // Clear loading state
          this.isLoading = false;
          this.loadingMessage = '';
          this.loadingSubMessage = '';

          if (this.books.length > 0) {
            // Set initial book (first book as default)
            this.selectedBook = this.books[0];
            this.updateChapters();
            this.loadVerses();

            // Preload dictionary for SN versions (don't await, let it load in background)
            if (this.hasSN) {
              this.loadDictionary();
            }

            // Restore saved position after DOM is ready
            this.$nextTick(() => {
              let needsReload = false;

              if (this._pendingBook && this.books.includes(this._pendingBook)) {
                this.selectedBook = this._pendingBook;
                this.updateChapters();
                needsReload = true;
              }

              if (this._pendingChapter && this.chapters.includes(this._pendingChapter)) {
                this.selectedChapter = this._pendingChapter;
                needsReload = true;
              }

              if (needsReload) {
                this.loadVerses();
              }

              // Enable history recording after initial load is complete
              this._skipHistoryRecording = false;
            });
          }
        },

        updateChapters() {
          if (this.bibleData[this.selectedBook]) {
            this.chapters = Object.keys(this.bibleData[this.selectedBook])
              .map(Number)
              .sort((a, b) => a - b);
          } else {
            this.chapters = [];
          }
        },

        // Get chapters for the pending book in the nav modal
        getChaptersForPendingBook() {
          const book = this.navModal.pendingBook || this.selectedBook;
          if (this.bibleData[book]) {
            return Object.keys(this.bibleData[book])
              .map(Number)
              .sort((a, b) => a - b);
          }
          return this.chapters;
        },

        // Get the first chapter number for a given book
        getFirstChapterForBook(bookCode) {
          if (this.bibleData[bookCode]) {
            const chapters = Object.keys(this.bibleData[bookCode])
              .map(Number)
              .sort((a, b) => a - b);
            return chapters[0] || 1;
          }
          return 1;
        },

        // Get CSS class for chapter button in nav modal
        getNavChapterClass(chapter) {
          const isSelected = this.navModal.pendingChapter === chapter ||
            // Only highlight current chapter if we're on the same book and no pending selection
            (!this.navModal.pendingChapter && !this.navModal.pendingBook && this.selectedChapter === chapter);
          return isSelected
            ? 'bg-accent text-white'
            : 'bg-primary hover:bg-secondary text-primary border border-custom';
        },

        // Apply pending selection from nav modal and close
        applyNavSelection() {
          const newBook = this.navModal.pendingBook || this.selectedBook;
          const newChapter = this.navModal.pendingChapter || this.selectedChapter;

          // Check if selection changed
          const bookChanged = newBook !== this.selectedBook;
          const chapterChanged = newChapter !== this.selectedChapter;

          if (bookChanged) {
            this.selectedBook = newBook;
            this.updateChapters();
          }

          if (bookChanged || chapterChanged) {
            // Validate chapter exists for the book
            if (this.chapters.includes(newChapter)) {
              this.selectedChapter = newChapter;
            } else {
              this.selectedChapter = this.chapters[0] || 1;
            }
            this.loadVerses();
          }

          // Reset pending values and close
          this.navModal.pendingBook = null;
          this.navModal.pendingChapter = null;
          this.$refs.navDialog?.close();
        },

        onBookChange() {
          this.updateChapters();
          this.selectedChapter = this.chapters[0] || 1;
          this.loadVerses();
          this.saveReadingPosition();
        },

        loadVerses() {
          if (this.bibleData[this.selectedBook] && this.bibleData[this.selectedBook][this.selectedChapter]) {
            this.currentVerses = this.bibleData[this.selectedBook][this.selectedChapter];
            // Record reading history
            this.addToReadingHistory(this.selectedBook, this.selectedChapter);
          } else {
            this.currentVerses = [];
          }
          this.saveReadingPosition();
        },

        get canGoPrev() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          const bookIndex = this.books.indexOf(this.selectedBook);
          return chapterIndex > 0 || bookIndex > 0;
        },

        get canGoNext() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          const bookIndex = this.books.indexOf(this.selectedBook);
          return chapterIndex < this.chapters.length - 1 || bookIndex < this.books.length - 1;
        },

        clearChapterState() {
          this.verseActions.show = false;
          this.verseActions.verse = null;
          this.compareVerseRef = null;
          this.compareVerses = [];
          this.verseModal.show = false;
          speechSynthesis.cancel();
          this.tts.playing = false;
          this.tts.paused = false;
          this.tts.currentVerseIndex = 0;
        },

        prevChapter() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          if (chapterIndex > 0) {
            this.selectedChapter = this.chapters[chapterIndex - 1];
            this.loadVerses();
          } else {
            const bookIndex = this.books.indexOf(this.selectedBook);
            if (bookIndex > 0) {
              this.selectedBook = this.books[bookIndex - 1];
              this.updateChapters();
              this.selectedChapter = this.chapters[this.chapters.length - 1];
              this.loadVerses();
            }
          }
          this.clearChapterState();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        nextChapter() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          if (chapterIndex < this.chapters.length - 1) {
            this.selectedChapter = this.chapters[chapterIndex + 1];
            this.loadVerses();
          } else {
            const bookIndex = this.books.indexOf(this.selectedBook);
            if (bookIndex < this.books.length - 1) {
              this.selectedBook = this.books[bookIndex + 1];
              this.updateChapters();
              this.selectedChapter = this.chapters[0];
              this.loadVerses();
            }
          }
          this.clearChapterState();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        search() {
          if (!this.searchQuery.trim()) {
            this.searchResults = [];
            return;
          }

          const query = this.searchQuery.toLowerCase();
          this.searchResults = this.allVerses.filter(verse =>
            verse.text.toLowerCase().includes(query) ||
            verse.ref.toLowerCase().includes(query)
          );
        },

        // Highlight search query in text
        highlightSearch(text) {
          if (!this.searchQuery.trim() || !text) return text;
          const query = this.searchQuery.trim();
          // Escape special regex characters
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${escaped})`, 'gi');
          return text.replace(regex, '<mark class="search-highlight">$1</mark>');
        },

        clearSearch() {
          this.searchQuery = '';
          this.searchResults = [];
        },

        goToVerse(verse) {
          this.selectedBook = verse.bookCode;
          this.updateChapters();
          this.selectedChapter = verse.chapter;
          this.loadVerses();
          this.clearSearch();
          this.headerSearchOpen = false;

          // Scroll to, highlight, and show verse actions after DOM updates
          this.$nextTick(() => {
            this.scrollToAndHighlightVerse(verse.verseNum);
            // Find the verse in currentVerses and show actions
            const currentVerse = this.currentVerses.find(v => v.verseNum === verse.verseNum && v.ref === verse.ref);
            if (currentVerse) {
              this.showVerseActions(currentVerse);
            }
          });
        },

        toggleDarkMode() {
          this.isDark = !this.isDark;
          document.documentElement.classList.toggle('dark', this.isDark);
        },

        // Header action helpers
        getHeaderActionIcon(actionId) {
          const icons = {
            search: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>',
            tts: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>',
            history: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
            settings: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>'
          };
          return icons[actionId] || '';
        },

        triggerHeaderAction(actionId) {
          switch (actionId) {
            case 'search':
              this.headerSearchOpen = !this.headerSearchOpen;
              this.tts.show = false;
              if (!this.headerSearchOpen) {
                this.searchQuery = '';
                this.searchResults = [];
              } else {
                this.$nextTick(() => this.$refs.headerSearchInput?.focus());
              }
              break;
            case 'tts':
              this.tts.show = !this.tts.show;
              this.headerSearchOpen = false;
              if (this.tts.show && this.tts.voices.length === 0) {
                this.initTTS();
              }
              break;
            case 'history':
              this.historyModal.show = true;
              this.$refs.historyDialog.showModal();
              break;
            case 'settings':
              this.settingsModal.show = true;
              this.$refs.settingsDialog.showModal();
              break;
          }
        },

        // Header actions modal methods
        openHeaderActionsModal() {
          this.headerActionsModal.show = true;
          this.$refs.settingsDialog?.close();
          this.$refs.headerActionsDialog.showModal();
        },

        toggleHeaderActionVisibility(actionId) {
          const action = this.headerActions.find(a => a.id === actionId);
          if (action) {
            action.visible = !action.visible;
            this.saveHeaderActions();
          }
        },

        // Drag and drop for header actions reordering
        startHeaderActionDrag(actionId) {
          this.headerActionsModal.draggedId = actionId;
        },

        handleHeaderActionDragOver(event, targetId) {
          event.preventDefault();
          if (!this.headerActionsModal.draggedId || this.headerActionsModal.draggedId === targetId) return;

          const draggedIdx = this.headerActions.findIndex(a => a.id === this.headerActionsModal.draggedId);
          const targetIdx = this.headerActions.findIndex(a => a.id === targetId);

          if (draggedIdx !== -1 && targetIdx !== -1) {
            const [dragged] = this.headerActions.splice(draggedIdx, 1);
            this.headerActions.splice(targetIdx, 0, dragged);
          }
        },

        endHeaderActionDrag() {
          if (this.headerActionsModal.draggedId) {
            this.headerActionsModal.draggedId = null;
            this.saveHeaderActions();
          }
        },

        async saveHeaderActions() {
          const value = JSON.parse(JSON.stringify(this.headerActions));
          await this._storageSave('bible_headerActions', value);
        },

        async loadHeaderActions() {
          const saved = await this._storageLoad('bible_headerActions');
          if (saved && Array.isArray(saved)) {
            const defaultActions = [
              { id: 'search', name: 'æœå°‹', visible: true },
              { id: 'tts', name: 'æœ—è®€', visible: true },
              { id: 'history', name: 'é–±è®€ç´€éŒ„', visible: true },
              { id: 'settings', name: 'è¨­å®š', visible: true }
            ];
            const savedIds = saved.map(a => a.id);
            const merged = saved.filter(a => defaultActions.some(d => d.id === a.id));
            defaultActions.forEach(d => {
              if (!savedIds.includes(d.id)) {
                merged.push(d);
              }
            });
            this.headerActions = merged;
          }
        },

        // Verse actions widget
        showVerseActions(verse) {
          // If clicking the same verse that's already selected, hide the widget
          if (this.verseActions.show && this.verseActions.verse?.ref === verse.ref) {
            this.hideVerseActions();
            return;
          }
          // Otherwise show/switch to the clicked verse
          this.verseActions = {
            show: true,
            verse: verse
          };
        },

        hideVerseActions() {
          this.verseActions.show = false;
        },

        // Unified verse modal methods
        openTitleModal() {
          const verse = this.verseActions.verse;
          this.openTitleModalForVerse(verse);
        },

        openTitleModalForVerse(verse) {
          this.verseModal = {
            show: true,
            type: 'title',
            verse: verse,
            title: this.customTitles[verse.ref] || '',
            note: '',
            selectedHighlightId: null,
            editingId: null,
            editName: '',
            editColor: ''
          };
          this.$nextTick(() => {
            if (this.$refs.titleInput) {
              this.$refs.titleInput.focus();
            }
          });
          this.$refs.verseDialog.showModal();
        },

        openNoteModal(verse) {
          if (!verse) verse = this.verseActions.verse;
          this.verseModal = {
            show: true,
            type: 'note',
            verse: verse,
            title: '',
            note: this.notes[verse.ref] || '',
            selectedHighlightId: null,
            editingId: null,
            editName: '',
            editColor: ''
          };
          this.$nextTick(() => {
            if (this.$refs.noteInput) {
              this.$refs.noteInput.focus();
            }
          });
          this.$refs.verseDialog.showModal();
        },

        openHighlightModal(verse) {
          const v = verse || this.verseActions.verse;
          if (!v) return;
          this.verseModal = {
            show: true,
            type: 'highlight',
            verse: v,
            title: '',
            note: '',
            selectedHighlightId: this.verseHighlights[v.ref] || null,
            editingId: null,
            editName: '',
            editColor: ''
          };
          this.$refs.verseDialog.showModal();
        },

        closeVerseModal() {
          if (this.$refs.verseDialog) {
            this.$refs.verseDialog.close();
          }
        },

        saveTitle() {
          const ref = this.verseModal.verse?.ref;
          if (ref && this.verseModal.title.trim()) {
            this.customTitles[ref] = this.verseModal.title.trim();
          } else if (ref) {
            delete this.customTitles[ref];
          }
          this.saveCustomTitles();
          this.closeVerseModal();
        },

        saveNote() {
          const ref = this.verseModal.verse?.ref;
          if (ref && this.verseModal.note.trim()) {
            this.notes[ref] = this.verseModal.note.trim();
          } else if (ref) {
            delete this.notes[ref];
          }
          this.saveNotes();
          this.closeVerseModal();
        },

        // Compare/Parallel versions
        async toggleCompare() {
          const verse = this.verseActions.verse;
          if (!verse) return;

          // If already comparing this verse, close it
          if (this.compareVerseRef === verse.ref) {
            this.compareVerseRef = null;
            this.compareVerses = [];
            return;
          }

          // Load comparison from enabled versions in user-configured order
          this.compareVerseRef = verse.ref;
          this.compareVerses = [];

          // Use user's compare order, falling back to all cached versions (excluding current) if empty
          let versionsToCompare = this.compareVersionOrder.filter(id =>
            id !== this.selectedVersionId && this.cachedVersions.includes(id)
          );

          // If no custom order set, use all other cached versions
          if (versionsToCompare.length === 0 && this.compareVersionOrder.length === 0) {
            versionsToCompare = this.cachedVersions.filter(id => id !== this.selectedVersionId);
          }

          for (const versionId of versionsToCompare) {
            try {
              const cachedData = await idbKeyval.get(`bible_version_${versionId}`);
              if (cachedData) {
                const verseText = this.findVerseInRawText(cachedData, verse.ref);
                if (verseText) {
                  const versionInfo = this.availableVersions.find(v => v.id === versionId);
                  this.compareVerses.push({
                    versionId,
                    versionName: versionInfo?.name || versionId,
                    text: verseText
                  });
                }
              }
            } catch (e) {
              console.warn(`Failed to load version ${versionId} for comparison:`, e);
            }
          }
        },

        // Get cached versions not yet added to compare order
        getAvailableCompareVersions() {
          return this.availableVersions.filter(v =>
            this.cachedVersions.includes(v.id) &&
            !this.compareVersionOrder.includes(v.id)
          );
        },

        // Toggle a version in/out of compare list
        toggleCompareVersion(versionId) {
          const idx = this.compareVersionOrder.indexOf(versionId);
          if (idx === -1) {
            this.compareVersionOrder.push(versionId);
          } else {
            this.compareVersionOrder.splice(idx, 1);
          }
          this.saveCompareVersionOrder();
        },

        // Move a version up or down in the compare order
        moveCompareVersion(fromIdx, direction) {
          const toIdx = fromIdx + direction;
          if (toIdx < 0 || toIdx >= this.compareVersionOrder.length) return;

          const temp = this.compareVersionOrder[fromIdx];
          this.compareVersionOrder[fromIdx] = this.compareVersionOrder[toIdx];
          this.compareVersionOrder[toIdx] = temp;
          this.saveCompareVersionOrder();
        },

        // Handle drag-and-drop reorder
        reorderCompareVersion(draggedId, dropIdx) {
          const draggedIdx = this.compareVersionOrder.indexOf(this.versionModal.draggedVersionId);
          if (draggedIdx === -1 || draggedIdx === dropIdx) return;

          // Remove from old position
          const [removed] = this.compareVersionOrder.splice(draggedIdx, 1);
          // Insert at new position
          this.compareVersionOrder.splice(dropIdx, 0, removed);
          this.saveCompareVersionOrder();
        },

        // Save compare order to storage
        async saveCompareVersionOrder() {
          await this._storageSave('bible_compare_order', this.compareVersionOrder);
        },

        // Load compare order from storage
        async loadCompareVersionOrder() {
          const saved = await this._storageLoad('bible_compare_order');
          if (Array.isArray(saved)) {
            this.compareVersionOrder = saved.filter(id => this.cachedVersions.includes(id));
          }
        },

        findVerseInRawText(rawText, ref) {
          // ref format is "BOOK_CODE:chapter:verse", e.g. "GEN:1:1"
          // rawText line format is "BOOK_CODE|chapter|verse|text"
          const [bookCode, chapter, verse] = ref.split(':');
          const regex = new RegExp(`^${bookCode}\\|${chapter}\\|${verse}\\|(.*)$`, 'm');
          const match = rawText.match(regex);
          return match ? match[1] : null;
        },

        selectHighlight(highlightId) {
          // Toggle: if clicking the same highlight, deselect it (remove highlight)
          if (this.verseModal.selectedHighlightId === highlightId) {
            this.verseModal.selectedHighlightId = null;
          } else {
            this.verseModal.selectedHighlightId = highlightId;
          }
          // Immediately save (but don't close the modal)
          const ref = this.verseModal.verse?.ref;
          if (!ref) return;
          const selectedId = this.verseModal.selectedHighlightId;
          if (selectedId) {
            this.verseHighlights[ref] = selectedId;
          } else {
            delete this.verseHighlights[ref];
          }
          this.saveHighlights();
        },

        saveHighlight() {
          const ref = this.verseModal.verse?.ref;
          if (!ref) return;
          const selectedId = this.verseModal.selectedHighlightId;
          if (selectedId) {
            this.verseHighlights[ref] = selectedId;
          } else {
            delete this.verseHighlights[ref];
          }
          this.saveHighlights();
          this.closeVerseModal();
        },

        removeHighlightSelection() {
          this.verseModal.selectedHighlightId = null;
        },

        startHighlightEdit(id) {
          this.verseModal.editingId = id;
          this.verseModal.editName = this.highlightDefs[id].name;
          this.verseModal.editColor = this.highlightDefs[id].color;
        },

        cancelHighlightEdit() {
          this.verseModal.editingId = null;
          this.verseModal.editName = '';
          this.verseModal.editColor = '';
        },

        saveHighlightEdit(id) {
          if (this.verseModal.editName.trim()) {
            this.highlightDefs[id] = {
              name: this.verseModal.editName.trim(),
              color: this.verseModal.editColor
            };
            this.saveHighlightDefs();
          }
          this.cancelHighlightEdit();
        },

        addNewHighlight() {
          // Generate new ID
          const existingIds = Object.keys(this.highlightDefs);
          let newNum = 1;
          while (existingIds.includes('h' + newNum)) {
            newNum++;
          }
          const newId = 'h' + newNum;
          // Random pastel color
          const colors = ['#fde68a', '#a7f3d0', '#fca5a5', '#c4b5fd', '#93c5fd', '#fdba74'];
          const color = colors[Math.floor(Math.random() * colors.length)];
          this.highlightDefs[newId] = { name: 'æ–°æ¨™è¨»', color };
          this.saveHighlightDefs();
          // Start editing immediately
          this.startHighlightEdit(newId);
        },

        deleteHighlight(id) {
          // Count how many verses use this highlight
          const affectedCount = Object.values(this.verseHighlights).filter(hId => hId === id).length;
          const highlightName = this.highlightDefs[id]?.name || '';

          // Show confirmation with count
          this.showConfirmDialog(
            affectedCount > 0
              ? `ç¢ºå®šè¦åˆªé™¤ã€Œ${highlightName}ã€å—ï¼Ÿé€™å°‡ç§»é™¤ ${affectedCount} å€‹ç¶“æ–‡çš„æ¨™è¨»ã€‚`
              : `ç¢ºå®šè¦åˆªé™¤ã€Œ${highlightName}ã€å—ï¼Ÿ`,
            () => {
              // Remove from defs
              delete this.highlightDefs[id];
              // Remove from all verses using this highlight
              for (const ref in this.verseHighlights) {
                if (this.verseHighlights[ref] === id) {
                  delete this.verseHighlights[ref];
                }
              }
              this.saveHighlightDefs();
              this.saveHighlights();
            }
          );
        },

        showConfirmDialog(message, onConfirm) {
          this.confirmModal.message = message;
          this.confirmModal.onConfirm = onConfirm;
          this.confirmModal.show = true;
        },

        confirmDialogConfirm() {
          if (this.confirmModal.onConfirm) {
            this.confirmModal.onConfirm();
          }
          this.confirmModal.show = false;
          this.confirmModal.onConfirm = null;
        },

        confirmDialogCancel() {
          this.confirmModal.show = false;
          this.confirmModal.onConfirm = null;
        },

        async saveHighlights() {
          const value = JSON.parse(JSON.stringify(this.verseHighlights));
          await this._storageSave('bible_verseHighlights', value);
          if (this.autoSync && this.fileHandle) {
            await this.syncToFile();
          }
        },

        async saveHighlightDefs() {
          const value = JSON.parse(JSON.stringify(this.highlightDefs));
          await this._storageSave('bible_highlightDefs', value);
          if (this.autoSync && this.fileHandle) {
            await this.syncToFile();
          }
        },

        getHighlightColor(verseRef) {
          const highlightId = this.verseHighlights[verseRef];
          if (highlightId && this.highlightDefs[highlightId]) {
            return this.highlightDefs[highlightId].color;
          }
          return null;
        },

        // Calculate whether text should be black or white based on background color luminance
        getHighlightTextColor(verseRef) {
          const color = this.getHighlightColor(verseRef);
          if (!color) return null;

          // Parse hex color (supports #RGB and #RRGGBB)
          let hex = color.replace('#', '');
          if (hex.length === 3) {
            hex = hex.split('').map(c => c + c).join('');
          }

          const r = parseInt(hex.substr(0, 2), 16);
          const g = parseInt(hex.substr(2, 2), 16);
          const b = parseInt(hex.substr(4, 2), 16);

          // Calculate relative luminance using sRGB formula
          const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

          // Return black for light backgrounds, white for dark backgrounds
          return luminance > 0.6 ? '#000000' : '#ffffff';
        },

        getVerseNumBgColor(verseRef) {
          const highlightColor = this.getHighlightColor(verseRef);
          const isSelected = this.verseActions.show && this.verseActions.verse?.ref === verseRef;
          const idx = this.currentVerses.findIndex(v => v.ref === verseRef);
          const isTtsPlaying = idx !== -1 && (this.tts.playing || this.tts.paused) && this.tts.currentVerseIndex === idx;

          if (highlightColor) {
            if (isSelected || isTtsPlaying) {
              return this.getHighlightTextColor(verseRef);
            }
            return highlightColor;
          }

          if (isSelected || isTtsPlaying) {
            return 'var(--accent)';
          }
          return null;
        },

        getVerseNumColor(verseRef) {
          const highlightColor = this.getHighlightColor(verseRef);
          const isSelected = this.verseActions.show && this.verseActions.verse?.ref === verseRef;
          const idx = this.currentVerses.findIndex(v => v.ref === verseRef);
          const isTtsPlaying = idx !== -1 && (this.tts.playing || this.tts.paused) && this.tts.currentVerseIndex === idx;

          if (highlightColor) {
            if (isSelected || isTtsPlaying) {
              return highlightColor;
            }
            return this.getHighlightTextColor(verseRef);
          }

          if (isSelected || isTtsPlaying) {
            return 'var(--bg-primary)';
          }
          return 'var(--accent)';
        },

        getVerseNumBoxShadowColor(verseRef) {
          const highlightColor = this.getHighlightColor(verseRef);
          const isSelected = this.verseActions.show && this.verseActions.verse?.ref === verseRef;
          const idx = this.currentVerses.findIndex(v => v.ref === verseRef);
          const isTtsPlaying = idx !== -1 && (this.tts.playing || this.tts.paused) && this.tts.currentVerseIndex === idx;

          if (highlightColor) {
            if (isSelected || isTtsPlaying) {
              return this.getHighlightTextColor(verseRef);
            }
            return null;
          }

          if (isSelected || isTtsPlaying) {
            return 'var(--accent)';
          }
          return null;
        },

        // Settings & File System Access API methods
        async saveAutoSyncPreference() {
          await this._storageSave('bible_autoSync', this.autoSync);
        },

        getExportData() {
          return {
            version: 1,
            exportedAt: new Date().toISOString(),
            customTitles: JSON.parse(JSON.stringify(this.customTitles)),
            notes: JSON.parse(JSON.stringify(this.notes)),
            highlightDefs: JSON.parse(JSON.stringify(this.highlightDefs)),
            verseHighlights: JSON.parse(JSON.stringify(this.verseHighlights)),
            selectedBook: this.selectedBook,
            selectedChapter: this.selectedChapter
          };
        },

        // Generate backup ZIP blob from export data
        async generateBackupZip() {
          const data = this.getExportData();
          const jsonString = JSON.stringify(data, null, 2);
          const zip = new JSZip();
          zip.file('data.json', jsonString);
          return await zip.generateAsync({ type: 'blob' });
        },

        // Re-select file for auto-save
        async reselectFile() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            // Prompt user to select a new file
            this.fileHandle = await window.showSaveFilePicker({
              suggestedName: 'bible-backup.zip',
              types: [{
                description: 'ZIP Files',
                accept: { 'application/zip': ['.zip'] }
              }]
            });
            await this.saveFileHandle();
            this.settingsModal.message = `å·²é¸æ“‡ï¼š${this.fileHandle.name}`;
            this.settingsModal.isError = false;
          } catch (e) {
            if (e.name === 'AbortError') {
              this.settingsModal.message = '';
            } else {
              console.error('File selection failed:', e);
              this.settingsModal.message = 'é¸æ“‡æª”æ¡ˆå¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        // Save to currently selected file (requires file handle)
        async saveToFile() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            const zipBlob = await this.generateBackupZip();

            if (!this.fileHandle) {
              // No file selected, act like saveAsNewFile
              await this.saveAsNewFile();
              return;
            }

            // Verify permission for existing file handle
            const hasPermission = await this.verifyPermission(true);
            if (!hasPermission) {
              this.settingsModal.message = 'æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹é‡æ–°ç¶å®š ZIP æª”æ¡ˆ';
              this.settingsModal.isError = true;
              this.fileHandle = null;
              await this.saveFileHandle();
              return;
            }

            // Write to the file
            const writable = await this.fileHandle.createWritable();
            await writable.write(zipBlob);
            await writable.close();

            this.settingsModal.message = `å·²å„²å­˜è‡³ ${this.fileHandle.name}`;
            this.settingsModal.isError = false;
          } catch (e) {
            if (e.name === 'AbortError') {
              this.settingsModal.message = '';
            } else {
              console.error('Save failed:', e);
              this.settingsModal.message = 'å„²å­˜å¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        // Save as new file (always prompts for new location, or downloads if no file API)
        async saveAsNewFile() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            const zipBlob = await this.generateBackupZip();

            if (this.hasFileSystemAccess) {
              // Use File System Access API - always prompt for new file
              this.fileHandle = await window.showSaveFilePicker({
                suggestedName: 'bible-backup.zip',
                types: [{
                  description: 'ZIP Files',
                  accept: { 'application/zip': ['.zip'] }
                }]
              });
              // Save the new file handle to IndexedDB
              await this.saveFileHandle();

              // Write to the file
              const writable = await this.fileHandle.createWritable();
              await writable.write(zipBlob);
              await writable.close();

              this.settingsModal.message = `å·²å„²å­˜è‡³ ${this.fileHandle.name}`;
              this.settingsModal.isError = false;
            } else {
              // Fallback to download
              const url = URL.createObjectURL(zipBlob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `bible-backup-${new Date().toISOString().slice(0, 10)}.zip`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              this.settingsModal.message = 'å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰';
              this.settingsModal.isError = false;
            }
          } catch (e) {
            if (e.name === 'AbortError') {
              this.settingsModal.message = '';
            } else {
              console.error('Save as failed:', e);
              this.settingsModal.message = 'å¦å­˜æ–°æª”å¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        // Download backup as ZIP file (always downloads, regardless of File System API)
        async downloadBackup() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            const zipBlob = await this.generateBackupZip();

            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bible-backup-${new Date().toISOString().slice(0, 10)}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            this.settingsModal.message = 'å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰';
            this.settingsModal.isError = false;
          } catch (e) {
            console.error('Download backup failed:', e);
            this.settingsModal.message = 'å»ºç«‹å‚™ä»½å¤±æ•—ï¼š' + e.message;
            this.settingsModal.isError = true;
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        async importData() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            let file;

            if (this.hasFileSystemAccess) {
              // Use File System Access API
              const [handle] = await window.showOpenFilePicker({
                types: [{
                  description: 'ZIP Files',
                  accept: { 'application/zip': ['.zip'] }
                }],
                multiple: false
              });

              file = await handle.getFile();

              // Store the handle for future use and persist to IndexedDB
              this.fileHandle = handle;
              await this.saveFileHandle();
            } else {
              // Fallback to file input
              file = await new Promise((resolve, reject) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.zip,application/zip';
                input.onchange = async (e) => {
                  const f = e.target.files[0];
                  if (f) {
                    resolve(f);
                  } else {
                    reject(new Error('No file selected'));
                  }
                };
                input.click();
              });
            }

            // Read and extract ZIP file
            const zip = await JSZip.loadAsync(file);
            const dataFile = zip.file('data.json');
            if (!dataFile) {
              throw new Error('ZIP æª”æ¡ˆä¸­æ‰¾ä¸åˆ° data.json');
            }
            const fileContent = await dataFile.async('string');
            const data = JSON.parse(fileContent);

            // Validate data structure
            if (!data.version || !data.exportedAt) {
              throw new Error('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼');
            }

            // Import the data (with migration for old format)
            if (data.customTitles) {
              this.customTitles = this.migrateRefKeys(data.customTitles);
              await this.saveCustomTitles();
            }
            if (data.notes) {
              this.notes = this.migrateRefKeys(data.notes);
              await this.saveNotes();
            }
            if (data.highlightDefs) {
              this.highlightDefs = { ...this.highlightDefs, ...data.highlightDefs };
              await this.saveHighlightDefs();
            }
            if (data.verseHighlights) {
              this.verseHighlights = this.migrateRefKeys(data.verseHighlights);
              await this.saveHighlights();
            }
            if (data.selectedBook) {
              // Convert old book names to codes for backward compatibility
              const bookCode = getBookCode(data.selectedBook);
              if (this.books.includes(bookCode)) {
                this.selectedBook = bookCode;
                this.updateChapters();
              }
            }
            if (data.selectedChapter && this.chapters.includes(data.selectedChapter)) {
              this.selectedChapter = data.selectedChapter;
            }
            this.loadVerses();
            await this.saveReadingPosition();

            const noteCount = Object.keys(this.notes).length;
            const titleCount = Object.keys(this.customTitles).length;
            const highlightCount = Object.keys(this.verseHighlights).length;
            this.settingsModal.message = `å·²åŒ¯å…¥ ${titleCount} å€‹æ¨™é¡Œã€${noteCount} å€‹ç­†è¨˜å’Œ ${highlightCount} å€‹æ¨™è¨»`;
            this.settingsModal.isError = false;
          } catch (e) {
            if (e.name === 'AbortError') {
              // User cancelled
              this.settingsModal.message = '';
            } else {
              console.error('Import failed:', e);
              this.settingsModal.message = 'åŒ¯å…¥å¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        async unlinkFile() {
          this.fileHandle = null;
          await this.saveFileHandle();
          this.settingsModal.message = 'å·²è§£é™¤æª”æ¡ˆé€£çµ';
          this.settingsModal.isError = false;
        },

        // Clear all cached versions except the currently selected one
        async clearAllVersions() {
          try {
            const versionsToDelete = this.cachedVersions.filter(id => id !== this.selectedVersionId);
            for (const versionId of versionsToDelete) {
              await idbKeyval.del(`bible_version_${versionId}`);
            }
            this.cachedVersions = [this.selectedVersionId];
            await this.saveCachedVersions();
            this.settingsModal.message = `å·²æ¸…é™¤ ${versionsToDelete.length} å€‹è­¯æœ¬å¿«å–`;
            this.settingsModal.isError = false;
          } catch (e) {
            console.error('Failed to clear cache:', e);
            this.settingsModal.message = 'æ¸…é™¤å¿«å–å¤±æ•—ï¼š' + e.message;
            this.settingsModal.isError = true;
          }
        },

        // Auto-sync on data changes (call after saving notes/titles)
        async triggerAutoSync() {
          if (this.autoSync && this.fileHandle && this.hasFileSystemAccess) {
            try {
              // Verify permission before writing
              const hasPermission = await this.verifyPermission(true);
              if (!hasPermission) {
                console.warn('Auto-sync skipped: permission denied');
                return;
              }

              const zipBlob = await this.generateBackupZip();

              const writable = await this.fileHandle.createWritable();
              await writable.write(zipBlob);
              await writable.close();
              console.log('Auto-synced to file');
            } catch (e) {
              console.warn('Auto-sync failed:', e);
            }
          }
        },

        // Strong's Number support
        // Check if current version has Strong's Numbers
        get hasSN() {
          return this.selectedVersionId.includes('-SN') || this.selectedVersionId.includes('_SN');
        },

        // Get dictionary file name for current version
        getDictFileName() {
          // For SN versions, the dict file should match the version
          // e.g., zh-rTW_CUV-SN -> zh-rTW_CUV-SN.dict
          // e.g., en_KJV-SN -> en_KJV-SN.dict
          return `${this.selectedVersionId}.dict`;
        },

        // Load dictionary for a specific version (or current version if not specified)
        // Stores raw text instead of parsing into map - uses regex lookup on demand
        async loadDictionary(versionId = null) {
          const targetVersionId = versionId || this.selectedVersionId;
          const isSNVersion = targetVersionId && targetVersionId.includes('-SN');

          if (!isSNVersion) return;
          if (this.snDictTexts[targetVersionId]) return; // Already loaded

          this.snDictLoading = true;

          try {
            // Try to load from cache first
            const cacheKey = `bible_dict_${targetVersionId}`;
            let dictText = await idbKeyval.get(cacheKey);

            if (!dictText) {
              // Fetch from network
              const dictFile = `${targetVersionId}.dict`;
              const response = await fetch(`./dict/${dictFile}`);
              if (!response.ok) {
                console.warn(`Dictionary not found: ${dictFile}`);
                return;
              }
              dictText = await response.text();

              // Cache it
              try {
                await idbKeyval.set(cacheKey, dictText);
              } catch (e) {
                console.warn('Failed to cache dictionary:', e);
              }
            }

            // Store raw text - will use regex to find definitions on demand
            this.snDictTexts[targetVersionId] = dictText;
            console.log(`Loaded dictionary text for ${targetVersionId}`);
          } catch (e) {
            console.error('Failed to load dictionary:', e);
          } finally {
            this.snDictLoading = false;
          }
        },

        // Render verse text with clickable SN codes
        renderVerseText(text) {
          if (!this.hasSN || !text) {
            // Escape HTML for safety
            return this.escapeHtml(text);
          }

          // Match Strong's Number patterns: <H####> or <G####>
          // H = Hebrew (OT), G = Greek (NT)
          const snPattern = /<([HG]\d+)>/g;

          // Replace SN codes with clickable spans
          return text.replace(snPattern, (match, code) => {
            return `<span class="sn-code" onclick="Alpine.$data(document.querySelector('[x-data]')).showSNDefinition('${code}')">${code}</span>`;
          });
        },

        // Render comparison verse text - check if the version has SN codes
        renderCompareVerseText(text, versionId) {
          if (!text) return '';

          // Check if this version is a Strong's Number version
          const isSNVersion = versionId && versionId.includes('-SN');

          if (!isSNVersion) {
            return this.escapeHtml(text);
          }

          // Match Strong's Number patterns: <H####> or <G####>
          const snPattern = /<([HG]\d+)>/g;

          // Replace SN codes with clickable spans
          // Dictionary language is determined by selected version, not the clicked version
          return text.replace(snPattern, (match, code) => {
            return `<span class="sn-code" onclick="Alpine.$data(document.querySelector('[x-data]')).showSNDefinition('${code}')">${code}</span>`;
          });
        },

        // Escape HTML to prevent XSS
        escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        },

        // Show SN definition modal
        // Uses dictionary based on current selected version's language (Chinese or English)
        async showSNDefinition(code) {
          this.snModal.show = true;
          this.snModal.code = code;
          this.snModal.definition = '';
          this.snModal.loading = true;
          this.$refs.snDialog.showModal();

          // Determine dictionary based on selected version's language
          // Chinese versions start with 'zh', use Chinese SN dictionary
          // Otherwise use English SN dictionary
          const isChineseVersion = this.selectedVersionId.startsWith('zh');
          const dictVersionId = isChineseVersion ? 'zh-rTW_CUV-SN' : 'en_KJV-SN';

          // Load dictionary if not loaded
          if (!this.snDictTexts[dictVersionId]) {
            await this.loadDictionary(dictVersionId);
          }

          this.snModal.loading = false;

          // Look up definition using regex on raw text
          // Dictionary format: CODE,definition (one per line)
          const dictText = this.snDictTexts[dictVersionId];
          if (dictText) {
            const regex = new RegExp(`^${code},(.*)$`, 'm');
            const match = dictText.match(regex);
            if (match) {
              this.snModal.definition = this.formatDefinition(match[1]);
            }
          }
        },

        // Format definition for display
        formatDefinition(definition) {
          if (!definition) return '';

          // Replace literal \n with actual line breaks
          let formatted = definition.replace(/\\n/g, '\n');

          // Process special links BEFORE escaping HTML
          // Pattern: <SN|display_text|code> -> clickable SN link
          // Pattern: <Verse|display_text|BOOK:chapter:verse> -> clickable verse link
          // Pattern: #<Verse|...|...>| -> verse with # prefix and | suffix

          // First, replace the patterns with placeholders to protect them from HTML escaping
          const snLinks = [];
          const verseLinks = [];

          // Extract SN links: <SN|display|code>
          formatted = formatted.replace(/<SN\|([^|]+)\|([^>]+)>/g, (match, display, code) => {
            const index = snLinks.length;
            snLinks.push({ display, code });
            return `__SN_LINK_${index}__`;
          });

          // Extract Verse links: <Verse|display|BOOK:chapter:verse> or #<Verse|...|...>|
          formatted = formatted.replace(/#?<Verse\|([^|]+)\|([^>]+)>\|?/g, (match, display, ref) => {
            const index = verseLinks.length;
            verseLinks.push({ display, ref });
            return `__VERSE_LINK_${index}__`;
          });

          // Escape HTML
          formatted = this.escapeHtml(formatted);

          // Restore SN links as clickable elements
          snLinks.forEach((link, index) => {
            const escapedDisplay = this.escapeHtml(link.display);
            const clickHandler = `Alpine.$data(document.querySelector('[x-data]')).showSNDefinition('${link.code}')`;
            formatted = formatted.replace(
              `__SN_LINK_${index}__`,
              `<span class="sn-link" onclick="${clickHandler}">${escapedDisplay}</span>`
            );
          });

          // Restore Verse links as clickable elements
          verseLinks.forEach((link, index) => {
            const escapedDisplay = this.escapeHtml(link.display);
            const clickHandler = `Alpine.$data(document.querySelector('[x-data]')).goToVerseByRef('${link.ref}')`;
            formatted = formatted.replace(
              `__VERSE_LINK_${index}__`,
              `<span class="verse-link" onclick="${clickHandler}">${escapedDisplay}</span>`
            );
          });

          // Convert newlines to <br>
          formatted = formatted.replace(/\n/g, '<br>');

          return formatted;
        },

        // Navigate to verse by reference string (e.g., "ISA:59:9" or "MAT:15:23")
        goToVerseByRef(ref) {
          // Parse format: BOOK:chapter:verse or BOOK:chapter
          const parts = ref.split(':');
          if (parts.length < 2) return;

          const rawBookCode = parts[0];
          const chapter = parseInt(parts[1]);
          const verseNum = parts.length > 2 ? parseInt(parts[2]) : 1;

          // Normalize book code to canonical form
          const bookCode = normalizeBookCode(rawBookCode);
          if (!this.books.includes(bookCode)) {
            console.warn(`Book not found: ${rawBookCode} -> ${bookCode}`);
            return;
          }

          // Close modal and navigate
          this.snModal.show = false;
          this.selectedBook = bookCode;
          this.updateChapters();

          if (this.chapters.includes(chapter)) {
            this.selectedChapter = chapter;
          } else {
            this.selectedChapter = this.chapters[0] || 1;
          }

          this.loadVerses();
          this.saveReadingPosition();

          // Scroll to and highlight the verse after DOM updates
          this.$nextTick(() => {
            this.scrollToAndHighlightVerse(verseNum);
          });
        },

        // Scroll to a specific verse and highlight it
        scrollToAndHighlightVerse(verseNum) {
          setTimeout(() => {
            const verseElement = document.querySelector(`[data-verse-num="${verseNum}"]`);
            if (verseElement) {
              const headerHeight = 80;
              const elementTop = verseElement.getBoundingClientRect().top + window.scrollY;
              window.scrollTo({
                top: elementTop - headerHeight - 20,
                behavior: 'smooth'
              });

              // Restart verse highlight animation
              verseElement.classList.remove('verse-highlight');
              void verseElement.offsetWidth;
              verseElement.classList.add('verse-highlight');
            }
          }, 100);
        },

        // === Reading History Methods ===
        // Load reading history from IndexedDB
        async loadReadingHistory() {
          const savedHistory = await this._storageLoad('bible_readingHistory');
          if (savedHistory && Array.isArray(savedHistory)) {
            this.readingHistory = savedHistory;
          }
        },

        async saveReadingHistory() {
          const value = JSON.parse(JSON.stringify(this.readingHistory));
          await this._storageSave('bible_readingHistory', value);
        },

        // Add a new entry to reading history
        addToReadingHistory(bookCode, chapter) {
          if (!bookCode || !chapter) return;

          // Skip recording during initial load
          if (this._skipHistoryRecording) return;

          // Check if this book+chapter is already the most recent entry
          if (this.readingHistory.length > 0) {
            const mostRecent = this.readingHistory[0];
            if (mostRecent.bookCode === bookCode && mostRecent.chapter === chapter) {
              // Update timestamp of existing most recent entry
              mostRecent.timestamp = Date.now();
              this.saveReadingHistory();
              return;
            }
          }

          // Remove any existing entry for the same book+chapter
          this.readingHistory = this.readingHistory.filter(
            item => !(item.bookCode === bookCode && item.chapter === chapter)
          );

          // Add new entry at the beginning
          this.readingHistory.unshift({
            bookCode,
            chapter,
            timestamp: Date.now()
          });

          // Limit to 50 entries
          if (this.readingHistory.length > 50) {
            this.readingHistory = this.readingHistory.slice(0, 50);
          }

          this.saveReadingHistory();
        },

        // Navigate to a history item
        goToHistoryItem(item) {
          this.selectedBook = item.bookCode;
          this.updateChapters();
          if (this.chapters.includes(item.chapter)) {
            this.selectedChapter = item.chapter;
          } else {
            this.selectedChapter = this.chapters[0] || 1;
          }
          this.loadVerses();
          this.$refs.historyDialog?.close();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        // Remove a single history item
        removeHistoryItem(index) {
          this.readingHistory.splice(index, 1);
          this.saveReadingHistory();
        },

        // Clear all reading history
        clearReadingHistory() {
          this.readingHistory = [];
          this.saveReadingHistory();
        },

        // Format timestamp for display
        formatHistoryTime(timestamp) {
          if (!timestamp) return '';

          const now = Date.now();
          const diff = now - timestamp;
          const minutes = Math.floor(diff / 60000);
          const hours = Math.floor(diff / 3600000);
          const days = Math.floor(diff / 86400000);

          if (minutes < 1) return 'å‰›æ‰';
          if (minutes < 60) return `${minutes} åˆ†é˜å‰`;
          if (hours < 24) return `${hours} å°æ™‚å‰`;
          if (days < 7) return `${days} å¤©å‰`;

          // For older entries, show date
          const date = new Date(timestamp);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        }
      };
    }
  </script>
</body>

</html>