<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, interactive-widget=resizes-content" >
  <title>bible-pwa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/idb-keyval@6/dist/umd.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- <script src="src/bible.js"></script> -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* === Essential: Alpine.js cloak === */
    [x-cloak] { display: none !important; }

    /* === Theme: CSS Variables === */
    :root {
      --bg-primary: #faf8f5;
      --bg-secondary: #f0ebe3;
      --text-primary: #2c2416;
      --text-secondary: #6b5d4d;
      --accent: #8b4513;
      --accent-light: #d4a574;
      --border: #e0d5c7;
    }
    .dark {
      --bg-primary: #1a1612;
      --bg-secondary: #2a2420;
      --text-primary: #e8e0d5;
      --text-secondary: #a89a88;
      --accent: #d4a574;
      --accent-light: #8b6543;
      --border: #3d352d;
    }

    /* === Theme: Utility classes using CSS vars === */
    body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
    .bg-primary { background-color: var(--bg-primary); }
    .bg-secondary { background-color: var(--bg-secondary); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-accent { color: var(--accent); }
    .bg-accent { background-color: var(--accent); }
    .border-accent { border-color: var(--accent); }
    .border-accent-light { border-color: var(--accent-light); }
    .border-custom { border-color: var(--border); }

    /* === Scrollbar (no Tailwind equivalent) === */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: var(--bg-secondary); }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--accent-light); border-radius: 3px; }

    /* === Animations === */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .verse-item { opacity: 0; animation: fadeIn 0.4s ease-out forwards; }

    @keyframes verseHighlight {
      0% { box-shadow: inset 0 0 0 3px var(--accent), 0 0 20px rgba(139, 69, 19, 0.3); }
      100% { box-shadow: inset 0 0 0 0 transparent, 0 0 0 transparent; }
    }
    .verse-highlight { animation: verseHighlight 2s ease-out forwards; border-radius: 0.5rem; background-color: var(--bg-secondary) !important; opacity: 1 !important; }

    /* === Components using CSS vars (can't fully convert to Tailwind) === */
    .section-title { color: var(--accent); font-weight: 700; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 200; }
    .modal-content { background-color: var(--bg-primary); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; width: 90%; max-width: 400px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); }
    .verse-container { user-select: none; -webkit-user-select: none; cursor: pointer; transition: box-shadow 0.2s ease, border-radius 0.2s ease; }
    .verse-selected { box-shadow: inset 0 0 0 2px var(--accent-light), inset 0 2px 8px rgba(139, 69, 19, 0.15); border-radius: 0.5rem; padding: 0.25rem 0.5rem; margin: -0.25rem -0.5rem; }

    /* === Dynamic content styles (used in x-html, can't use Tailwind) === */
    .sn-code { color: var(--accent); cursor: pointer; text-decoration: underline; text-decoration-style: dotted; transition: color 0.2s; margin: 0 0.15em; }
    .sn-code:hover { color: var(--accent-light); text-decoration-style: solid; }
    .sn-link { color: var(--accent); cursor: pointer; text-decoration: underline; text-decoration-style: dotted; transition: color 0.2s; }
    .sn-link:hover { color: var(--accent-light); text-decoration-style: solid; }
    .verse-link { color: #4a90d9; cursor: pointer; text-decoration: underline; transition: color 0.2s, background-color 0.2s; padding: 0 2px; border-radius: 2px; }
    .dark .verse-link { color: #6bb3ff; }
    .verse-link:hover { background-color: rgba(74, 144, 217, 0.15); }
    .search-highlight { background-color: #fef08a; color: #854d0e; padding: 0.1em 0.2em; border-radius: 0.2em; }
    .dark .search-highlight { background-color: #854d0e; color: #fef9c3; }

    /* Drawer panel - full height on mobile, partial on larger screens */
    .drawer-panel {
      height: 85dvh;
      max-height: 85dvh;
    }
    @media (min-width: 640px) {
      .drawer-panel {
        height: auto;
        max-height: 75dvh;
      }
    }
  </style>
  <script type="module" crossorigin src="/bible-pwa-gh-page/assets/index-CguE1ih5.js"></script>
<link rel="manifest" href="/bible-pwa-gh-page/manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<link rel="icon" href="/bible-pwa-gh-page/favicon.ico" sizes="48x48">
<link rel="icon" href="/bible-pwa-gh-page/favicon.svg" sizes="any" type="image/svg+xml">
<link rel="apple-touch-icon" href="/bible-pwa-gh-page/apple-touch-icon-180x180.png"></head>

<body class="min-h-screen" x-data="bibleReader()" :class="{ 'overflow-hidden': isAnyDrawerOpen }">

  <div id="app" :style="`zoom: ${zoom / 100};`"
    @touchstart="handlePinchStart($event)"
    @touchmove="handlePinchMove($event)"
    @touchend="handlePinchEnd($event)"
    @touchcancel="handlePinchEnd($event)">
      <!-- Header -->
  <header class="bg-primary sticky top-0 z-50">
    <!-- Top Row: Navigation & Controls -->
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">

      <!-- Left: Menu placeholder for balance -->
      <div class="w-10"></div>

      <!-- Center: Book/Chapter & Version -->
      <div class="flex items-center gap-3">
        <!-- Location -->
        <button @click="navModal.tab = 'chapters'; resetChapterRange(); navModal.show = true"
          class="flex items-center gap-1 py-1.5 hover:opacity-70 transition-opacity">
          <span class="text-base font-medium text-primary" x-text="selectedBookName + ' ' + selectedChapter + ' ç« '"></span>
          <svg class="w-3.5 h-3.5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <!-- Vertical Divider -->
        <div class="w-px h-4" style="background-color: var(--border);"></div>

        <!-- Version -->
        <button @click="versionModal.tab = 'select'; versionModal.show = true"
          class="flex items-center gap-1 py-1.5 hover:opacity-70 transition-opacity">
          <span class="text-base text-secondary" x-text="currentVersion.name"></span>
          <svg class="w-3.5 h-3.5 text-secondary opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
      </div>

      <!-- Right: Actions -->
      <div class="flex items-center gap-1">
        <button @click="headerSearchOpen = !headerSearchOpen; if (!headerSearchOpen) { searchQuery = ''; searchResults = []; } else { $nextTick(() => $refs.headerSearchInput?.focus()); }"
          :class="headerSearchOpen ? 'text-accent bg-secondary' : 'text-secondary'"
          class="p-2 rounded-full hover:bg-secondary transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </button>
        <button @click="settingsModal.show = true" class="p-2 rounded-full hover:bg-secondary text-secondary transition-colors" title="è¨­å®š">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Expandable Search Bar -->
    <div class="overflow-hidden transition-all duration-300 ease-in-out"
      :class="headerSearchOpen ? 'max-h-20 opacity-100' : 'max-h-0 opacity-0'">
      <div class="max-w-4xl mx-auto px-4 pt-2 pb-3">
        <div class="relative">
          <input type="text" x-model="searchQuery" @input="search()" placeholder="æœå°‹ç¶“æ–‡..."
            x-ref="headerSearchInput"
            class="w-full bg-secondary border border-custom rounded-lg py-2 pl-4 pr-10 text-sm text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-accent/30 shadow-inner">
          <button x-show="searchQuery" @click="clearSearch()"
            class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-secondary hover:text-primary">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Subtle bottom border -->
    <div class="h-px w-full opacity-50" style="background: linear-gradient(to right, transparent, var(--border), transparent);"></div>
  </header>

  <main class="max-w-4xl mx-auto px-2 sm:px-4 py-4">
    <!-- Verses Display -->
    <div class="py-2 min-h-[400px]">
      <!-- Search Results -->
      <template x-if="searchQuery && searchResults.length > 0">
        <div :style="`display: flex; flex-direction: column; gap: ${verseSpacing}px;`">
          <h2 class="text-lg font-semibold text-accent">
            æœå°‹çµæœ (<span x-text="searchResults.length"></span> ç­†)
          </h2>
          <template x-for="(verse, index) in searchResults.slice(0, 100)" :key="'search-' + index">
            <div class="verse-item pl-3 border-l-2 border-custom hover:border-accent cursor-pointer transition-colors"
              :style="'animation-delay: ' + (index * 30) + 'ms'"
              @click="goToVerse(verse)">
              <!-- Reference as section title -->
              <div class="section-title"
                :style="`font-size: ${fontSize}rem; font-family: ${currentFontFamily}; margin-bottom: ${verseSpacing * 0.25}px;`"
                x-html="highlightSearch(formatRef(verse.ref))"></div>
              <!-- Verse text -->
              <div :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
                class="text-primary"
                x-html="highlightSearch(verse.text)"></div>
            </div>
          </template>
          <p x-show="searchResults.length > 100" class="text-secondary text-sm text-center">
            é¡¯ç¤ºå‰ 100 ç­†çµæœï¼Œå…± <span x-text="searchResults.length"></span> ç­†
          </p>
        </div>
      </template>

      <!-- No Search Results -->
      <template x-if="searchQuery && searchResults.length === 0">
        <div class="flex flex-col items-center justify-center py-16 text-secondary">
          <span class="text-4xl mb-4">ğŸ“­</span>
          <p>æ‰¾ä¸åˆ°ç¬¦åˆçš„ç¶“æ–‡</p>
        </div>
      </template>

      <!-- Chapter Verses -->
      <template x-if="!searchQuery">
        <div :style="`display: flex; flex-direction: column; gap: ${verseSpacing}px;`">
          <template x-for="(verse, index) in currentVerses" :key="'verse-' + index">
            <div>
              <!-- Section Title (displayed before the verse, click to edit) -->
              <div x-show="customTitles[verse.ref]"
                @click.stop="openTitleModalForVerse(verse)"
                class="section-title cursor-pointer hover:opacity-70 transition-opacity"
                :style="`font-size: ${fontSize}rem; font-family: ${currentFontFamily}; margin-top: ${verseSpacing * 0.75}px; margin-bottom: ${verseSpacing * 0.5}px;`"
                x-text="customTitles[verse.ref]"></div>
              <!-- Verse Container -->
              <div class="verse-item verse-container"
                :data-verse-num="verse.verseNum"
                :class="{ 'verse-selected': verseActions.show && verseActions.verse?.ref === verse.ref }"
                :style="`animation-delay: ${index * 50}ms; font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};` + (getHighlightColor(verse.ref) ? `background-color: ${getHighlightColor(verse.ref)}30;` : '')"
                @click="showVerseActions(verse)"
                @contextmenu.prevent="showVerseActions(verse)">
                <sup class="text-accent font-medium opacity-70" style="font-size: 0.75em; margin-right: 0em;" x-text="verse.verseNum"></sup>
                <span x-html="renderVerseText(verse.text)"></span>
                <button x-show="notes[verse.ref]" @click.stop="openNoteModal(verse)"
                  class="inline-flex ml-1 opacity-70 hover:opacity-100" title="æŸ¥çœ‹ç­†è¨˜">âœï¸</button>
              </div>
              <!-- Comparison Verses -->
              <template x-if="compareVerseRef === verse.ref && compareVerses.length > 0">
                <div x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 -translate-y-2"
                  x-transition:enter-end="opacity-100 translate-y-0"
                  class="mt-2 pl-1 border-l-2 border-accent/30 flex flex-col"
                  :style="`gap: ${verseSpacing * 0.5}px;`">
                  <template x-for="(cv, cvIdx) in compareVerses" :key="'compare-' + cvIdx">
                    <div class="py-1">
                      <div class="text-accent text-base font-medium mb-1" x-text="cv.versionName"></div>
                      <div class="text-primary"
                        :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
                        x-html="renderCompareVerseText(cv.text, cv.versionId)"></div>
                    </div>
                  </template>
                  <!-- Close button -->
                  <button @click.stop="compareVerseRef = null; compareVerses = []"
                    class="self-start text-sm text-secondary hover:text-accent transition-colors">
                    âœ• é—œé–‰å°ç…§
                  </button>
                </div>
              </template>
              <!-- No other versions message -->
              <template x-if="compareVerseRef === verse.ref && compareVerses.length === 0 && cachedVersions.length <= 1">
                <div class="mt-2 pl-4 border-l-2 border-accent/30 py-2 text-secondary text-sm">
                  <p>å°šæœªä¸‹è¼‰å…¶ä»–è­¯æœ¬ã€‚è«‹è‡³è¨­å®šä¸­ä¸‹è¼‰å…¶ä»–è­¯æœ¬ä»¥ä½¿ç”¨å°ç…§åŠŸèƒ½ã€‚</p>
                  <button @click.stop="compareVerseRef = null"
                    class="mt-1 text-accent hover:underline">é—œé–‰</button>
                </div>
              </template>
            </div>
          </template>

          <!-- Chapter Navigation (at end of verses) -->
          <div x-show="currentVerses.length > 0" class="flex justify-between items-center mt-8 pt-6 border-t border-custom">
            <button @click="prevChapter()" :disabled="!canGoPrev"
              :class="canGoPrev ? 'hover:bg-primary border-custom' : 'opacity-40 cursor-not-allowed border-transparent'"
              class="flex items-center gap-2 px-4 py-3 rounded-lg border transition-colors text-secondary">
              <span>â†</span>
              <span>ä¸Šä¸€ç« </span>
            </button>

            <button @click="nextChapter()" :disabled="!canGoNext"
              :class="canGoNext ? 'hover:bg-primary border-custom' : 'opacity-40 cursor-not-allowed border-transparent'"
              class="flex items-center gap-2 px-4 py-3 rounded-lg border transition-colors text-secondary">
              <span>ä¸‹ä¸€ç« </span>
              <span>â†’</span>
            </button>
          </div>

          <!-- Empty State -->
          <div x-show="currentVerses.length === 0 && !isLoading"
            class="flex flex-col items-center justify-center py-16 text-secondary">
            <span class="text-4xl mb-4">ğŸ“–</span>
            <p>é¸æ“‡æ›¸å·å’Œç« ç¯€é–‹å§‹é–±è®€</p>
          </div>

          <!-- Loading State -->
          <div x-show="isLoading" class="flex flex-col items-center justify-center py-16 text-secondary">
            <div class="relative mb-4">
              <span class="text-4xl animate-pulse">ğŸ“¥</span>
            </div>
            <p class="font-medium text-primary mb-2" x-text="loadingMessage"></p>
            <p x-show="loadingSubMessage" class="text-sm" x-text="loadingSubMessage"></p>
          </div>
        </div>
      </template>
    </div>

  </main>

  <!-- Verse Actions Widget Backdrop -->
  <div x-cloak x-show="verseActions.show"
    @click="hideVerseActions()"
    class="fixed inset-0 z-[149]"></div>

  <!-- Verse Actions Widget -->
  <div x-cloak x-show="verseActions.show"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 translate-y-4"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-4"
    class="fixed bottom-20 left-1/2 -translate-x-1/2 z-[150] pointer-events-none w-[90%] max-w-[320px]">
    <div class="pointer-events-auto bg-black/85 backdrop-blur-md text-white rounded-2xl shadow-2xl overflow-hidden"
      @click.stop>

      <!-- Verse Reference Header -->
      <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
        <span class="font-medium" x-text="verseActions.verse ? formatRef(verseActions.verse.ref) : ''"></span>
        <!-- Highlight indicator -->
        <div x-show="verseActions.verse && verseHighlights[verseActions.verse.ref] && highlightDefs[verseHighlights[verseActions.verse.ref]]"
          class="flex items-center gap-2 text-sm"
          :style="verseActions.verse ? `color: ${getHighlightColor(verseActions.verse.ref)}` : ''">
          <span class="w-2 h-2 rounded-full" :style="verseActions.verse ? `background-color: ${getHighlightColor(verseActions.verse.ref)}` : ''"></span>
          <span x-text="verseActions.verse && highlightDefs[verseHighlights[verseActions.verse.ref]]?.name"></span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex">
        <button @click="openTitleModal()"
          class="flex-1 py-4 flex flex-col items-center gap-1 hover:bg-white/10 transition-colors active:scale-95">
          <span class="text-xl">ğŸ·ï¸</span>
          <span class="text-sm">æ¨™é¡Œ</span>
        </button>
        <button @click="openNoteModal()"
          class="flex-1 py-4 flex flex-col items-center gap-1 hover:bg-white/10 transition-colors active:scale-95">
          <span class="text-xl">ğŸ“</span>
          <span class="text-sm">ç­†è¨˜</span>
        </button>
        <button @click="openHighlightModal()"
          class="flex-1 py-4 flex flex-col items-center gap-1 hover:bg-white/10 transition-colors active:scale-95">
          <span class="text-xl">ğŸ¨</span>
          <span class="text-sm">æ¨™è¨»</span>
        </button>
        <button @click="toggleCompare()"
          :class="compareVerseRef === verseActions.verse?.ref ? 'bg-white/20' : ''"
          class="flex-1 py-4 flex flex-col items-center gap-1 hover:bg-white/10 transition-colors active:scale-95">
          <span class="text-xl">ğŸ“š</span>
          <span class="text-sm">å°ç…§</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Title Input Drawer (Bottom Sheet) -->
  <div x-cloak x-show="titleModal.show"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[200] bg-black/40" @click.self="closeTitleModal()">
    <!-- Drawer Panel - uses top positioning to stay visible when keyboard opens -->
    <div x-show="titleModal.show"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
      x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-y-0"
      x-transition:leave-end="translate-y-full"
      class="fixed left-1/2 -translate-x-1/2 bottom-0 w-full max-w-2xl shadow-2xl flex flex-col rounded-t-2xl drawer-panel"
      style="background-color: var(--bg-primary);">
      <!-- Drag Handle -->
      <div class="flex-shrink-0 flex justify-center py-2">
        <div class="w-10 h-1 rounded-full" style="background-color: var(--border);"></div>
      </div>
      <!-- Header -->
      <div class="flex-shrink-0 flex items-center justify-between px-4 pb-3 border-b" style="border-color: var(--border);">
        <h3 class="font-semibold text-accent flex items-center gap-1"
          :style="`font-size: ${fontSize}rem;`">
          <span>âœï¸</span>
          <span>è‡ªè¨‚æ¨™é¡Œ</span>
          <span class="text-secondary font-normal" x-text="titleModal.verse ? ' - ' + formatRef(titleModal.verse.ref) : ''"></span>
        </h3>
        <button @click="closeTitleModal()"
          class="p-2 hover:bg-secondary rounded-full transition-colors flex-shrink-0">
          <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Verse Reference - scrollable, height for 2 lines -->
      <div x-show="titleModal.verse" class="flex-shrink-0 px-4 py-2 border-b overflow-y-auto scrollbar-thin"
        :style="`border-color: var(--border); background-color: var(--bg-secondary); max-height: calc(${fontSize * 2}rem * ${lineHeight} + 1rem);`">
        <p class="text-primary"
          :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
          x-html="titleModal.verse ? renderVerseText(titleModal.verse.text) : ''"></p>
      </div>
      <!-- Content -->
      <div class="flex-1 flex flex-col p-4 overflow-hidden min-h-0">
        <input type="text" x-model="titleModal.title" x-ref="titleInput" @keydown.enter="saveTitle()"
          @keydown.escape="closeTitleModal()" placeholder="è¼¸å…¥æ¨™é¡Œ..."
          :style="`font-size: ${fontSize}rem; font-family: ${currentFontFamily};`"
          class="flex-shrink-0 w-full px-4 py-3 rounded-lg bg-secondary border border-custom text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-amber-600">
        <div class="flex-1 min-h-0"></div>
        <div class="flex-shrink-0 flex justify-end gap-3 mt-4">
          <button @click="closeTitleModal()"
            class="px-4 py-2 rounded-lg text-secondary hover:bg-secondary transition-colors">
            å–æ¶ˆ
          </button>
          <button @click="saveTitle()" class="px-4 py-2 rounded-lg text-white transition-colors"
            style="background-color: var(--accent);">
            å„²å­˜
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Note Input Drawer (Bottom Sheet) -->
  <div x-cloak x-show="noteModal.show"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[200] bg-black/40" @click.self="closeNoteModal()">
    <!-- Drawer Panel -->
    <div x-show="noteModal.show"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
      x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-y-0"
      x-transition:leave-end="translate-y-full"
      class="fixed left-1/2 -translate-x-1/2 bottom-0 w-full max-w-2xl shadow-2xl flex flex-col rounded-t-2xl drawer-panel"
      style="background-color: var(--bg-primary);">
      <!-- Drag Handle -->
      <div class="flex-shrink-0 flex justify-center py-2">
        <div class="w-10 h-1 rounded-full" style="background-color: var(--border);"></div>
      </div>
      <!-- Header -->
      <div class="flex-shrink-0 flex items-center justify-between px-4 pb-3 border-b" style="border-color: var(--border);">
        <h3 class="font-semibold text-accent flex items-center gap-1"
          :style="`font-size: ${fontSize}rem;`">
          <span>ğŸ“</span>
          <span>ç­†è¨˜</span>
          <span class="text-secondary font-normal" x-text="noteModal.verse ? ' - ' + formatRef(noteModal.verse.ref) : ''"></span>
        </h3>
        <button @click="closeNoteModal()"
          class="p-2 hover:bg-secondary rounded-full transition-colors flex-shrink-0">
          <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Verse Reference - scrollable, height for 2 lines -->
      <div x-show="noteModal.verse" class="flex-shrink-0 px-4 py-2 border-b overflow-y-auto scrollbar-thin"
        :style="`border-color: var(--border); background-color: var(--bg-secondary); max-height: calc(${fontSize * 2}rem * ${lineHeight} + 1rem);`">
        <p class="text-primary"
          :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
          x-html="noteModal.verse ? renderVerseText(noteModal.verse.text) : ''"></p>
      </div>
      <!-- Content -->
      <div class="flex-1 flex flex-col p-4 overflow-hidden min-h-0">
        <textarea x-model="noteModal.note" x-ref="noteInput" @keydown.escape="closeNoteModal()" placeholder="è¼¸å…¥ç­†è¨˜..."
          :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`"
          class="flex-1 w-full px-4 py-3 rounded-lg bg-secondary border border-custom text-primary placeholder:text-secondary focus:outline-none focus:ring-2 focus:ring-amber-600 resize-none min-h-[80px]"></textarea>
        <div class="flex-shrink-0 flex justify-end gap-3 mt-4">
          <button @click="closeNoteModal()"
            class="px-4 py-2 rounded-lg text-secondary hover:bg-secondary transition-colors">
            å–æ¶ˆ
          </button>
          <button @click="saveNote()" class="px-4 py-2 rounded-lg text-white transition-colors"
            style="background-color: var(--accent);">
            å„²å­˜
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Highlight Modal -->
  <div x-cloak x-show="highlightModal.show"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[200] bg-black/40" @click.self="closeHighlightModal()">
    <!-- Drawer Panel -->
    <div x-show="highlightModal.show"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
      x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-y-0"
      x-transition:leave-end="translate-y-full"
      class="fixed left-1/2 -translate-x-1/2 bottom-0 w-full max-w-2xl shadow-2xl flex flex-col rounded-t-2xl drawer-panel"
      style="background-color: var(--bg-primary);">
      <!-- Drag Handle -->
      <div class="flex justify-center py-2">
        <div class="w-10 h-1 rounded-full" style="background-color: var(--border);"></div>
      </div>
      <!-- Header -->
      <div class="flex items-center justify-between px-4 pb-3 border-b" style="border-color: var(--border);">
        <h3 class="text-lg font-semibold text-accent">ğŸ¨ æ¨™è¨»</h3>
        <button @click="closeHighlightModal()" class="p-2 hover:bg-secondary rounded-full transition-colors">
          <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Verse Reference -->
      <div class="px-4 py-2 border-b" style="border-color: var(--border); background-color: var(--bg-secondary);">
        <p class="text-secondary text-sm" x-text="highlightModal.verse ? formatRef(highlightModal.verse.ref) : ''"></p>
      </div>
      <!-- Content -->
      <div class="flex-1 overflow-y-auto p-4 scrollbar-thin">
        <!-- Highlight List -->
        <div class="space-y-2 mb-4">
          <template x-for="(def, id) in highlightDefs" :key="id">
            <div class="flex items-center gap-2">
              <!-- Edit Mode -->
              <template x-if="highlightModal.editingId === id">
                <div class="flex-1 flex items-center gap-2 p-2 rounded-lg bg-secondary">
                  <input type="color" x-model="highlightModal.editColor" class="w-8 h-8 rounded cursor-pointer border-0">
                  <input type="text" x-model="highlightModal.editName" @keydown.enter="saveHighlightEdit(id)" @keydown.escape="cancelHighlightEdit()"
                    class="flex-1 px-2 py-1 rounded bg-primary border border-custom text-primary text-sm focus:outline-none focus:ring-1 focus:ring-amber-600"
                    style="font-size: 16px;">
                  <button @click="saveHighlightEdit(id)" class="p-1 text-green-600 hover:bg-green-100 dark:hover:bg-green-900/30 rounded" title="å„²å­˜">âœ“</button>
                  <button @click="cancelHighlightEdit()" class="p-1 text-secondary hover:bg-primary rounded" title="å–æ¶ˆ">âœ•</button>
                </div>
              </template>
              <!-- View Mode -->
              <template x-if="highlightModal.editingId !== id">
                <div class="flex-1 flex items-center gap-2">
                  <button @click="applyHighlight(id)"
                    class="flex-1 flex items-center gap-3 p-3 rounded-lg border border-custom hover:bg-secondary transition-colors text-left"
                    :class="verseHighlights[highlightModal.verse?.ref] === id ? 'ring-2 ring-amber-500' : ''">
                    <span class="w-6 h-6 rounded-full flex-shrink-0" :style="`background-color: ${def.color}`"></span>
                    <span class="font-medium text-primary" x-text="def.name"></span>
                    <span x-show="verseHighlights[highlightModal.verse?.ref] === id" class="ml-auto text-amber-600 text-sm">âœ“ å·²å¥—ç”¨</span>
                  </button>
                  <button @click="startHighlightEdit(id)" class="p-2 text-secondary hover:bg-secondary rounded-lg transition-colors" title="ç·¨è¼¯">
                    âœï¸
                  </button>
                  <button x-show="Object.keys(highlightDefs).length > 1" @click="deleteHighlight(id)"
                    class="p-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors" title="åˆªé™¤">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </template>
            </div>
          </template>
        </div>

        <!-- Add New Highlight -->
        <button @click="addNewHighlight()"
          class="w-full flex items-center justify-center gap-2 p-3 rounded-lg border border-dashed border-custom hover:bg-secondary transition-colors text-secondary">
          <span>+</span>
          <span>æ–°å¢æ¨™è¨»</span>
        </button>

        <!-- Remove Highlight from Verse -->
        <button x-show="verseHighlights[highlightModal.verse?.ref]" @click="removeHighlightFromVerse()"
          class="w-full mt-3 flex items-center justify-center gap-2 p-2 rounded-lg text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors text-sm">
          <span>ç§»é™¤æ­¤ç¶“æ–‡çš„æ¨™è¨»</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Strong's Number Definition Drawer (Bottom Sheet) -->
  <div x-cloak x-show="snModal.show"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[200] bg-black/40" @click.self="snModal.show = false">
    <!-- Drawer Panel -->
    <div x-show="snModal.show"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
      x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-y-0"
      x-transition:leave-end="translate-y-full"
      class="fixed left-1/2 -translate-x-1/2 bottom-0 w-full max-w-2xl shadow-2xl flex flex-col rounded-t-2xl drawer-panel"
      style="background-color: var(--bg-primary);">
      <!-- Drag Handle -->
      <div class="flex-shrink-0 flex justify-center py-2">
        <div class="w-10 h-1 rounded-full" style="background-color: var(--border);"></div>
      </div>
      <!-- Header -->
      <div class="flex-shrink-0 flex items-center justify-between px-4 pb-3 border-b" style="border-color: var(--border);">
        <h3 class="font-semibold text-accent flex items-center gap-2"
          :style="`font-size: ${fontSize}rem;`">
          <span>ğŸ“–</span>
          <span x-text="snModal.code"></span>
        </h3>
        <button @click="snModal.show = false"
          class="p-2 hover:bg-secondary rounded-full transition-colors">
          <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Content -->
      <div class="flex-1 overflow-y-auto p-4"
        :style="`font-size: ${fontSize}rem; line-height: ${lineHeight}; font-family: ${currentFontFamily};`">
        <div x-show="snModal.loading" class="flex items-center justify-center py-8">
          <span class="animate-pulse text-2xl">â³</span>
        </div>
        <div x-show="!snModal.loading && snModal.definition"
          class="whitespace-pre-wrap text-primary"
          x-html="snModal.definition"></div>
        <div x-show="!snModal.loading && !snModal.definition" class="text-secondary text-center py-8">
          <span class="text-2xl block mb-2">â“</span>
          <p>æ‰¾ä¸åˆ°å®šç¾©</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Reading Adjustment Overlay Backdrop (click to dismiss) -->
  <div x-cloak x-show="readingOverlay.show"
    @click="hideReadingOverlay()"
    class="fixed inset-0 z-[149]"></div>

  <!-- Reading Adjustment Overlay -->
  <div x-cloak x-show="readingOverlay.show"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 translate-y-4"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 translate-y-4"
    class="fixed bottom-20 left-1/2 -translate-x-1/2 z-[150] pointer-events-none w-[90%] max-w-[320px]">
    <div class="pointer-events-auto bg-black/85 backdrop-blur-md text-white rounded-2xl shadow-2xl overflow-hidden"
      @click.stop>

      <!-- Tab Selector -->
      <div class="flex border-b border-white/10">
        <button @click="switchOverlayTab(0)"
          :class="readingOverlay.activeTab === 0 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">A</span>å­—è™Ÿ
        </button>
        <button @click="switchOverlayTab(1)"
          :class="readingOverlay.activeTab === 1 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">â‰¡</span>è¡Œè·
        </button>
        <button @click="switchOverlayTab(2)"
          :class="readingOverlay.activeTab === 2 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">Â¶</span>æ®µè·
        </button>
        <button @click="switchOverlayTab(3)"
          :class="readingOverlay.activeTab === 3 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">å­—</span>å­—å‹
        </button>
        <button @click="switchOverlayTab(4)"
          :class="readingOverlay.activeTab === 4 ? 'bg-white/10 text-white' : 'text-white/50'"
          class="flex-1 py-2.5 text-center text-sm font-medium transition-colors">
          <span class="block text-base mb-0.5">ğŸ”</span>ç¸®æ”¾
        </button>
      </div>

      <!-- Control Area -->
      <div class="px-5 py-4">
        <!-- Font Size Control -->
        <div x-show="readingOverlay.activeTab === 0" class="flex items-center gap-4">
          <button @click="adjustFontSize(-0.05)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-sm font-medium">A</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="fontSize.toFixed(2) + ' rem'"></div>
          </div>
          <button @click="adjustFontSize(0.05)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-xl font-medium">A</span>
          </button>
        </div>

        <!-- Line Height Control -->
        <div x-show="readingOverlay.activeTab === 1" class="flex items-center gap-4">
          <button @click="adjustLineHeight(-0.1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg leading-none">â‰¡</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="lineHeight.toFixed(1)"></div>
          </div>
          <button @click="adjustLineHeight(0.1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95"
            style="letter-spacing: 3px;">
            <span class="text-lg leading-none">â‰¡</span>
          </button>
        </div>

        <!-- Verse Spacing Control -->
        <div x-show="readingOverlay.activeTab === 2" class="flex items-center gap-4">
          <button @click="adjustVerseSpacing(-2)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">âˆ’</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="verseSpacing + 'px'"></div>
          </div>
          <button @click="adjustVerseSpacing(2)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">+</span>
          </button>
        </div>

        <!-- Font Family Control -->
        <div x-show="readingOverlay.activeTab === 3" class="flex items-center gap-4">
          <button @click="adjustFontFamily(-1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">â—€</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-xl font-bold" x-text="currentFontFamilyName" :style="`font-family: ${currentFontFamily}`"></div>
          </div>
          <button @click="adjustFontFamily(1)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">â–¶</span>
          </button>
        </div>

        <!-- Zoom Control -->
        <div x-show="readingOverlay.activeTab === 4" class="flex items-center gap-4">
          <button @click="adjustZoom(-5)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">âˆ’</span>
          </button>
          <div class="flex-1 text-center">
            <div class="text-2xl font-bold" x-text="zoom + '%'"></div>
          </div>
          <button @click="adjustZoom(5)"
            class="w-11 h-11 flex items-center justify-center rounded-full bg-white/15 hover:bg-white/25 transition-colors active:scale-95">
            <span class="text-lg">+</span>
          </button>
        </div>

        <!-- Draggable Progress bar (hidden for font family tab) -->
        <div x-show="readingOverlay.activeTab !== 3"
          class="mt-4 h-6 flex items-center cursor-pointer touch-none"
          @mousedown="startSliderDrag($event)"
          @touchstart.prevent="startSliderDrag($event)">
          <div class="w-full h-2 bg-white/15 rounded-full overflow-hidden relative">
            <div class="h-full bg-white/70 rounded-full transition-all"
              :class="readingOverlay.isDragging ? 'duration-0' : 'duration-200'"
              :style="readingOverlay.activeTab === 0
                ? `width: ${((fontSize - 0.75) / 1.5) * 100}%`
                : readingOverlay.activeTab === 1
                  ? `width: ${((lineHeight - 1.0) / 2.0) * 100}%`
                  : readingOverlay.activeTab === 2
                    ? `width: ${(verseSpacing / 64) * 100}%`
                    : `width: ${((zoom - 50) / 100) * 100}%`">
            </div>
            <!-- Slider handle -->
            <div class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-md transition-all"
              :class="readingOverlay.isDragging ? 'scale-125 duration-0' : 'duration-200'"
              :style="readingOverlay.activeTab === 0
                ? `left: calc(${((fontSize - 0.75) / 1.5) * 100}% - 8px)`
                : readingOverlay.activeTab === 1
                  ? `left: calc(${((lineHeight - 1.0) / 2.0) * 100}% - 8px)`
                  : readingOverlay.activeTab === 2
                    ? `left: calc(${(verseSpacing / 64) * 100}% - 8px)`
                    : `left: calc(${((zoom - 50) / 100) * 100}% - 8px)`">
            </div>
          </div>
        </div>
        <!-- Font family indicator dots -->
        <div x-show="readingOverlay.activeTab === 3" class="mt-4 flex justify-center gap-2">
          <template x-for="(font, idx) in fontFamilies" :key="idx">
            <div class="w-2 h-2 rounded-full transition-colors"
              :class="fontFamily === idx ? 'bg-white' : 'bg-white/30'"></div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Drawer (Bottom Sheet) -->
  <div x-cloak x-show="settingsModal.show"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[200] bg-black/40" @click.self="settingsModal.show = false">
    <!-- Drawer Panel -->
    <div x-show="settingsModal.show"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
      x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-y-0"
      x-transition:leave-end="translate-y-full"
      class="fixed left-1/2 -translate-x-1/2 bottom-0 w-full max-w-2xl shadow-2xl flex flex-col rounded-t-2xl drawer-panel"
      style="background-color: var(--bg-primary);">
      <!-- Drag Handle -->
      <div class="flex-shrink-0 flex justify-center py-2">
        <div class="w-10 h-1 rounded-full" style="background-color: var(--border);"></div>
      </div>
      <!-- Header -->
      <div class="flex-shrink-0 flex items-center justify-between px-4 pb-3 border-b" style="border-color: var(--border);">
        <h3 class="font-semibold text-accent flex items-center gap-2"
          :style="`font-size: ${fontSize * 1.1}rem;`">
          <span>âš™ï¸</span>
          <span>è¨­å®š</span>
        </h3>
        <button @click="settingsModal.show = false"
          class="p-2 hover:bg-secondary rounded-full transition-colors flex-shrink-0">
          <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Content -->
      <div class="flex-1 overflow-y-auto p-4" :style="`font-size: ${fontSize}rem;`">
        <!-- Appearance Section -->
        <div class="space-y-3 mb-6">
          <h4 class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`">ğŸ¨ å¤–è§€</h4>

          <!-- Dark Mode Toggle -->
          <div class="flex items-center justify-between p-3 rounded-lg bg-primary border border-custom">
            <div class="flex items-center gap-3">
              <span x-text="isDark ? 'ğŸŒ™' : 'â˜€ï¸'"></span>
              <span class="text-primary">æ·±è‰²æ¨¡å¼</span>
            </div>
            <button @click="toggleDarkMode()"
              :class="isDark ? 'bg-amber-600' : 'bg-gray-400'"
              class="relative w-12 h-6 rounded-full transition-colors">
              <span :class="isDark ? 'translate-x-6' : 'translate-x-1'"
                class="absolute top-1 left-0 w-4 h-4 bg-white rounded-full transition-transform shadow"></span>
            </button>
          </div>

          <!-- Reading Display -->
          <button @click="showReadingOverlay()"
            class="w-full flex items-center justify-between p-3 rounded-lg bg-primary border border-custom hover:border-amber-600 transition-colors">
            <div class="flex items-center gap-3">
              <span>ğŸ“</span>
              <span class="text-primary">èª¿æ•´é¡¯ç¤º</span>
            </div>
            <div class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`">
              <span x-text="currentFontFamilyName"></span>
            </div>
          </button>
        </div>

        <!-- Bible Version Section -->
        <div class="space-y-3 mb-6">
          <h4 class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`">ğŸ“š è–ç¶“ç‰ˆæœ¬</h4>

          <button @click="versionModal.tab = 'select'; versionModal.show = true; settingsModal.show = false"
            class="w-full flex items-center justify-between p-3 rounded-lg bg-primary border border-custom hover:border-amber-600 transition-colors">
            <div class="flex items-center gap-3">
              <span>ğŸ“–</span>
              <span class="text-primary" x-text="currentVersion.name"></span>
            </div>
            <span class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`">åˆ‡æ› â–¶</span>
          </button>
        </div>

        <!-- Data Sync Section -->
        <div class="space-y-3 mb-6">
          <h4 class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`">ğŸ“‚ è³‡æ–™å‚™ä»½</h4>

          <!-- Buttons row (when File System API supported) -->
          <div x-show="hasFileSystemAccess" class="grid grid-cols-3 gap-2">
            <!-- Save Button -->
            <button @click="saveToFile()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>ğŸ’¾</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">å„²å­˜</span>
            </button>

            <!-- Download Backup Button -->
            <button @click="downloadBackup()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>â¬‡ï¸</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">å»ºç«‹å‚™ä»½</span>
            </button>

            <!-- Open File Button -->
            <button @click="importData()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>ğŸ“‚</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">é–‹å•Ÿæª”æ¡ˆ</span>
            </button>
          </div>

          <!-- Buttons row (when File System API NOT supported) -->
          <div x-show="!hasFileSystemAccess" class="grid grid-cols-2 gap-2">
            <!-- Download Backup Button -->
            <button @click="downloadBackup()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>â¬‡ï¸</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">å»ºç«‹å‚™ä»½</span>
            </button>

            <!-- Open File Button -->
            <button @click="importData()" :disabled="settingsModal.isBusy"
              class="flex flex-col items-center justify-center gap-1 px-3 py-3 rounded-lg border border-custom hover:bg-primary transition-colors disabled:opacity-50">
              <span>ğŸ“‚</span>
              <span :style="`font-size: ${fontSize * 0.85}rem;`">é–‹å•Ÿæª”æ¡ˆ</span>
            </button>
          </div>

          <!-- Auto-save checkbox with file info -->
          <div class="p-3 rounded-lg bg-primary border border-custom">
            <label class="flex items-center gap-3 cursor-pointer" :class="{ 'opacity-50 cursor-not-allowed': !hasFileSystemAccess }">
              <input type="checkbox" x-model="autoSync" @change="saveAutoSyncPreference()"
                :disabled="!hasFileSystemAccess"
                class="w-5 h-5 rounded border-gray-300 text-accent focus:ring-accent">
              <div class="flex-1">
                <p class="font-medium text-primary">è‡ªå‹•å„²å­˜</p>
                <p class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`" x-text="fileHandle ? 'å·²é¸æ“‡ï¼š' + fileHandle.name : (hasFileSystemAccess ? 'å°šæœªé¸æ“‡æª”æ¡ˆ' : 'ç€è¦½å™¨ä¸æ”¯æ´æª”æ¡ˆç³»çµ± API')"></p>
              </div>
            </label>
            <!-- Re-select file button -->
            <button x-show="hasFileSystemAccess && fileHandle" @click="reselectFile()" :disabled="settingsModal.isBusy"
              class="mt-2 w-full text-accent hover:underline disabled:opacity-50" :style="`font-size: ${fontSize * 0.85}rem;`">
              é‡æ–°é¸æ“‡æª”æ¡ˆ
            </button>
          </div>
        </div>

        <!-- Status Message -->
        <div x-show="settingsModal.message" class="mb-4 p-3 rounded-lg"
          :class="settingsModal.isError ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'">
          <p :style="`font-size: ${fontSize * 0.85}rem;`" x-text="settingsModal.message"></p>
        </div>

        <!-- Cache Section -->
        <div class="space-y-3 mb-6">
          <h4 class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`">ğŸ—„ï¸ å¿«å–ç®¡ç†</h4>
          <button @click="clearAllVersions()" x-show="cachedVersions.length > 1"
            class="w-full text-red-500 hover:text-red-600 p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors border border-red-200 dark:border-red-800"
            :style="`font-size: ${fontSize * 0.85}rem;`">
            æ¸…é™¤æ‰€æœ‰å¿«å–ï¼ˆä¿ç•™ç›®å‰ä½¿ç”¨ä¸­çš„è­¯æœ¬ï¼‰
          </button>
          <p x-show="cachedVersions.length <= 1" class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`">ç›®å‰ç„¡é¡å¤–å¿«å–å¯æ¸…é™¤</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Drawer (Book & Chapter Selection) -->
  <div x-cloak x-show="navModal.show"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[200] bg-black/40" @click.self="navModal.show = false">
    <!-- Drawer Panel -->
    <div x-show="navModal.show"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
      x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-y-0"
      x-transition:leave-end="translate-y-full"
      class="fixed left-1/2 -translate-x-1/2 bottom-0 w-full max-w-2xl drawer-panel shadow-2xl flex flex-col rounded-t-2xl"
      style="background-color: var(--bg-primary);">
      <!-- Drag Handle -->
      <div class="flex justify-center py-2">
        <div class="w-10 h-1 rounded-full" style="background-color: var(--border);"></div>
      </div>
      <!-- Header with Tabs -->
      <div class="flex items-center justify-between px-4 pb-2 border-b" style="border-color: var(--border);">
        <div class="flex gap-1 flex-1">
          <button @click="navModal.tab = 'books'"
            :class="navModal.tab === 'books' ? 'text-accent' : 'text-secondary hover:text-primary'"
            class="flex-1 py-2 flex items-center justify-center gap-2 font-medium transition-colors border-b-2"
            :style="`font-size: ${fontSize}rem; ` + (navModal.tab === 'books' ? 'border-color: var(--accent)' : 'border-color: transparent')">
            <span>ğŸ“š</span>
            <span>æ›¸å·ç›®éŒ„</span>
          </button>
          <button @click="navModal.tab = 'chapters'"
            :class="navModal.tab === 'chapters' ? 'text-accent' : 'text-secondary hover:text-primary'"
            class="flex-1 py-2 flex items-center justify-center gap-2 font-medium transition-colors border-b-2"
            :style="`font-size: ${fontSize}rem; ` + (navModal.tab === 'chapters' ? 'border-color: var(--accent)' : 'border-color: transparent')">
            <span>ğŸ“–</span>
            <span x-text="selectedBookName"></span>
          </button>
        </div>
        <button @click="navModal.show = false"
          class="p-2 hover:bg-secondary rounded-full transition-colors flex-shrink-0 ml-2">
          <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Content -->
      <div class="flex-1 overflow-hidden flex flex-col p-4">
        <!-- Book Selection Tab -->
        <div x-show="navModal.tab === 'books'" class="flex-1 overflow-hidden flex flex-col">
          <!-- Testament Toggle -->
          <div class="flex rounded-lg border border-custom overflow-hidden mb-3">
            <button @click="navModal.testament = 'old'; navModal.category = bookCategoriesOT[0].id"
              :class="navModal.testament === 'old' ? 'bg-secondary text-primary' : 'bg-primary text-secondary hover:bg-secondary/50'"
              class="flex-1 py-2.5 text-center font-medium transition-colors"
              :style="`font-size: ${fontSize}rem;`">
              èˆŠç´„
            </button>
            <button @click="navModal.testament = 'new'; navModal.category = bookCategoriesNT[0].id"
              :class="navModal.testament === 'new' ? 'bg-secondary text-primary' : 'bg-primary text-secondary hover:bg-secondary/50'"
              class="flex-1 py-2.5 text-center font-medium transition-colors"
              :style="`font-size: ${fontSize}rem;`">
              æ–°ç´„
            </button>
          </div>

          <!-- Category Pills -->
          <div class="flex flex-wrap gap-2 mb-3">
            <template x-for="cat in (navModal.testament === 'old' ? bookCategoriesOT : bookCategoriesNT)" :key="cat.id">
              <button @click="navModal.category = cat.id"
                :class="navModal.category === cat.id ? 'bg-accent text-white' : 'bg-primary text-secondary border border-custom hover:border-accent'"
                class="px-3 py-1.5 rounded-full font-medium transition-colors"
                :style="`font-size: ${fontSize * 0.85}rem;`"
                x-text="cat.name"></button>
            </template>
          </div>

          <!-- Book Grid -->
          <div class="flex-1 overflow-y-auto scrollbar-thin -mx-1.5 px-1.5">
            <div class="grid grid-cols-2 gap-2">
              <template x-for="bookCode in getFilteredBooks()" :key="'nav-book-' + bookCode">
                <button @click="selectedBook = bookCode; onBookChange(); resetChapterRange(); navModal.tab = 'chapters'"
                  class="flex items-center justify-between p-3 rounded-lg bg-primary border border-custom hover:bg-secondary transition-colors text-left">
                  <span class="font-medium text-primary" :style="`font-size: ${fontSize}rem;`" x-text="getBookName(bookCode)"></span>
                  <div class="flex items-center gap-2">
                    <span x-show="selectedBook === bookCode" class="w-2 h-2 rounded-full bg-accent"></span>
                    <span class="text-secondary" :style="`font-size: ${fontSize * 0.85}rem;`">â†’</span>
                  </div>
                </button>
              </template>
            </div>
          </div>
        </div>

        <!-- Chapter Selection Tab -->
        <div x-show="navModal.tab === 'chapters'" class="flex-1 overflow-hidden flex flex-col">
          <!-- Current Selection -->
          <div class="mb-3">
            <p class="text-accent font-medium mb-1" :style="`font-size: ${fontSize * 0.85}rem;`">ğŸ“– ç›®å‰é¸æ“‡</p>
            <p class="font-bold text-primary" :style="`font-size: ${fontSize * 1.15}rem;`">
              <span x-text="selectedBookName"></span>
              <span class="text-secondary font-normal"> / </span>
              <span>ç¬¬ <span x-text="selectedChapter"></span> ç« </span>
            </p>
          </div>

          <!-- Chapter Range Quick Jump (only show when > 20 chapters) -->
          <div x-show="showChapterRanges" class="flex flex-wrap gap-2 mb-3">
            <template x-for="(range, idx) in chapterRanges" :key="'range-' + idx">
              <button @click="scrollToChapterRange(idx)"
                :class="navModal.chapterRange === idx ? 'bg-accent text-white' : 'bg-primary text-secondary border border-custom hover:border-accent'"
                class="px-3 py-1.5 rounded-full font-medium transition-colors"
                :style="`font-size: ${fontSize * 0.85}rem;`"
                x-text="range.label"></button>
            </template>
          </div>

          <!-- Chapter Grid -->
          <div x-ref="chapterGrid" @scroll.throttle.100ms="onChapterGridScroll()" class="flex-1 overflow-y-auto scrollbar-thin -mx-1.5 px-1.5">
            <div class="grid grid-cols-5 gap-2">
              <template x-for="chapter in chapters" :key="'nav-ch-' + chapter">
                <button @click="selectedChapter = chapter; loadVerses(); navModal.show = false; window.scrollTo({ top: 0, behavior: 'smooth' })"
                  :class="selectedChapter === chapter ? 'bg-accent text-white' : 'bg-primary hover:bg-secondary text-primary border border-custom'"
                  class="aspect-square rounded-lg flex items-center justify-center font-medium transition-all"
                  :style="`font-size: ${fontSize * 1.1}rem;`"
                  x-text="chapter"></button>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Version Selector Drawer (Bottom Sheet) -->
  <div x-cloak x-show="versionModal.show"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[200] bg-black/40" @click.self="versionModal.show = false">
    <!-- Drawer Panel -->
    <div x-show="versionModal.show"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
      x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-y-0"
      x-transition:leave-end="translate-y-full"
      class="fixed left-1/2 -translate-x-1/2 bottom-0 w-full max-w-2xl shadow-2xl flex flex-col rounded-t-2xl drawer-panel"
      style="background-color: var(--bg-primary);">
      <!-- Drag Handle -->
      <div class="flex-shrink-0 flex justify-center py-2">
        <div class="w-10 h-1 rounded-full" style="background-color: var(--border);"></div>
      </div>
      <!-- Header -->
      <div class="flex-shrink-0 flex items-center justify-between px-4 pb-3 border-b" style="border-color: var(--border);">
        <h3 class="font-semibold text-accent flex items-center gap-2"
          :style="`font-size: ${fontSize * 1.1}rem;`">
          <span>ğŸ“š</span>
          <span>é¸æ“‡è­¯æœ¬</span>
        </h3>
        <button @click="versionModal.show = false"
          class="p-2 hover:bg-secondary rounded-full transition-colors flex-shrink-0">
          <svg class="w-5 h-5 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Tab Switcher -->
      <div class="flex border-b px-4" style="border-color: var(--border);">
        <button @click="versionModal.tab = 'select'"
          :class="versionModal.tab === 'select' ? 'border-b-2 border-amber-600 text-accent' : 'text-secondary'"
          class="flex-1 py-2.5 text-center font-medium transition-colors"
          :style="`font-size: ${fontSize * 0.9}rem;`">
          è­¯æœ¬é¸æ“‡
        </button>
        <button @click="versionModal.tab = 'compare'"
          :class="versionModal.tab === 'compare' ? 'border-b-2 border-amber-600 text-accent' : 'text-secondary'"
          class="flex-1 py-2.5 text-center font-medium transition-colors"
          :style="`font-size: ${fontSize * 0.9}rem;`">
          å°ç…§è¨­å®š
        </button>
      </div>
      <!-- Content: Select Tab -->
      <div x-show="versionModal.tab === 'select'" class="flex-1 overflow-y-auto p-4 scrollbar-thin">
        <div class="space-y-2">
          <template x-for="version in availableVersions" :key="version.id">
            <div class="p-3 rounded-lg border border-custom transition-colors"
              :class="selectedVersionId === version.id ? 'bg-primary border-amber-600' : 'hover:bg-primary'">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="font-medium text-primary" :style="`font-size: ${fontSize}rem;`" x-text="version.name"></span>
                    <span class="px-1.5 py-0.5 rounded text-xs"
                      :style="`font-size: ${fontSize * 0.7}rem; background-color: var(--bg-secondary); color: var(--text-secondary);`"
                      x-text="version.lang"></span>
                    <template x-if="selectedVersionId === version.id">
                      <span class="px-1.5 py-0.5 rounded bg-amber-600 text-white"
                        :style="`font-size: ${fontSize * 0.75}rem;`">ä½¿ç”¨ä¸­</span>
                    </template>
                    <template x-if="isVersionCached(version.id) && selectedVersionId !== version.id">
                      <span class="px-1.5 py-0.5 rounded bg-green-600 text-white"
                        :style="`font-size: ${fontSize * 0.75}rem;`">å·²ä¸‹è¼‰</span>
                    </template>
                  </div>
                  <p class="text-secondary mt-0.5" :style="`font-size: ${fontSize * 0.85}rem;`" x-text="version.size"></p>
                </div>
                <div class="flex items-center gap-2">
                  <!-- Delete button for cached versions (not currently selected) -->
                  <button x-show="isVersionCached(version.id) && selectedVersionId !== version.id"
                    @click="deleteVersion(version.id)"
                    class="p-1.5 rounded-lg text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors"
                    title="åˆªé™¤å¿«å–">
                    <span :style="`font-size: ${fontSize * 0.85}rem;`">ğŸ—‘ï¸</span>
                  </button>
                  <!-- Select/Download button -->
                  <button @click="selectVersion(version.id)"
                    :disabled="versionModal.downloading === version.id"
                    class="px-3 py-1.5 rounded-lg transition-colors disabled:opacity-50"
                    :class="selectedVersionId === version.id ? 'bg-secondary text-secondary cursor-default' : 'text-white'"
                    :style="`font-size: ${fontSize * 0.85}rem; ` + (selectedVersionId !== version.id ? 'background-color: var(--accent);' : '')">
                    <span x-show="versionModal.downloading === version.id" class="flex items-center gap-1">
                      <span class="animate-spin">â³</span> ä¸‹è¼‰ä¸­...
                    </span>
                    <span x-show="versionModal.downloading !== version.id">
                      <span x-text="selectedVersionId === version.id ? 'ä½¿ç”¨ä¸­' : (isVersionCached(version.id) ? 'åˆ‡æ›' : 'ä¸‹è¼‰')"></span>
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
      <!-- Content: Compare Tab -->
      <div x-show="versionModal.tab === 'compare'" class="flex-1 overflow-y-auto p-4 scrollbar-thin">
        <p class="text-secondary mb-3" :style="`font-size: ${fontSize * 0.85}rem;`">
          é¸æ“‡è¦å•Ÿç”¨å°ç…§çš„è­¯æœ¬ï¼Œä¸¦æ‹–æ›³èª¿æ•´é¡¯ç¤ºé †åº
        </p>
        <!-- Enabled versions (reorderable) -->
        <div x-show="compareVersionOrder.length > 0" class="mb-4">
          <h4 class="font-medium text-accent mb-2" :style="`font-size: ${fontSize * 0.9}rem;`">å·²å•Ÿç”¨ (<span x-text="compareVersionOrder.length"></span>)</h4>
          <div class="space-y-1.5">
            <template x-for="(versionId, idx) in compareVersionOrder" :key="'enabled-' + versionId">
              <div class="p-2.5 rounded-lg border transition-all flex items-center gap-2"
                :class="versionModal.draggedVersionId === versionId ? 'border-amber-600 bg-primary opacity-50' : 'border-custom hover:border-accent-light'"
                draggable="true"
                @dragstart="versionModal.draggedVersionId = versionId"
                @dragend="versionModal.draggedVersionId = null"
                @dragover.prevent
                @drop.prevent="reorderCompareVersion(versionId, idx)">
                <!-- Drag handle -->
                <span class="cursor-move text-secondary select-none" style="touch-action: none;">â ¿</span>
                <!-- Version info -->
                <div class="flex-1 flex items-center gap-2 flex-wrap">
                  <span class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`"
                    x-text="availableVersions.find(v => v.id === versionId)?.name || versionId"></span>
                  <span class="px-1.5 py-0.5 rounded text-xs"
                    :style="`font-size: ${fontSize * 0.7}rem; background-color: var(--bg-secondary); color: var(--text-secondary);`"
                    x-text="availableVersions.find(v => v.id === versionId)?.lang"></span>
                </div>
                <!-- Move buttons for touch devices -->
                <button @click="moveCompareVersion(idx, -1)" :disabled="idx === 0"
                  class="p-1 rounded hover:bg-secondary disabled:opacity-30 text-secondary transition-colors" title="ä¸Šç§»">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                  </svg>
                </button>
                <button @click="moveCompareVersion(idx, 1)" :disabled="idx === compareVersionOrder.length - 1"
                  class="p-1 rounded hover:bg-secondary disabled:opacity-30 text-secondary transition-colors" title="ä¸‹ç§»">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </button>
                <!-- Toggle off -->
                <button @click="toggleCompareVersion(versionId)"
                  class="p-1.5 rounded-lg transition-colors text-red-500 hover:bg-red-100 dark:hover:bg-red-900/30" title="ç§»é™¤">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            </template>
          </div>
        </div>
        <!-- Available cached versions to add -->
        <div x-show="getAvailableCompareVersions().length > 0">
          <h4 class="font-medium text-secondary mb-2" :style="`font-size: ${fontSize * 0.9}rem;`">å¯åŠ å…¥å°ç…§</h4>
          <div class="space-y-1.5">
            <template x-for="version in getAvailableCompareVersions()" :key="'available-' + version.id">
              <div class="p-2.5 rounded-lg border border-custom hover:border-accent-light transition-colors flex items-center gap-2">
                <div class="flex-1 flex items-center gap-2 flex-wrap">
                  <span class="font-medium text-primary" :style="`font-size: ${fontSize * 0.95}rem;`" x-text="version.name"></span>
                  <span class="px-1.5 py-0.5 rounded text-xs"
                    :style="`font-size: ${fontSize * 0.7}rem; background-color: var(--bg-secondary); color: var(--text-secondary);`"
                    x-text="version.lang"></span>
                </div>
                <button @click="toggleCompareVersion(version.id)"
                  class="p-1.5 rounded-lg transition-colors text-green-600 hover:bg-green-100 dark:hover:bg-green-900/30" title="åŠ å…¥å°ç…§">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                  </svg>
                </button>
              </div>
            </template>
          </div>
        </div>
        <!-- No cached versions message -->
        <div x-show="cachedVersions.length <= 1" class="text-center py-8">
          <span class="text-4xl mb-3 block">ğŸ“¥</span>
          <p class="text-secondary" :style="`font-size: ${fontSize * 0.9}rem;`">
            è«‹å…ˆåœ¨ã€Œè­¯æœ¬é¸æ“‡ã€é ç±¤ä¸‹è¼‰å…¶ä»–è­¯æœ¬
          </p>
        </div>
      </div>
      <!-- Footer -->
      <div class="px-4 py-3 border-t" style="border-color: var(--border);">
        <p class="text-secondary text-center" :style="`font-size: ${fontSize * 0.85}rem;`">å·²å¿«å– <span x-text="cachedVersions.length"></span> å€‹è­¯æœ¬</p>
      </div>
    </div>
  </div>


    <div id="pwa-toast" role="alert" aria-labelledby="toast-message"
      class="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-secondary border border-custom rounded-xl p-4 shadow-lg z-[300] hidden">
      <div class="flex items-start gap-3">
        <span class="text-2xl">ğŸ”„</span>
        <div class="flex-1">
          <p id="toast-message" class="text-primary font-medium"></p>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="pwa-close" type="button"
          class="px-4 py-2 rounded-lg text-secondary hover:bg-primary transition-colors text-sm">
          Close
        </button>
        <button id="pwa-refresh" type="button"
          class="px-4 py-2 rounded-lg text-white transition-colors text-sm"
          style="background-color: var(--accent);">
          Reload
        </button>
      </div>
    </div>


  </div>



  <script>
    // Canonical book codes in order
    const BOOK_CODES = [
      'GEN', 'EXO', 'LEV', 'NUM', 'DEU', 'JOS', 'JUG', 'RUT', 'SA1', 'SA2',
      'KI1', 'KI2', 'CH1', 'CH2', 'EZR', 'NEH', 'EST', 'JOB', 'PSM', 'PRO',
      'ECC', 'SON', 'ISA', 'JER', 'LAM', 'EZE', 'DAN', 'HOS', 'JOE', 'AMO',
      'OBA', 'JON', 'MIC', 'NAH', 'HAB', 'ZEP', 'HAG', 'ZEC', 'MAL',
      'MAT', 'MAK', 'LUK', 'JHN', 'ACT', 'ROM', 'CO1', 'CO2', 'GAL', 'EPH',
      'PHL', 'COL', 'TS1', 'TS2', 'TI1', 'TI2', 'TIT', 'PHM', 'HEB', 'JAS',
      'PE1', 'PE2', 'JN1', 'JN2', 'JN3', 'JUD', 'REV'
    ];

    // Book code to display name mapping (for current language)
    const BOOK_NAMES = {
      // Old Testament
      'GEN': 'å‰µä¸–è¨˜', 'EXO': 'å‡ºåŸƒåŠè¨˜', 'LEV': 'åˆ©æœªè¨˜', 'NUM': 'æ°‘æ•¸è¨˜', 'DEU': 'ç”³å‘½è¨˜',
      'JOS': 'ç´„æ›¸äºè¨˜', 'JUG': 'å£«å¸«è¨˜', 'RUT': 'è·¯å¾—è¨˜', 'SA1': 'æ’’æ¯è€³è¨˜ä¸Š', 'SA2': 'æ’’æ¯è€³è¨˜ä¸‹',
      'KI1': 'åˆ—ç‹ç´€ä¸Š', 'KI2': 'åˆ—ç‹ç´€ä¸‹', 'CH1': 'æ­·ä»£å¿—ä¸Š', 'CH2': 'æ­·ä»£å¿—ä¸‹',
      'EZR': 'ä»¥æ–¯æ‹‰è¨˜', 'NEH': 'å°¼å¸Œç±³è¨˜', 'EST': 'ä»¥æ–¯å¸–è¨˜', 'JOB': 'ç´„ä¼¯è¨˜', 'PSM': 'è©©ç¯‡',
      'PRO': 'ç®´è¨€', 'ECC': 'å‚³é“æ›¸', 'SON': 'é›…æ­Œ', 'ISA': 'ä»¥è³½äºæ›¸', 'JER': 'è€¶åˆ©ç±³æ›¸',
      'LAM': 'è€¶åˆ©ç±³å“€æ­Œ', 'EZE': 'ä»¥è¥¿çµæ›¸', 'DAN': 'ä½†ä»¥ç†æ›¸', 'HOS': 'ä½•è¥¿é˜¿æ›¸',
      'JOE': 'ç´„ç¥æ›¸', 'AMO': 'é˜¿æ‘©å¸æ›¸', 'OBA': 'ä¿„å·´åº•äºæ›¸', 'JON': 'ç´„æ‹¿æ›¸', 'MIC': 'å½Œè¿¦æ›¸',
      'NAH': 'é‚£é´»æ›¸', 'HAB': 'å“ˆå·´è°·æ›¸', 'ZEP': 'è¥¿ç•ªé›…æ›¸', 'HAG': 'å“ˆè©²æ›¸', 'ZEC': 'æ’’è¿¦åˆ©äºæ›¸', 'MAL': 'ç‘ªæ‹‰åŸºæ›¸',
      // New Testament
      'MAT': 'é¦¬å¤ªç¦éŸ³', 'MAK': 'é¦¬å¯ç¦éŸ³', 'LUK': 'è·¯åŠ ç¦éŸ³', 'JHN': 'ç´„ç¿°ç¦éŸ³', 'ACT': 'ä½¿å¾’è¡Œå‚³',
      'ROM': 'ç¾…é¦¬æ›¸', 'CO1': 'å“¥æ—å¤šå‰æ›¸', 'CO2': 'å“¥æ—å¤šå¾Œæ›¸', 'GAL': 'åŠ æ‹‰å¤ªæ›¸', 'EPH': 'ä»¥å¼—æ‰€æ›¸',
      'PHL': 'è…“ç«‹æ¯”æ›¸', 'COL': 'æ­Œç¾…è¥¿æ›¸', 'TS1': 'å¸–æ’’ç¾…å°¼è¿¦å‰æ›¸', 'TS2': 'å¸–æ’’ç¾…å°¼è¿¦å¾Œæ›¸',
      'TI1': 'ææ‘©å¤ªå‰æ›¸', 'TI2': 'ææ‘©å¤ªå¾Œæ›¸', 'TIT': 'æå¤šæ›¸', 'PHM': 'è…“åˆ©é–€æ›¸', 'HEB': 'å¸Œä¼¯ä¾†æ›¸',
      'JAS': 'é›…å„æ›¸', 'PE1': 'å½¼å¾—å‰æ›¸', 'PE2': 'å½¼å¾—å¾Œæ›¸', 'JN1': 'ç´„ç¿°ä¸€æ›¸', 'JN2': 'ç´„ç¿°äºŒæ›¸',
      'JN3': 'ç´„ç¿°ä¸‰æ›¸', 'JUD': 'çŒ¶å¤§æ›¸', 'REV': 'å•Ÿç¤ºéŒ„'
    };

    // Map alternate/legacy book codes to canonical codes
    const CODE_ALIASES = {
      // Old format codes
      'JDG': 'JUG', 'PSA': 'PSM', 'SNG': 'SON', 'EZK': 'EZE', 'JOL': 'JOE',
      'MRK': 'MAK', 'PHP': 'PHL', '1TH': 'TS1', '2TH': 'TS2',
      // Number prefix format (1SA -> SA1)
      '1SA': 'SA1', '2SA': 'SA2', '1KI': 'KI1', '2KI': 'KI2',
      '1CH': 'CH1', '2CH': 'CH2', '1CO': 'CO1', '2CO': 'CO2',
      '1TI': 'TI1', '2TI': 'TI2', '1PE': 'PE1', '2PE': 'PE2',
      '1JN': 'JN1', '2JN': 'JN2', '3JN': 'JN3',
      // Other alternate codes
      'SOL': 'SON', 'SOS': 'SON', 'NAM': 'NAH', 'ZPH': 'ZEP',
      'MK': 'MAK', 'JN': 'JHN', 'PHI': 'PHL',
      '1THS': 'TS1', '2THS': 'TS2', '1TIM': 'TI1', '2TIM': 'TI2',
      'PHILE': 'PHM', '1PET': 'PE1', '2PET': 'PE2',
      // TH variants
      'TH1': 'TS1', 'TH2': 'TS2'
    };

    // Normalize any book code to canonical form
    function normalizeBookCode(code) {
      return CODE_ALIASES[code] || code;
    }

    // Get display name for a book code
    function getBookName(code) {
      const normalized = normalizeBookCode(code);
      return BOOK_NAMES[normalized] || code;
    }

    // Reverse lookup: get book code from display name (for backward compatibility)
    const NAME_TO_CODE = Object.fromEntries(
      Object.entries(BOOK_NAMES).map(([code, name]) => [name, code])
    );
    function getBookCode(nameOrCode) {
      // If it's already a valid code, return normalized version
      const normalized = normalizeBookCode(nameOrCode);
      if (BOOK_NAMES[normalized]) return normalized;
      // Try reverse lookup from name
      return NAME_TO_CODE[nameOrCode] || nameOrCode;
    }

    // Available Bible versions
    const BIBLE_VERSIONS = [
      { id: 'zh-rTW_CUV', file: 'zh-rTW_CUV.txt', name: 'å’Œåˆæœ¬', lang: 'ç¹é«”ä¸­æ–‡', size: '3.6 MB' },
      { id: 'zh-rTW_CUV-SN', file: 'zh-rTW_CUV-SN.txt', name: 'å’Œåˆæœ¬ (å«åŸæ–‡ç·¨è™Ÿ)', lang: 'ç¹é«”ä¸­æ–‡', size: '6.7 MB' },
      { id: 'zh-rTW_CNV', file: 'zh-rTW_CNV.txt', name: 'æ–°è­¯æœ¬', lang: 'ç¹é«”ä¸­æ–‡', size: '3.9 MB' },
      { id: 'zh-rTW_LCC', file: 'zh-rTW_LCC.txt', name: 'å‘‚æŒ¯ä¸­è­¯æœ¬', lang: 'ç¹é«”ä¸­æ–‡', size: '4.0 MB' },
      { id: 'en_KJV-SN', file: 'en_KJV-SN.txt', name: 'King James (Strong\'s)', lang: 'English', size: '7.4 MB' },
      { id: 'en_ASV', file: 'en_ASV.txt', name: 'American Standard', lang: 'English', size: '4.4 MB' },
      { id: 'en_WEB', file: 'en_WEB.txt', name: 'World English Bible', lang: 'English', size: '4.3 MB' },
      { id: 'en_BBE', file: 'en_BBE.txt', name: 'Bible in Basic English', lang: 'English', size: '4.4 MB' },
      { id: 'en_YLT', file: 'en_YLT.txt', name: 'Young\'s Literal', lang: 'English', size: '4.4 MB' },
      { id: 'el_Septuaginta', file: 'el_Septuaginta.txt', name: 'Septuaginta', lang: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬', size: '5.4 MB' },
      { id: 'iw_ModernHebrew', file: 'iw_ModernHebrew.txt', name: 'Modern Hebrew', lang: '×¢×‘×¨×™×ª', size: '4.0 MB' }
    ];

    function bibleReader() {
      return {
        isDark: false,
        allVerses: [],
        books: [],
        chapters: [],
        selectedBook: '',
        selectedChapter: 1,
        currentVerses: [],
        searchQuery: '',
        searchResults: [],
        headerSearchOpen: false,
        totalVerses: 0,
        bibleData: {},
        customTitles: {},
        notes: {},
        // Highlight system
        highlightDefs: {
          'h1': { name: 'é‡é»', color: '#fef08a' },
          'h2': { name: 'ç¶“æ–‡', color: '#bbf7d0' },
          'h3': { name: 'æ‡‰ç”¨', color: '#fecaca' }
        },
        verseHighlights: {},  // { [verseRef]: highlightId }
        isLoading: false,
        loadingMessage: '',
        loadingSubMessage: '',
        // Version management
        availableVersions: BIBLE_VERSIONS,
        selectedVersionId: 'zh-rTW_CUV',
        cachedVersions: [],
        versionModal: {
          show: false,
          downloading: null,
          tab: 'select', // 'select' or 'compare'
          draggedVersionId: null
        },
        compareVersionOrder: [], // ordered list of version IDs enabled for comparison
        navModal: {
          show: false,
          tab: 'chapters',  // 'books' or 'chapters'
          testament: 'old', // 'old' or 'new'
          category: 'pentateuch',  // category filter
          chapterRange: 0,  // chapter range filter index (0 = first range)
          isScrolling: false  // flag to prevent scroll handler during programmatic scroll
        },
        verseActions: {
          show: false,
          verse: null
        },
        compareVerseRef: null,  // ref of verse being compared
        compareVerses: [],      // array of {versionName, versionId, text} for comparison
        titleModal: {
          show: false,
          verse: null,
          title: ''
        },
        noteModal: {
          show: false,
          verse: null,
          note: ''
        },
        highlightModal: {
          show: false,
          verse: null,
          editingId: null,  // which highlight is being edited
          editName: '',
          editColor: ''
        },
        settingsModal: {
          show: false,
          isBusy: false,
          message: '',
          isError: false
        },
        snModal: {
          show: false,
          code: '',
          definition: '',
          loading: false
        },
        snDictTexts: {},  // Cache for raw dictionary text by version ID
        snDictLoading: false,
        hasFileSystemAccess: false,
        fileHandle: null,
        autoSync: false,
        // Reading preferences
        fontSize: 1.125,   // in rem (default ~18px at 16px base)
        lineHeight: 1.8,   // multiplier
        verseSpacing: 16,  // in pixels (gap between verses)
        fontFamily: 0,     // index into fontFamilies array
        zoom: 100,         // global zoom percentage (50-150%)
        fontFamilies: [
          { name: 'ç³»çµ±å­—å‹', value: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' },
          { name: 'æ€æºå®‹é«”', value: '"Noto Serif TC", serif' },
          { name: 'é»‘é«”', value: '"Noto Sans TC", "Microsoft JhengHei", sans-serif' },
          { name: 'æ¥·é«”', value: '"TW-Kai", "DFKai-SB", "KaiTi", serif' }
        ],
        // Book categories for navigation
        bookCategoriesOT: [
          { id: 'pentateuch', name: 'æ‘©è¥¿äº”ç¶“', books: ['GEN', 'EXO', 'LEV', 'NUM', 'DEU'] },
          { id: 'history', name: 'æ­·å²æ›¸', books: ['JOS', 'JUG', 'RUT', 'SA1', 'SA2', 'KI1', 'KI2', 'CH1', 'CH2', 'EZR', 'NEH', 'EST'] },
          { id: 'poetry', name: 'è©©æ­Œæ™ºæ…§æ›¸', books: ['JOB', 'PSM', 'PRO', 'ECC', 'SON'] },
          { id: 'major', name: 'å¤§å…ˆçŸ¥æ›¸', books: ['ISA', 'JER', 'LAM', 'EZE', 'DAN'] },
          { id: 'minor', name: 'å°å…ˆçŸ¥æ›¸', books: ['HOS', 'JOE', 'AMO', 'OBA', 'JON', 'MIC', 'NAH', 'HAB', 'ZEP', 'HAG', 'ZEC', 'MAL'] }
        ],
        bookCategoriesNT: [
          { id: 'gospels', name: 'ç¦éŸ³æ›¸', books: ['MAT', 'MAK', 'LUK', 'JHN'] },
          { id: 'acts', name: 'ä½¿å¾’è¡Œå‚³', books: ['ACT'] },
          { id: 'pauline', name: 'ä¿ç¾…æ›¸ä¿¡', books: ['ROM', 'CO1', 'CO2', 'GAL', 'EPH', 'PHL', 'COL', 'TS1', 'TS2', 'TI1', 'TI2', 'TIT', 'PHM'] },
          { id: 'general', name: 'æ™®é€šæ›¸ä¿¡', books: ['HEB', 'JAS', 'PE1', 'PE2', 'JN1', 'JN2', 'JN3', 'JUD'] },
          { id: 'revelation', name: 'å•Ÿç¤ºéŒ„', books: ['REV'] }
        ],
        // Reading overlay control
        readingOverlay: {
          show: false,
          activeTab: 0,  // 0: fontSize, 1: lineHeight, 2: verseSpacing, 3: fontFamily, 4: zoom
          isDragging: false,
          sliderRect: null
        },
        // Pinch zoom state
        pinchState: {
          active: false,
          initialDistance: 0,
          initialZoom: 100
        },

        async init() {
          // Check File System Access API support
          this.hasFileSystemAccess = 'showSaveFilePicker' in window;
          // Check dark mode preference
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            this.isDark = true;
            document.documentElement.classList.add('dark');
          }
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            this.isDark = event.matches;
            document.documentElement.classList.toggle('dark', event.matches);
          });

          // Load saved data from IndexedDB
          await this.loadFromStorage();

          await this.parseVerses();
        },

        // IndexedDB helpers using idb-keyval
        async loadFromStorage() {
          try {
            const [savedTitles, savedNotes, savedBook, savedChapter, savedAutoSync, savedFileHandle, savedVersionId, savedCachedVersions, savedFontSize, savedLineHeight, savedVerseSpacing, savedFontFamily, savedHighlightDefs, savedVerseHighlights, savedZoom] = await Promise.all([
              idbKeyval.get('bible_customTitles'),
              idbKeyval.get('bible_notes'),
              idbKeyval.get('bible_selectedBook'),
              idbKeyval.get('bible_selectedChapter'),
              idbKeyval.get('bible_autoSync'),
              idbKeyval.get('bible_fileHandle'),
              idbKeyval.get('bible_selectedVersion'),
              idbKeyval.get('bible_cachedVersions'),
              idbKeyval.get('bible_fontSize'),
              idbKeyval.get('bible_lineHeight'),
              idbKeyval.get('bible_verseSpacing'),
              idbKeyval.get('bible_fontFamily'),
              idbKeyval.get('bible_highlightDefs'),
              idbKeyval.get('bible_verseHighlights'),
              idbKeyval.get('bible_zoom')
            ]);

            if (savedTitles) {
              this.customTitles = this.migrateRefKeys(savedTitles);
            }
            if (savedNotes) {
              this.notes = this.migrateRefKeys(savedNotes);
            }
            if (savedBook) {
              // Convert old book names to codes for backward compatibility
              this._pendingBook = getBookCode(savedBook);
            }
            if (savedChapter) {
              this._pendingChapter = savedChapter;
            }
            if (savedAutoSync !== undefined) {
              this.autoSync = savedAutoSync;
            }
            if (savedVersionId && this.availableVersions.some(v => v.id === savedVersionId)) {
              this.selectedVersionId = savedVersionId;
            }
            if (savedCachedVersions && Array.isArray(savedCachedVersions)) {
              this.cachedVersions = savedCachedVersions;
            }

            // Restore file handle if available (permissions will need to be re-requested)
            if (savedFileHandle && this.hasFileSystemAccess) {
              this.fileHandle = savedFileHandle;
              // Note: Permission will be checked/requested when user tries to use it
            }

            // Restore reading preferences
            if (savedFontSize) {
              // Migrate old px values to rem (old values were 12-36, new are 0.75-2.25)
              if (savedFontSize >= 10) {
                // Old px value, convert to rem (assuming 16px base)
                this.fontSize = Math.max(0.75, Math.min(2.25, savedFontSize / 16));
              } else if (savedFontSize >= 0.75 && savedFontSize <= 2.25) {
                // Already in rem
                this.fontSize = savedFontSize;
              }
            }
            if (savedLineHeight && savedLineHeight >= 1.0 && savedLineHeight <= 3) {
              this.lineHeight = savedLineHeight;
            }
            if (savedVerseSpacing && savedVerseSpacing >= 0 && savedVerseSpacing <= 64) {
              this.verseSpacing = savedVerseSpacing;
            }
            if (savedFontFamily !== undefined && savedFontFamily >= 0 && savedFontFamily < this.fontFamilies.length) {
              this.fontFamily = savedFontFamily;
            }
            if (savedZoom && savedZoom >= 50 && savedZoom <= 150) {
              this.zoom = savedZoom;
            }
            // Restore highlight data
            if (savedHighlightDefs && typeof savedHighlightDefs === 'object') {
              this.highlightDefs = { ...this.highlightDefs, ...savedHighlightDefs };
            }
            if (savedVerseHighlights) {
              this.verseHighlights = this.migrateRefKeys(savedVerseHighlights);
            }

            // Load compare version order
            await this.loadCompareVersionOrder();
          } catch (e) {
            console.warn('Failed to load from IndexedDB:', e);
          }
        },

        // Save file handle to IndexedDB
        async saveFileHandle() {
          try {
            if (this.fileHandle) {
              await idbKeyval.set('bible_fileHandle', this.fileHandle);
            } else {
              await idbKeyval.del('bible_fileHandle');
            }
          } catch (e) {
            console.warn('Failed to save file handle:', e);
          }
        },

        // Verify and request permission for file handle
        async verifyPermission(readWrite = true) {
          if (!this.fileHandle) return false;

          const options = readWrite ? { mode: 'readwrite' } : {};

          // Check if permission was already granted
          if ((await this.fileHandle.queryPermission(options)) === 'granted') {
            return true;
          }

          // Request permission if not granted
          if ((await this.fileHandle.requestPermission(options)) === 'granted') {
            return true;
          }

          return false;
        },

        async saveCustomTitles() {
          try {
            // Clone to plain object to avoid DataCloneError with Alpine proxies
            await idbKeyval.set('bible_customTitles', JSON.parse(JSON.stringify(this.customTitles)));
            await this.triggerAutoSync();
          } catch (e) {
            console.warn('Failed to save custom titles:', e);
          }
        },

        async saveNotes() {
          try {
            // Clone to plain object to avoid DataCloneError with Alpine proxies
            await idbKeyval.set('bible_notes', JSON.parse(JSON.stringify(this.notes)));
            await this.triggerAutoSync();
          } catch (e) {
            console.warn('Failed to save notes:', e);
          }
        },

        async saveReadingPosition() {
          try {
            await Promise.all([
              idbKeyval.set('bible_selectedBook', this.selectedBook),
              idbKeyval.set('bible_selectedChapter', this.selectedChapter)
            ]);
          } catch (e) {
            console.warn('Failed to save reading position:', e);
          }
        },

        async saveReadingPreferences() {
          try {
            await Promise.all([
              idbKeyval.set('bible_fontSize', this.fontSize),
              idbKeyval.set('bible_lineHeight', this.lineHeight),
              idbKeyval.set('bible_verseSpacing', this.verseSpacing),
              idbKeyval.set('bible_fontFamily', this.fontFamily),
              idbKeyval.set('bible_zoom', this.zoom)
            ]);
          } catch (e) {
            console.warn('Failed to save reading preferences:', e);
          }
        },

        // Show reading overlay control
        showReadingOverlay() {
          this.readingOverlay.show = true;
          this.settingsModal.show = false;
        },

        hideReadingOverlay() {
          this.readingOverlay.show = false;
        },

        switchOverlayTab(tab) {
          this.readingOverlay.activeTab = tab;
        },

        adjustFontSize(delta) {
          // delta is in 0.05rem increments
          this.fontSize = Math.max(0.75, Math.min(2.25, Math.round((parseFloat(this.fontSize) + delta) * 100) / 100));
          this.saveReadingPreferences();
        },

        adjustLineHeight(delta) {
          this.lineHeight = Math.max(1.0, Math.min(3.0, Math.round((parseFloat(this.lineHeight) + delta) * 10) / 10));
          this.saveReadingPreferences();
        },

        adjustVerseSpacing(delta) {
          this.verseSpacing = Math.max(0, Math.min(64, parseInt(this.verseSpacing) + delta));
          this.saveReadingPreferences();
        },

        adjustFontFamily(delta) {
          const len = this.fontFamilies.length;
          this.fontFamily = ((this.fontFamily + delta) % len + len) % len;
          this.saveReadingPreferences();
        },

        adjustZoom(delta) {
          this.zoom = Math.max(50, Math.min(150, parseInt(this.zoom) + delta));
          this.saveReadingPreferences();
        },

        // Pinch-to-zoom functionality
        handlePinchStart(event) {
          if (event.touches.length !== 2) return;

          const touch1 = event.touches[0];
          const touch2 = event.touches[1];
          const distance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );

          this.pinchState.active = true;
          this.pinchState.initialDistance = distance;
          this.pinchState.initialZoom = this.zoom;

          // Show reading overlay with zoom tab
          this.readingOverlay.activeTab = 4;
          this.readingOverlay.show = true;
        },

        handlePinchMove(event) {
          if (!this.pinchState.active || event.touches.length !== 2) return;

          const touch1 = event.touches[0];
          const touch2 = event.touches[1];
          const distance = Math.hypot(
            touch2.clientX - touch1.clientX,
            touch2.clientY - touch1.clientY
          );

          // Calculate zoom based on pinch scale
          const scale = distance / this.pinchState.initialDistance;
          const newZoom = Math.round(this.pinchState.initialZoom * scale);

          // Clamp to valid range
          this.zoom = Math.max(50, Math.min(150, newZoom));
        },

        handlePinchEnd(event) {
          if (!this.pinchState.active) return;

          // If no touches left or only one touch, end pinch
          if (event.touches.length < 2) {
            this.pinchState.active = false;
            this.saveReadingPreferences();
          }
        },

        // Slider drag functionality
        startSliderDrag(event) {
          this.readingOverlay.isDragging = true;
          const sliderEl = event.currentTarget.querySelector('.bg-white\\/15');
          this.readingOverlay.sliderRect = sliderEl.getBoundingClientRect();
          this.handleSliderMove(event);

          const moveHandler = (e) => this.handleSliderMove(e);
          const endHandler = () => {
            this.readingOverlay.isDragging = false;
            this.saveReadingPreferences();
            document.removeEventListener('mousemove', moveHandler);
            document.removeEventListener('mouseup', endHandler);
            document.removeEventListener('touchmove', moveHandler);
            document.removeEventListener('touchend', endHandler);
          };

          document.addEventListener('mousemove', moveHandler);
          document.addEventListener('mouseup', endHandler);
          document.addEventListener('touchmove', moveHandler, { passive: false });
          document.addEventListener('touchend', endHandler);
        },

        handleSliderMove(event) {
          if (!this.readingOverlay.sliderRect) return;
          const rect = this.readingOverlay.sliderRect;
          const clientX = event.touches ? event.touches[0].clientX : event.clientX;
          let ratio = (clientX - rect.left) / rect.width;
          ratio = Math.max(0, Math.min(1, ratio));

          if (this.readingOverlay.activeTab === 0) {
            // Font size: 0.75-2.25rem (30 steps of 0.05rem)
            this.fontSize = Math.round((0.75 + ratio * 1.5) * 20) / 20;
          } else if (this.readingOverlay.activeTab === 1) {
            // Line height: 1.0-3.0 (20 steps of 0.1)
            this.lineHeight = Math.round((1.0 + ratio * 2.0) * 10) / 10;
          } else if (this.readingOverlay.activeTab === 2) {
            // Verse spacing: 0-64px (16 steps of 4)
            this.verseSpacing = Math.round(ratio * 16) * 4;
          } else if (this.readingOverlay.activeTab === 4) {
            // Zoom: 50-150% (20 steps of 5%)
            this.zoom = Math.round((50 + ratio * 100) / 5) * 5;
          }
        },

        get currentFontFamily() {
          return this.fontFamilies[this.fontFamily]?.value || this.fontFamilies[0].value;
        },

        get currentFontFamilyName() {
          return this.fontFamilies[this.fontFamily]?.name || this.fontFamilies[0].name;
        },

        // Get display name for a book code
        getBookName(code) {
          return getBookName(code);
        },

        // Get display name for current selected book
        get selectedBookName() {
          return getBookName(this.selectedBook);
        },

        // Format verse reference for display (e.g., "GEN:1:1" -> "å‰µä¸–è¨˜ 1:1")
        formatRef(ref) {
          const parts = ref.split(':');
          if (parts.length >= 2) {
            const bookName = getBookName(parts[0]);
            return `${bookName} ${parts[1]}:${parts[2] || 1}`;
          }
          return ref;
        },

        // Get filtered books based on current testament and category
        getFilteredBooks() {
          const categories = this.navModal.testament === 'old' ? this.bookCategoriesOT : this.bookCategoriesNT;
          const category = categories.find(c => c.id === this.navModal.category);
          if (category) {
            // Filter to only include books that exist in our data
            return category.books.filter(code => this.books.includes(code));
          }
          // Default: return all books for current testament
          const allBooksInTestament = categories.flatMap(c => c.books);
          return allBooksInTestament.filter(code => this.books.includes(code));
        },

        // Check if chapter ranges should be shown (more than 20 chapters)
        get showChapterRanges() {
          return this.chapters.length > 20;
        },

        // Get chapter range options (e.g., [{start: 1, end: 20, label: "1-20"}, ...])
        // If last group has fewer than 20 chapters, merge with previous group
        get chapterRanges() {
          if (!this.showChapterRanges) return [];
          const ranges = [];
          const rangeSize = 20;
          const maxChapter = Math.max(...this.chapters);
          for (let start = 1; start <= maxChapter; start += rangeSize) {
            const end = Math.min(start + rangeSize - 1, maxChapter);
            ranges.push({
              start,
              end,
              label: `${start}-${end}`
            });
          }
          // Merge last group if it has fewer than 20 chapters
          if (ranges.length >= 2) {
            const lastRange = ranges[ranges.length - 1];
            const lastRangeSize = lastRange.end - lastRange.start + 1;
            if (lastRangeSize < rangeSize) {
              // Merge with previous range
              ranges.pop();
              ranges[ranges.length - 1].end = maxChapter;
              ranges[ranges.length - 1].label = `${ranges[ranges.length - 1].start}-${maxChapter}`;
            }
          }
          return ranges;
        },

        // Get filtered chapters based on current range
        getFilteredChapters() {
          if (!this.showChapterRanges) return this.chapters;
          const ranges = this.chapterRanges;
          if (ranges.length === 0) return this.chapters;
          const range = ranges[this.navModal.chapterRange] || ranges[0];
          return this.chapters.filter(ch => ch >= range.start && ch <= range.end);
        },

        // Reset chapter range when book changes and scroll to current chapter
        resetChapterRange() {
          // Find the range that contains the current chapter
          if (this.showChapterRanges) {
            const ranges = this.chapterRanges;
            const rangeIndex = ranges.findIndex(r =>
              this.selectedChapter >= r.start && this.selectedChapter <= r.end
            );
            this.navModal.chapterRange = rangeIndex >= 0 ? rangeIndex : 0;
            // Scroll to current chapter range after drawer opens
            this.$nextTick(() => {
              this.scrollToChapterRange(this.navModal.chapterRange, false);
            });
          } else {
            this.navModal.chapterRange = 0;
          }
        },

        // Scroll to a specific chapter range in the grid
        scrollToChapterRange(rangeIdx, smooth = true) {
          const grid = this.$refs.chapterGrid;
          if (!grid) return;

          const ranges = this.chapterRanges;
          if (rangeIdx < 0 || rangeIdx >= ranges.length) return;

          // Set flag to prevent scroll handler from overriding selection
          this.navModal.isScrolling = true;
          this.navModal.chapterRange = rangeIdx;

          const firstButton = grid.querySelector('button');
          if (!firstButton) return;

          const buttonHeight = firstButton.offsetHeight;
          const gap = parseFloat(window.getComputedStyle(grid.querySelector('.grid')).gap) || 8;
          const rowHeight = buttonHeight + gap;

          // Calculate target row based on range start chapter
          // 5 chapters per row, so row = (chapter - 1) / 5
          const targetChapter = ranges[rangeIdx].start;
          const targetRow = Math.floor((targetChapter - 1) / 5);
          const scrollTop = targetRow * rowHeight;

          grid.scrollTo({
            top: scrollTop,
            behavior: smooth ? 'smooth' : 'auto'
          });

          // Clear flag after scroll animation completes
          setTimeout(() => {
            this.navModal.isScrolling = false;
          }, smooth ? 350 : 50);
        },

        // Handle chapter grid scroll to sync range selection
        onChapterGridScroll() {
          if (!this.showChapterRanges) return;
          // Skip if programmatic scroll is in progress
          if (this.navModal.isScrolling) return;

          const grid = this.$refs.chapterGrid;
          if (!grid) return;

          const firstButton = grid.querySelector('button');
          if (!firstButton) return;

          const buttonHeight = firstButton.offsetHeight;
          const gap = parseFloat(window.getComputedStyle(grid.querySelector('.grid')).gap) || 8;
          const rowHeight = buttonHeight + gap;

          // Calculate which chapter is at top of visible area
          const scrollTop = grid.scrollTop;
          const topRow = Math.floor(scrollTop / rowHeight);
          const topChapter = topRow * 5 + 1; // 5 chapters per row

          // Find which range contains this chapter
          const ranges = this.chapterRanges;
          const rangeIdx = ranges.findIndex(r => topChapter >= r.start && topChapter <= r.end);

          if (rangeIdx >= 0 && rangeIdx < ranges.length) {
            this.navModal.chapterRange = rangeIdx;
          }
        },

        // Migrate old ref keys (e.g., "å‰µä¸–è¨˜1:1" -> "GEN:1:1") for backward compatibility
        migrateRefKeys(obj) {
          if (!obj || typeof obj !== 'object') return obj;
          const migrated = {};
          for (const [key, value] of Object.entries(obj)) {
            // Check if key is in old format (book name + chapter:verse, e.g., "å‰µä¸–è¨˜1:1")
            // New format uses colons: "GEN:1:1"
            if (key.includes(':') && !key.match(/^[A-Z0-9]+:/)) {
              // Old format: try to extract book name and convert
              const match = key.match(/^(.+?)(\d+:\d+)$/);
              if (match) {
                const bookName = match[1];
                const chapterVerse = match[2];
                const bookCode = getBookCode(bookName);
                const newKey = `${bookCode}:${chapterVerse}`;
                migrated[newKey] = value;
                continue;
              }
            }
            // Keep as-is (already in new format or unrecognized)
            migrated[key] = value;
          }
          return migrated;
        },

        // Get current selected version info
        get currentVersion() {
          return this.availableVersions.find(v => v.id === this.selectedVersionId) || this.availableVersions[0];
        },

        // Check if any drawer/modal is open (to prevent background scroll)
        get isAnyDrawerOpen() {
          return this.settingsModal.show ||
                 this.versionModal.show ||
                 this.navModal.show ||
                 this.titleModal.show ||
                 this.noteModal.show ||
                 this.highlightModal.show ||
                 this.snModal.show;
        },

        // Check if a version is cached
        isVersionCached(versionId) {
          return this.cachedVersions.includes(versionId);
        },

        // Save selected version preference
        async saveSelectedVersion() {
          try {
            await idbKeyval.set('bible_selectedVersion', this.selectedVersionId);
          } catch (e) {
            console.warn('Failed to save selected version:', e);
          }
        },

        // Save cached versions list
        async saveCachedVersions() {
          try {
            await idbKeyval.set('bible_cachedVersions', JSON.parse(JSON.stringify(this.cachedVersions)));
          } catch (e) {
            console.warn('Failed to save cached versions list:', e);
          }
        },

        // Download and cache a Bible version
        async downloadVersion(version) {
          this.versionModal.downloading = version.id;

          try {
            const response = await fetch(`./txt/${version.file}`);
            if (!response.ok) {
              throw new Error(`Failed to download: ${response.status}`);
            }
            const text = await response.text();

            // Cache in IndexedDB
            await idbKeyval.set(`bible_version_${version.id}`, text);

            // Update cached versions list
            if (!this.cachedVersions.includes(version.id)) {
              this.cachedVersions.push(version.id);
              await this.saveCachedVersions();
            }

            this.versionModal.downloading = null;
            return true;
          } catch (error) {
            console.error('Download failed:', error);
            this.versionModal.downloading = null;
            return false;
          }
        },

        // Delete cached version
        async deleteVersion(versionId) {
          try {
            await idbKeyval.del(`bible_version_${versionId}`);
            this.cachedVersions = this.cachedVersions.filter(id => id !== versionId);
            await this.saveCachedVersions();
            // Also remove from compare order
            const idx = this.compareVersionOrder.indexOf(versionId);
            if (idx !== -1) {
              this.compareVersionOrder.splice(idx, 1);
              await this.saveCompareVersionOrder();
            }
          } catch (e) {
            console.warn('Failed to delete version:', e);
          }
        },

        // Select and load a version
        async selectVersion(versionId) {
          const version = this.availableVersions.find(v => v.id === versionId);
          if (!version) return;

          // Download if not cached
          if (!this.isVersionCached(versionId)) {
            const success = await this.downloadVersion(version);
            if (!success) return;
          }

          this.selectedVersionId = versionId;
          await this.saveSelectedVersion();
          this.versionModal.show = false;

          // Reload verses
          await this.parseVerses();
        },

        async parseVerses() {
          let rawText;
          const version = this.currentVersion;

          // Reset data
          this.allVerses = [];
          this.books = [];
          this.bibleData = {};

          // Try to load from IndexedDB cache first
          try {
            const cachedData = await idbKeyval.get(`bible_version_${this.selectedVersionId}`);
            if (cachedData) {
              this.isLoading = true;
              this.loadingMessage = 'æ­£åœ¨è¼‰å…¥ç¶“æ–‡...';
              this.loadingSubMessage = `${version.name} - å¾å¿«å–è®€å–`;
              rawText = cachedData;
              // Small delay to show loading state
              await new Promise(resolve => setTimeout(resolve, 100));
            }
          } catch (e) {
            console.warn('Failed to read from cache:', e);
          }

          // If not cached, fetch from network
          if (!rawText) {
            this.isLoading = true;
            this.loadingMessage = 'æ­£åœ¨ä¸‹è¼‰ç¶“æ–‡è³‡æ–™...';
            this.loadingSubMessage = `${version.name} (${version.size})`;

            try {
              const response = await fetch(`./txt/${version.file}`);
              if (!response.ok) {
                throw new Error(`Failed to load ${version.file}: ${response.status}`);
              }
              rawText = await response.text();

              // Cache the data in IndexedDB
              this.loadingMessage = 'æ­£åœ¨å„²å­˜å¿«å–...';
              this.loadingSubMessage = 'ä¸‹æ¬¡è¼‰å…¥å°‡æ›´å¿«';
              try {
                await idbKeyval.set(`bible_version_${this.selectedVersionId}`, rawText);
                if (!this.cachedVersions.includes(this.selectedVersionId)) {
                  this.cachedVersions.push(this.selectedVersionId);
                  await this.saveCachedVersions();
                }
                console.log('Bible data cached successfully');
              } catch (cacheError) {
                console.warn('Failed to cache Bible data:', cacheError);
              }
            } catch (error) {
              console.error('Failed to load Bible data:', error);
              this.isLoading = false;
              this.loadingMessage = '';
              this.loadingSubMessage = '';
              return;
            }
          }

          // Parse the new format
          const lines = rawText.split('\n');
          const bookOrder = []; // Maintain book order
          const bookSet = new Set();
          const seenRefs = new Set();

          for (const line of lines) {
            // Skip header line and empty lines
            if (line.startsWith('@') || !line.trim()) continue;

            // Parse format: BOOK_CODE|chapter|verse|text
            const parts = line.split('|');
            if (parts.length >= 4) {
              const [rawBookCode, chapter, verse, ...textParts] = parts;
              const text = textParts.join('|'); // In case text contains |
              const chapterNum = parseInt(chapter);
              const verseNum = parseInt(verse);

              if (isNaN(chapterNum) || isNaN(verseNum)) continue;

              // Normalize book code to canonical form
              const bookCode = normalizeBookCode(rawBookCode);
              const ref = `${bookCode}:${chapterNum}:${verseNum}`;

              // Skip duplicates
              if (seenRefs.has(ref)) continue;
              seenRefs.add(ref);

              // Track book order using canonical codes
              if (!bookSet.has(bookCode)) {
                bookSet.add(bookCode);
                bookOrder.push(bookCode);
              }

              if (!this.bibleData[bookCode]) {
                this.bibleData[bookCode] = {};
              }
              if (!this.bibleData[bookCode][chapterNum]) {
                this.bibleData[bookCode][chapterNum] = [];
              }

              const verseData = {
                ref,
                bookCode,
                chapter: chapterNum,
                verseNum,
                text
              };

              this.bibleData[bookCode][chapterNum].push(verseData);
              this.allVerses.push(verseData);
            }
          }

          this.totalVerses = this.allVerses.length;
          this.books = bookOrder;

          // Clear loading state
          this.isLoading = false;
          this.loadingMessage = '';
          this.loadingSubMessage = '';

          if (this.books.length > 0) {
            // Set initial book (first book as default)
            this.selectedBook = this.books[0];
            this.updateChapters();
            this.loadVerses();

            // Preload dictionary for SN versions (don't await, let it load in background)
            if (this.hasSN) {
              this.loadDictionary();
            }

            // Restore saved position after DOM is ready
            this.$nextTick(() => {
              let needsReload = false;

              if (this._pendingBook && this.books.includes(this._pendingBook)) {
                this.selectedBook = this._pendingBook;
                this.updateChapters();
                needsReload = true;
              }

              if (this._pendingChapter && this.chapters.includes(this._pendingChapter)) {
                this.selectedChapter = this._pendingChapter;
                needsReload = true;
              }

              if (needsReload) {
                this.loadVerses();
              }
            });
          }
        },

        updateChapters() {
          if (this.bibleData[this.selectedBook]) {
            this.chapters = Object.keys(this.bibleData[this.selectedBook])
              .map(Number)
              .sort((a, b) => a - b);
          } else {
            this.chapters = [];
          }
        },

        onBookChange() {
          this.updateChapters();
          this.selectedChapter = this.chapters[0] || 1;
          this.loadVerses();
          this.saveReadingPosition();
        },

        loadVerses() {
          if (this.bibleData[this.selectedBook] && this.bibleData[this.selectedBook][this.selectedChapter]) {
            this.currentVerses = this.bibleData[this.selectedBook][this.selectedChapter];
          } else {
            this.currentVerses = [];
          }
          this.saveReadingPosition();
        },

        get canGoPrev() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          const bookIndex = this.books.indexOf(this.selectedBook);
          return chapterIndex > 0 || bookIndex > 0;
        },

        get canGoNext() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          const bookIndex = this.books.indexOf(this.selectedBook);
          return chapterIndex < this.chapters.length - 1 || bookIndex < this.books.length - 1;
        },

        prevChapter() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          if (chapterIndex > 0) {
            this.selectedChapter = this.chapters[chapterIndex - 1];
            this.loadVerses();
          } else {
            const bookIndex = this.books.indexOf(this.selectedBook);
            if (bookIndex > 0) {
              this.selectedBook = this.books[bookIndex - 1];
              this.updateChapters();
              this.selectedChapter = this.chapters[this.chapters.length - 1];
              this.loadVerses();
            }
          }
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        nextChapter() {
          const chapterIndex = this.chapters.indexOf(this.selectedChapter);
          if (chapterIndex < this.chapters.length - 1) {
            this.selectedChapter = this.chapters[chapterIndex + 1];
            this.loadVerses();
          } else {
            const bookIndex = this.books.indexOf(this.selectedBook);
            if (bookIndex < this.books.length - 1) {
              this.selectedBook = this.books[bookIndex + 1];
              this.updateChapters();
              this.selectedChapter = this.chapters[0];
              this.loadVerses();
            }
          }
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        search() {
          if (!this.searchQuery.trim()) {
            this.searchResults = [];
            return;
          }

          const query = this.searchQuery.toLowerCase();
          this.searchResults = this.allVerses.filter(verse =>
            verse.text.toLowerCase().includes(query) ||
            verse.ref.toLowerCase().includes(query)
          );
        },

        // Highlight search query in text
        highlightSearch(text) {
          if (!this.searchQuery.trim() || !text) return text;
          const query = this.searchQuery.trim();
          // Escape special regex characters
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${escaped})`, 'gi');
          return text.replace(regex, '<mark class="search-highlight">$1</mark>');
        },

        clearSearch() {
          this.searchQuery = '';
          this.searchResults = [];
        },

        goToVerse(verse) {
          this.selectedBook = verse.bookCode;
          this.updateChapters();
          this.selectedChapter = verse.chapter;
          this.loadVerses();
          this.clearSearch();

          // Scroll to and highlight the verse after DOM updates
          this.$nextTick(() => {
            this.scrollToAndHighlightVerse(verse.verseNum);
          });
        },

        toggleDarkMode() {
          this.isDark = !this.isDark;
          document.documentElement.classList.toggle('dark', this.isDark);
        },

        // Verse actions widget
        showVerseActions(verse) {
          this.verseActions = {
            show: true,
            verse: verse
          };
        },

        hideVerseActions() {
          this.verseActions.show = false;
        },

        // Title modal
        openTitleModal() {
          const verse = this.verseActions.verse;
          this.openTitleModalForVerse(verse);
          this.hideVerseActions();
        },

        // Open title modal for a specific verse (used for direct click on title)
        openTitleModalForVerse(verse) {
          this.titleModal = {
            show: true,
            verse: verse,
            title: this.customTitles[verse.ref] || ''
          };

          // Focus input after modal opens
          this.$nextTick(() => {
            if (this.$refs.titleInput) {
              this.$refs.titleInput.focus();
            }
          });
        },

        closeTitleModal() {
          this.titleModal.show = false;
          this.titleModal.title = '';
        },

        saveTitle() {
          const ref = this.titleModal.verse?.ref;
          if (ref && this.titleModal.title.trim()) {
            this.customTitles[ref] = this.titleModal.title.trim();
          } else if (ref) {
            delete this.customTitles[ref];
          }
          this.saveCustomTitles();
          this.closeTitleModal();
        },

        // Note modal
        openNoteModal(verse) {
          if (!verse) verse = this.verseActions.verse;
          this.noteModal = {
            show: true,
            verse: verse,
            note: this.notes[verse.ref] || ''
          };
          this.hideVerseActions();

          this.$nextTick(() => {
            if (this.$refs.noteInput) {
              this.$refs.noteInput.focus();
            }
          });
        },

        closeNoteModal() {
          this.noteModal.show = false;
          this.noteModal.note = '';
        },

        saveNote() {
          const ref = this.noteModal.verse?.ref;
          if (ref && this.noteModal.note.trim()) {
            this.notes[ref] = this.noteModal.note.trim();
          } else if (ref) {
            delete this.notes[ref];
          }
          this.saveNotes();
          this.closeNoteModal();
        },

        // Highlight methods
        openHighlightModal(verse) {
          const v = verse || this.verseActions.verse;
          if (!v) return;
          this.hideVerseActions();
          this.highlightModal = {
            show: true,
            verse: v,
            editingId: null,
            editName: '',
            editColor: ''
          };
        },

        closeHighlightModal() {
          this.highlightModal.show = false;
          this.highlightModal.editingId = null;
        },

        // Compare/Parallel versions
        async toggleCompare() {
          const verse = this.verseActions.verse;
          if (!verse) return;

          // If already comparing this verse, close it
          if (this.compareVerseRef === verse.ref) {
            this.compareVerseRef = null;
            this.compareVerses = [];
            this.hideVerseActions();
            return;
          }

          // Load comparison from enabled versions in user-configured order
          this.compareVerseRef = verse.ref;
          this.compareVerses = [];
          this.hideVerseActions();

          // Use user's compare order, falling back to all cached versions (excluding current) if empty
          let versionsToCompare = this.compareVersionOrder.filter(id =>
            id !== this.selectedVersionId && this.cachedVersions.includes(id)
          );

          // If no custom order set, use all other cached versions
          if (versionsToCompare.length === 0 && this.compareVersionOrder.length === 0) {
            versionsToCompare = this.cachedVersions.filter(id => id !== this.selectedVersionId);
          }

          for (const versionId of versionsToCompare) {
            try {
              const cachedData = await idbKeyval.get(`bible_version_${versionId}`);
              if (cachedData) {
                const verseText = this.findVerseInRawText(cachedData, verse.ref);
                if (verseText) {
                  const versionInfo = this.availableVersions.find(v => v.id === versionId);
                  this.compareVerses.push({
                    versionId,
                    versionName: versionInfo?.name || versionId,
                    text: verseText
                  });
                }
              }
            } catch (e) {
              console.warn(`Failed to load version ${versionId} for comparison:`, e);
            }
          }
        },

        // Get cached versions not yet added to compare order
        getAvailableCompareVersions() {
          return this.availableVersions.filter(v =>
            this.cachedVersions.includes(v.id) &&
            !this.compareVersionOrder.includes(v.id)
          );
        },

        // Toggle a version in/out of compare list
        toggleCompareVersion(versionId) {
          const idx = this.compareVersionOrder.indexOf(versionId);
          if (idx === -1) {
            this.compareVersionOrder.push(versionId);
          } else {
            this.compareVersionOrder.splice(idx, 1);
          }
          this.saveCompareVersionOrder();
        },

        // Move a version up or down in the compare order
        moveCompareVersion(fromIdx, direction) {
          const toIdx = fromIdx + direction;
          if (toIdx < 0 || toIdx >= this.compareVersionOrder.length) return;

          const temp = this.compareVersionOrder[fromIdx];
          this.compareVersionOrder[fromIdx] = this.compareVersionOrder[toIdx];
          this.compareVersionOrder[toIdx] = temp;
          this.saveCompareVersionOrder();
        },

        // Handle drag-and-drop reorder
        reorderCompareVersion(draggedId, dropIdx) {
          const draggedIdx = this.compareVersionOrder.indexOf(this.versionModal.draggedVersionId);
          if (draggedIdx === -1 || draggedIdx === dropIdx) return;

          // Remove from old position
          const [removed] = this.compareVersionOrder.splice(draggedIdx, 1);
          // Insert at new position
          this.compareVersionOrder.splice(dropIdx, 0, removed);
          this.saveCompareVersionOrder();
        },

        // Save compare order to storage
        async saveCompareVersionOrder() {
          try {
            await idbKeyval.set('bible_compare_order', this.compareVersionOrder);
          } catch (e) {
            console.warn('Failed to save compare order:', e);
          }
        },

        // Load compare order from storage
        async loadCompareVersionOrder() {
          try {
            const saved = await idbKeyval.get('bible_compare_order');
            if (Array.isArray(saved)) {
              // Filter out any versions that are no longer cached
              this.compareVersionOrder = saved.filter(id => this.cachedVersions.includes(id));
            }
          } catch (e) {
            console.warn('Failed to load compare order:', e);
          }
        },

        findVerseInRawText(rawText, ref) {
          // ref format is "BOOK_CODE:chapter:verse", e.g. "GEN:1:1"
          // rawText line format is "BOOK_CODE|chapter|verse|text"
          const [bookCode, chapter, verse] = ref.split(':');
          const regex = new RegExp(`^${bookCode}\\|${chapter}\\|${verse}\\|(.*)$`, 'm');
          const match = rawText.match(regex);
          return match ? match[1] : null;
        },

        applyHighlight(highlightId) {
          const ref = this.highlightModal.verse?.ref;
          if (!ref) return;
          this.verseHighlights[ref] = highlightId;
          this.saveHighlights();
          this.closeHighlightModal();
        },

        removeHighlightFromVerse() {
          const ref = this.highlightModal.verse?.ref;
          if (ref && this.verseHighlights[ref]) {
            delete this.verseHighlights[ref];
            this.saveHighlights();
          }
          this.closeHighlightModal();
        },

        startHighlightEdit(id) {
          this.highlightModal.editingId = id;
          this.highlightModal.editName = this.highlightDefs[id].name;
          this.highlightModal.editColor = this.highlightDefs[id].color;
        },

        cancelHighlightEdit() {
          this.highlightModal.editingId = null;
          this.highlightModal.editName = '';
          this.highlightModal.editColor = '';
        },

        saveHighlightEdit(id) {
          if (this.highlightModal.editName.trim()) {
            this.highlightDefs[id] = {
              name: this.highlightModal.editName.trim(),
              color: this.highlightModal.editColor
            };
            this.saveHighlightDefs();
          }
          this.cancelHighlightEdit();
        },

        addNewHighlight() {
          // Generate new ID
          const existingIds = Object.keys(this.highlightDefs);
          let newNum = 1;
          while (existingIds.includes('h' + newNum)) {
            newNum++;
          }
          const newId = 'h' + newNum;
          // Random pastel color
          const colors = ['#fde68a', '#a7f3d0', '#fca5a5', '#c4b5fd', '#93c5fd', '#fdba74'];
          const color = colors[Math.floor(Math.random() * colors.length)];
          this.highlightDefs[newId] = { name: 'æ–°æ¨™è¨»', color };
          this.saveHighlightDefs();
          // Start editing immediately
          this.startHighlightEdit(newId);
        },

        deleteHighlight(id) {
          // Remove from defs
          delete this.highlightDefs[id];
          // Remove from all verses using this highlight
          for (const ref in this.verseHighlights) {
            if (this.verseHighlights[ref] === id) {
              delete this.verseHighlights[ref];
            }
          }
          this.saveHighlightDefs();
          this.saveHighlights();
        },

        async saveHighlights() {
          try {
            await idbKeyval.set('bible_verseHighlights', JSON.parse(JSON.stringify(this.verseHighlights)));
            if (this.autoSync && this.fileHandle) {
              await this.syncToFile();
            }
          } catch (e) {
            console.warn('Failed to save highlights:', e);
          }
        },

        async saveHighlightDefs() {
          try {
            await idbKeyval.set('bible_highlightDefs', JSON.parse(JSON.stringify(this.highlightDefs)));
            if (this.autoSync && this.fileHandle) {
              await this.syncToFile();
            }
          } catch (e) {
            console.warn('Failed to save highlight definitions:', e);
          }
        },

        getHighlightColor(verseRef) {
          const highlightId = this.verseHighlights[verseRef];
          if (highlightId && this.highlightDefs[highlightId]) {
            return this.highlightDefs[highlightId].color;
          }
          return null;
        },

        // Settings & File System Access API methods
        async saveAutoSyncPreference() {
          try {
            await idbKeyval.set('bible_autoSync', this.autoSync);
          } catch (e) {
            console.warn('Failed to save auto-sync preference:', e);
          }
        },

        getExportData() {
          return {
            version: 1,
            exportedAt: new Date().toISOString(),
            customTitles: JSON.parse(JSON.stringify(this.customTitles)),
            notes: JSON.parse(JSON.stringify(this.notes)),
            highlightDefs: JSON.parse(JSON.stringify(this.highlightDefs)),
            verseHighlights: JSON.parse(JSON.stringify(this.verseHighlights)),
            selectedBook: this.selectedBook,
            selectedChapter: this.selectedChapter
          };
        },

        // Re-select file for auto-save
        async reselectFile() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            // Prompt user to select a new file
            this.fileHandle = await window.showSaveFilePicker({
              suggestedName: 'bible-backup.json',
              types: [{
                description: 'JSON Files',
                accept: { 'application/json': ['.json'] }
              }]
            });
            await this.saveFileHandle();
            this.settingsModal.message = `å·²é¸æ“‡ï¼š${this.fileHandle.name}`;
            this.settingsModal.isError = false;
          } catch (e) {
            if (e.name === 'AbortError') {
              this.settingsModal.message = '';
            } else {
              console.error('File selection failed:', e);
              this.settingsModal.message = 'é¸æ“‡æª”æ¡ˆå¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        // Save to currently selected file (requires file handle)
        async saveToFile() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            const data = this.getExportData();
            const jsonString = JSON.stringify(data, null, 2);

            if (!this.fileHandle) {
              // No file selected, act like saveAsNewFile
              await this.saveAsNewFile();
              return;
            }

            // Verify permission for existing file handle
            const hasPermission = await this.verifyPermission(true);
            if (!hasPermission) {
              this.settingsModal.message = 'æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹é‡æ–°é¸æ“‡æª”æ¡ˆ';
              this.settingsModal.isError = true;
              this.fileHandle = null;
              await this.saveFileHandle();
              return;
            }

            // Write to the file
            const writable = await this.fileHandle.createWritable();
            await writable.write(jsonString);
            await writable.close();

            this.settingsModal.message = `å·²å„²å­˜è‡³ ${this.fileHandle.name}`;
            this.settingsModal.isError = false;
          } catch (e) {
            if (e.name === 'AbortError') {
              this.settingsModal.message = '';
            } else {
              console.error('Save failed:', e);
              this.settingsModal.message = 'å„²å­˜å¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        // Save as new file (always prompts for new location, or downloads if no file API)
        async saveAsNewFile() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            const data = this.getExportData();
            const jsonString = JSON.stringify(data, null, 2);

            if (this.hasFileSystemAccess) {
              // Use File System Access API - always prompt for new file
              this.fileHandle = await window.showSaveFilePicker({
                suggestedName: 'bible-backup.json',
                types: [{
                  description: 'JSON Files',
                  accept: { 'application/json': ['.json'] }
                }]
              });
              // Save the new file handle to IndexedDB
              await this.saveFileHandle();

              // Write to the file
              const writable = await this.fileHandle.createWritable();
              await writable.write(jsonString);
              await writable.close();

              this.settingsModal.message = `å·²å„²å­˜è‡³ ${this.fileHandle.name}`;
              this.settingsModal.isError = false;
            } else {
              // Fallback to download
              const blob = new Blob([jsonString], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `bible-backup-${new Date().toISOString().slice(0, 10)}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              this.settingsModal.message = 'å‚™ä»½æª”æ¡ˆå·²ï¿½ï¿½ï¿½è¼‰';
              this.settingsModal.isError = false;
            }
          } catch (e) {
            if (e.name === 'AbortError') {
              this.settingsModal.message = '';
            } else {
              console.error('Save as failed:', e);
              this.settingsModal.message = 'å¦å­˜æ–°æª”å¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        // Download backup as JSON file (always downloads, regardless of File System API)
        async downloadBackup() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            const data = this.getExportData();
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bible-backup-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            this.settingsModal.message = 'å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰';
            this.settingsModal.isError = false;
          } catch (e) {
            console.error('Download backup failed:', e);
            this.settingsModal.message = 'å»ºç«‹å‚™ä»½å¤±æ•—ï¼š' + e.message;
            this.settingsModal.isError = true;
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        async importData() {
          this.settingsModal.isBusy = true;
          this.settingsModal.message = '';

          try {
            let fileContent;

            if (this.hasFileSystemAccess) {
              // Use File System Access API
              const [handle] = await window.showOpenFilePicker({
                types: [{
                  description: 'JSON Files',
                  accept: { 'application/json': ['.json'] }
                }],
                multiple: false
              });

              const file = await handle.getFile();
              fileContent = await file.text();

              // Store the handle for future use and persist to IndexedDB
              this.fileHandle = handle;
              await this.saveFileHandle();
            } else {
              // Fallback to file input
              fileContent = await new Promise((resolve, reject) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,application/json';
                input.onchange = async (e) => {
                  const file = e.target.files[0];
                  if (file) {
                    resolve(await file.text());
                  } else {
                    reject(new Error('No file selected'));
                  }
                };
                input.click();
              });
            }

            const data = JSON.parse(fileContent);

            // Validate data structure
            if (!data.version || !data.exportedAt) {
              throw new Error('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼');
            }

            // Import the data (with migration for old format)
            if (data.customTitles) {
              this.customTitles = this.migrateRefKeys(data.customTitles);
              await this.saveCustomTitles();
            }
            if (data.notes) {
              this.notes = this.migrateRefKeys(data.notes);
              await this.saveNotes();
            }
            if (data.highlightDefs) {
              this.highlightDefs = { ...this.highlightDefs, ...data.highlightDefs };
              await this.saveHighlightDefs();
            }
            if (data.verseHighlights) {
              this.verseHighlights = this.migrateRefKeys(data.verseHighlights);
              await this.saveHighlights();
            }
            if (data.selectedBook) {
              // Convert old book names to codes for backward compatibility
              const bookCode = getBookCode(data.selectedBook);
              if (this.books.includes(bookCode)) {
                this.selectedBook = bookCode;
                this.updateChapters();
              }
            }
            if (data.selectedChapter && this.chapters.includes(data.selectedChapter)) {
              this.selectedChapter = data.selectedChapter;
            }
            this.loadVerses();
            await this.saveReadingPosition();

            const noteCount = Object.keys(this.notes).length;
            const titleCount = Object.keys(this.customTitles).length;
            const highlightCount = Object.keys(this.verseHighlights).length;
            this.settingsModal.message = `å·²åŒ¯å…¥ ${titleCount} å€‹æ¨™é¡Œã€${noteCount} å€‹ç­†è¨˜å’Œ ${highlightCount} å€‹æ¨™è¨»`;
            this.settingsModal.isError = false;
          } catch (e) {
            if (e.name === 'AbortError') {
              // User cancelled
              this.settingsModal.message = '';
            } else {
              console.error('Import failed:', e);
              this.settingsModal.message = 'åŒ¯å…¥å¤±æ•—ï¼š' + e.message;
              this.settingsModal.isError = true;
            }
          } finally {
            this.settingsModal.isBusy = false;
          }
        },

        async unlinkFile() {
          this.fileHandle = null;
          await this.saveFileHandle();
          this.settingsModal.message = 'å·²è§£é™¤æª”æ¡ˆé€£çµ';
          this.settingsModal.isError = false;
        },

        // Clear all cached versions except the currently selected one
        async clearAllVersions() {
          try {
            const versionsToDelete = this.cachedVersions.filter(id => id !== this.selectedVersionId);
            for (const versionId of versionsToDelete) {
              await idbKeyval.del(`bible_version_${versionId}`);
            }
            this.cachedVersions = [this.selectedVersionId];
            await this.saveCachedVersions();
            this.settingsModal.message = `å·²æ¸…é™¤ ${versionsToDelete.length} å€‹è­¯æœ¬å¿«å–`;
            this.settingsModal.isError = false;
          } catch (e) {
            console.error('Failed to clear cache:', e);
            this.settingsModal.message = 'æ¸…é™¤å¿«å–å¤±æ•—ï¼š' + e.message;
            this.settingsModal.isError = true;
          }
        },

        // Auto-sync on data changes (call after saving notes/titles)
        async triggerAutoSync() {
          if (this.autoSync && this.fileHandle && this.hasFileSystemAccess) {
            try {
              // Verify permission before writing
              const hasPermission = await this.verifyPermission(true);
              if (!hasPermission) {
                console.warn('Auto-sync skipped: permission denied');
                return;
              }

              const data = this.getExportData();
              const jsonString = JSON.stringify(data, null, 2);
              const writable = await this.fileHandle.createWritable();
              await writable.write(jsonString);
              await writable.close();
              console.log('Auto-synced to file');
            } catch (e) {
              console.warn('Auto-sync failed:', e);
            }
          }
        },

        // Strong's Number support
        // Check if current version has Strong's Numbers
        get hasSN() {
          return this.selectedVersionId.includes('-SN') || this.selectedVersionId.includes('_SN');
        },

        // Get dictionary file name for current version
        getDictFileName() {
          // For SN versions, the dict file should match the version
          // e.g., zh-rTW_CUV-SN -> zh-rTW_CUV-SN.dict
          // e.g., en_KJV-SN -> en_KJV-SN.dict
          return `${this.selectedVersionId}.dict`;
        },

        // Load dictionary for a specific version (or current version if not specified)
        // Stores raw text instead of parsing into map - uses regex lookup on demand
        async loadDictionary(versionId = null) {
          const targetVersionId = versionId || this.selectedVersionId;
          const isSNVersion = targetVersionId && targetVersionId.includes('-SN');

          if (!isSNVersion) return;
          if (this.snDictTexts[targetVersionId]) return; // Already loaded

          this.snDictLoading = true;

          try {
            // Try to load from cache first
            const cacheKey = `bible_dict_${targetVersionId}`;
            let dictText = await idbKeyval.get(cacheKey);

            if (!dictText) {
              // Fetch from network
              const dictFile = `${targetVersionId}.dict`;
              const response = await fetch(`./dict/${dictFile}`);
              if (!response.ok) {
                console.warn(`Dictionary not found: ${dictFile}`);
                return;
              }
              dictText = await response.text();

              // Cache it
              try {
                await idbKeyval.set(cacheKey, dictText);
              } catch (e) {
                console.warn('Failed to cache dictionary:', e);
              }
            }

            // Store raw text - will use regex to find definitions on demand
            this.snDictTexts[targetVersionId] = dictText;
            console.log(`Loaded dictionary text for ${targetVersionId}`);
          } catch (e) {
            console.error('Failed to load dictionary:', e);
          } finally {
            this.snDictLoading = false;
          }
        },

        // Render verse text with clickable SN codes
        renderVerseText(text) {
          if (!this.hasSN || !text) {
            // Escape HTML for safety
            return this.escapeHtml(text);
          }

          // Match Strong's Number patterns: <H####> or <G####>
          // H = Hebrew (OT), G = Greek (NT)
          const snPattern = /<([HG]\d+)>/g;

          // Replace SN codes with clickable spans
          return text.replace(snPattern, (match, code) => {
            return `<span class="sn-code" onclick="Alpine.$data(document.querySelector('[x-data]')).showSNDefinition('${code}')">${code}</span>`;
          });
        },

        // Render comparison verse text - check if the version has SN codes
        renderCompareVerseText(text, versionId) {
          if (!text) return '';

          // Check if this version is a Strong's Number version
          const isSNVersion = versionId && versionId.includes('-SN');

          if (!isSNVersion) {
            return this.escapeHtml(text);
          }

          // Match Strong's Number patterns: <H####> or <G####>
          const snPattern = /<([HG]\d+)>/g;

          // Replace SN codes with clickable spans
          // Dictionary language is determined by selected version, not the clicked version
          return text.replace(snPattern, (match, code) => {
            return `<span class="sn-code" onclick="Alpine.$data(document.querySelector('[x-data]')).showSNDefinition('${code}')">${code}</span>`;
          });
        },

        // Escape HTML to prevent XSS
        escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        },

        // Show SN definition modal
        // Uses dictionary based on current selected version's language (Chinese or English)
        async showSNDefinition(code) {
          this.snModal.show = true;
          this.snModal.code = code;
          this.snModal.definition = '';
          this.snModal.loading = true;

          // Determine dictionary based on selected version's language
          // Chinese versions start with 'zh', use Chinese SN dictionary
          // Otherwise use English SN dictionary
          const isChineseVersion = this.selectedVersionId.startsWith('zh');
          const dictVersionId = isChineseVersion ? 'zh-rTW_CUV-SN' : 'en_KJV-SN';

          // Load dictionary if not loaded
          if (!this.snDictTexts[dictVersionId]) {
            await this.loadDictionary(dictVersionId);
          }

          this.snModal.loading = false;

          // Look up definition using regex on raw text
          // Dictionary format: CODE,definition (one per line)
          const dictText = this.snDictTexts[dictVersionId];
          if (dictText) {
            const regex = new RegExp(`^${code},(.*)$`, 'm');
            const match = dictText.match(regex);
            if (match) {
              this.snModal.definition = this.formatDefinition(match[1]);
            }
          }
        },

        // Format definition for display
        formatDefinition(definition) {
          if (!definition) return '';

          // Replace literal \n with actual line breaks
          let formatted = definition.replace(/\\n/g, '\n');

          // Process special links BEFORE escaping HTML
          // Pattern: <SN|display_text|code> -> clickable SN link
          // Pattern: <Verse|display_text|BOOK:chapter:verse> -> clickable verse link
          // Pattern: #<Verse|...|...>| -> verse with # prefix and | suffix

          // First, replace the patterns with placeholders to protect them from HTML escaping
          const snLinks = [];
          const verseLinks = [];

          // Extract SN links: <SN|display|code>
          formatted = formatted.replace(/<SN\|([^|]+)\|([^>]+)>/g, (match, display, code) => {
            const index = snLinks.length;
            snLinks.push({ display, code });
            return `__SN_LINK_${index}__`;
          });

          // Extract Verse links: <Verse|display|BOOK:chapter:verse> or #<Verse|...|...>|
          formatted = formatted.replace(/#?<Verse\|([^|]+)\|([^>]+)>\|?/g, (match, display, ref) => {
            const index = verseLinks.length;
            verseLinks.push({ display, ref });
            return `__VERSE_LINK_${index}__`;
          });

          // Escape HTML
          formatted = this.escapeHtml(formatted);

          // Restore SN links as clickable elements
          snLinks.forEach((link, index) => {
            const escapedDisplay = this.escapeHtml(link.display);
            const clickHandler = `Alpine.$data(document.querySelector('[x-data]')).showSNDefinition('${link.code}')`;
            formatted = formatted.replace(
              `__SN_LINK_${index}__`,
              `<span class="sn-link" onclick="${clickHandler}">${escapedDisplay}</span>`
            );
          });

          // Restore Verse links as clickable elements
          verseLinks.forEach((link, index) => {
            const escapedDisplay = this.escapeHtml(link.display);
            const clickHandler = `Alpine.$data(document.querySelector('[x-data]')).goToVerseByRef('${link.ref}')`;
            formatted = formatted.replace(
              `__VERSE_LINK_${index}__`,
              `<span class="verse-link" onclick="${clickHandler}">${escapedDisplay}</span>`
            );
          });

          // Convert newlines to <br>
          formatted = formatted.replace(/\n/g, '<br>');

          return formatted;
        },

        // Navigate to verse by reference string (e.g., "ISA:59:9" or "MAT:15:23")
        goToVerseByRef(ref) {
          // Parse format: BOOK:chapter:verse or BOOK:chapter
          const parts = ref.split(':');
          if (parts.length < 2) return;

          const rawBookCode = parts[0];
          const chapter = parseInt(parts[1]);
          const verseNum = parts.length > 2 ? parseInt(parts[2]) : 1;

          // Normalize book code to canonical form
          const bookCode = normalizeBookCode(rawBookCode);
          if (!this.books.includes(bookCode)) {
            console.warn(`Book not found: ${rawBookCode} -> ${bookCode}`);
            return;
          }

          // Close modal and navigate
          this.snModal.show = false;
          this.selectedBook = bookCode;
          this.updateChapters();

          if (this.chapters.includes(chapter)) {
            this.selectedChapter = chapter;
          } else {
            this.selectedChapter = this.chapters[0] || 1;
          }

          this.loadVerses();
          this.saveReadingPosition();

          // Scroll to and highlight the verse after DOM updates
          this.$nextTick(() => {
            this.scrollToAndHighlightVerse(verseNum);
          });
        },

        // Scroll to a specific verse and highlight it
        scrollToAndHighlightVerse(verseNum) {
          // Small delay to ensure animations are complete
          setTimeout(() => {
            const verseElement = document.querySelector(`[data-verse-num="${verseNum}"]`);
            if (verseElement) {
              // Scroll the verse into view with some offset for the header
              const headerHeight = 80;
              const elementTop = verseElement.getBoundingClientRect().top + window.scrollY;
              window.scrollTo({
                top: elementTop - headerHeight - 20,
                behavior: 'smooth'
              });

              // Remove class first if present, force reflow, then add back to restart animation
              verseElement.classList.remove('verse-highlight');
              void verseElement.offsetWidth;
              verseElement.classList.add('verse-highlight');
              // Don't remove the class - it will stay at final animation state (no visual effect)
              // Removing it would cause the verse-item opacity:0 to kick in again
            }
          }, 100);
        }
      };
    }
  </script>
</body>

</html>